<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ACE FLOW - Inteligência e Eficiência para Agentes de Endemias</title>
    
    <!-- PWA (Progressive Web App) Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ACE FLOW">
    <link rel="apple-touch-icon" href="https://i.imgur.com/ArDb28v.png">
    <meta name="theme-color" content="#4a403a">

    <!-- Dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PDF.js for reading PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Estilos -->
    <style>
        :root {
            --bg-main: #fdfaf6; /* Beige bem claro */
            --bg-card: #FFFFFF; 
            --text-dark: #4a403a; /* Marrom escuro */
            --text-muted: #817253; /* Cáqui médio */
            --border-color: #e0e0e0; 
            --alert-red: #d90429;
            --confirm-green: #008000;
            --khaki-base: #c3b091; /* Cáqui principal */
            --khaki-dark: #817253; /* Cáqui escuro */
            --khaki-light: #f5f0e6; /* Cáqui bem claro / Bege */
            --coordinator-bg: #f8fafc; 
            --coordinator-header: #1e293b;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; background-color: var(--bg-main); color: var(--text-dark); }
        .card { background-color: var(--bg-card); border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px solid var(--border-color); transition: border-color 0.3s ease; }
        .section-title { font-weight: 700; font-size: 1.25rem; color: var(--text-dark); }
        .form-input, .form-select {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid var(--border-color);
            background-color: var(--bg-card); transition: all 0.2s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--khaki-base); box-shadow: 0 0 0 3px rgba(195, 176, 145, 0.4);
        }
        .form-input.is-filled, .form-select.is-filled { border-color: var(--confirm-green); }
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px white inset !important;
            box-shadow: 0 0 0 30px white inset !important;
        }
        .btn {
            padding: 0.8rem 1.5rem; border-radius: 0.5rem; font-weight: 700; transition: all 0.3s ease-in-out;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 6px 12px rgba(0,0,0,0.12); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .hidden-content { display: none; overflow: hidden; transition: max-height 0.5s ease-in-out; max-height: 0; }
        .hidden-content.show { display: block; max-height: 1500px; }
        .toggle-check {
            width: 100%; height: 46px; font-weight: 700; font-size: 1.1rem; cursor: pointer;
            border: 2px solid var(--border-color); border-radius: 0.5rem; background-color: var(--bg-card);
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .toggle-check.tratado.is-checked { background-color: #e8f5e9; color: var(--confirm-green); border-color: var(--confirm-green); }
        .toggle-check.foco.is-checked { background-color: #ffebee; color: var(--alert-red); border-color: var(--alert-red); }
        #fixed-info-bar {
            position: sticky; top: 0; z-index: 40; transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .modal { 
            background-color: rgba(0, 0, 0, 0.7); 
            display: flex; 
            align-items: flex-start; 
            justify-content: center;
            padding-top: 5vh;
            padding-bottom: 5vh;
            overflow-y: auto;
        }
        option.important-value { font-weight: 700; background-color: #eeeeee; }
        
        /* NEW Landing Page Styles */
        #landingPage {
            background-color: var(--bg-main);
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .hero-section {
            color: var(--text-dark);
        }
        .glow-text {
            background: linear-gradient(90deg, var(--text-dark), var(--khaki-dark), var(--text-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 10s linear infinite;
            background-size: 200% auto;
        }
        @keyframes glow { to { background-position: -200% center; } }
        .feature-icon {
            border-radius: 1rem;
            padding: 1rem;
            display: inline-flex;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .feature-card-new:hover .feature-icon {
            transform: scale(1.1) rotate(-5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .feature-card-new {
            background-color: white;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.04);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .feature-card-new:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px -15px rgba(129, 114, 83, 0.2);
        }
        .fade-in-up {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.8s cubic-bezier(0.6, 0.01, 0.38, 0.99), transform 0.8s cubic-bezier(0.6, 0.01, 0.38, 0.99);
        }
        .fade-in-up.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .section-highlight {
            background-color: var(--khaki-light);
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--khaki-base);
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Coordinator Mode Styles */
        #coordinatorModeDashboard {
            background-color: var(--coordinator-bg);
            color: var(--coordinator-header);
        }
        .dashboard-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .ai-analysis-content h3 {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--khaki-dark);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--khaki-light);
            padding-bottom: 0.25rem;
        }
        .ai-analysis-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: var(--text-dark);
        }
        .ai-analysis-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .ai-analysis-content li {
            margin-bottom: 0.5rem;
        }

        /* FAQ Styles */
        .faq-question {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            transition: background-color 0.2s;
        }
        .faq-question:hover {
            background-color: var(--khaki-light);
        }
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0, 1, 0, 1), padding 0.5s ease;
            padding: 0 1rem;
        }
        .faq-answer.show {
            max-height: 500px; /* A large enough value */
            padding: 1.5rem 1rem;
            transition: max-height 1s cubic-bezier(1, 0, 1, 0), padding 0.5s ease;
        }
        .faq-toggle-icon {
            transition: transform 0.3s ease;
        }
        .faq-question.active .faq-toggle-icon {
            transform: rotate(45deg);
        }
        
        /* Card Status Styles */
        .card.card-completed {
            border-color: var(--confirm-green);
        }
        .card.card-in-progress {
            border-color: #f97316; /* Orange-500 */
        }

    </style>
</head>

<body class="antialiased">

    <!-- NEW Landing Page -->
    <div id="landingPage">
        <header class="hero-section text-center py-20 md:py-32 px-4">
            <div class="container mx-auto">
                <h1 class="text-5xl md:text-7xl font-black tracking-tight mb-4 glow-text">ACE FLOW</h1>
                <h2 class="max-w-4xl mx-auto text-2xl md:text-3xl font-semibold mb-6 text-text-dark">
                    Sua ferramenta otimizada e inteligente no combate ao vetor da Dengue, Zika e Chikungunya.
                </h2>
                <p class="max-w-3xl mx-auto text-lg md:text-xl text-text-muted">
                    A plataforma digital completa para os Agentes de Combate às Endemias e Coordenadores que buscam eficiência, precisão e inteligência para proteger a comunidade. Saia das folhas de papel e modernize seu trabalho, ganhe tempo e melhore seu desempenho.
                </p>
            </div>
        </header>

        <div>
            <!-- All Features Section -->
            <section class="py-20 md:py-28 px-4">
                <div class="container mx-auto text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-khaki-dark mb-4">Uma Plataforma, Todas as Soluções</h2>
                    <p class="text-xl text-text-muted mb-16 max-w-3xl mx-auto">Do trabalho de campo à gestão estratégica, o ACE Flow tem tudo que sua equipe precisa para ser mais eficiente.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Card 1 -->
                        <div class="feature-card-new fade-in-up">
                            <div class="feature-icon" style="background-color: #fef3c7;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ca8a04" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m12 6-2 4h4l-2 4"/><path d="m12 14 2 4h-4l2-4"/></svg></div>
                            <h3 class="text-xl font-bold mb-2">Preenchimento Inteligente</h3>
                            <p class="text-text-muted">Nossa tecnologia antecipa seus próximos passos, replicando informações e garantindo registros rápidos e consistentes.</p>
                        </div>
                        <!-- Card 2 -->
                        <div class="feature-card-new fade-in-up" style="transition-delay: 0.1s;">
                            <div class="feature-icon" style="background-color: #dcfce7;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></div>
                            <h3 class="text-xl font-bold mb-2">Salvamento Automático</h3>
                            <p class="text-text-muted">Seu progresso é salvo no histórico ao finalizar cada imóvel, garantindo que nenhum dado seja perdido.</p>
                        </div>
                        <!-- Card 3 -->
                        <div class="feature-card-new fade-in-up" style="transition-delay: 0.2s;">
                            <div class="feature-icon" style="background-color: #e0e7ff;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#4338ca" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg></div>
                            <h3 class="text-xl font-bold mb-2">Experiência de App Real</h3>
                            <p class="text-text-muted">Instale no seu celular para uma experiência em tela cheia, 100% offline e sem perda de dados.</p>
                        </div>
                        <!-- Card 4 -->
                        <div class="feature-card-new fade-in-up" style="transition-delay: 0.3s;">
                             <div class="feature-icon" style="background-color: #fee2e2;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg></div>
                            <h3 class="text-xl font-bold mb-2">Relatórios e PDFs</h3>
                            <p class="text-text-muted">Gere relatórios dinâmicos e exporte PDFs profissionais para arquivamento e prestação de contas com um clique.</p>
                        </div>
                        <!-- Card 5 -->
                        <div class="feature-card-new fade-in-up" style="transition-delay: 0.4s;">
                            <div class="feature-icon" style="background-color: #ffedd5;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></svg></div>
                            <h3 class="text-xl font-bold mb-2">Gestão da Área</h3>
                            <p class="text-text-muted">Mapeie e gerencie sua área de trabalho com total flexibilidade. Cadastre, edite e remova imóveis manualmente.</p>
                        </div>
                        <!-- Card 6 -->
                        <div class="feature-card-new fade-in-up" style="transition-delay: 0.5s;">
                            <div class="feature-icon" style="background-color: #d1fae5;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div>
                            <h3 class="text-xl font-bold mb-2">Guia de Conhecimento</h3>
                            <p class="text-text-muted">Acesse um guia completo com dúvidas básicas e curiosidade interessantes sobre endemias, vetores e vigilância para agir com mais segurança e precisão em campo.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Coordinator Features Section -->
            <section class="py-20 md:py-28 px-4 section-highlight">
                <div class="container mx-auto text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-khaki-dark mb-4">Modo Chefe</h2>
                    <p class="text-xl text-text-muted mb-16 max-w-3xl mx-auto">Eleve a gestão da sua equipe a um novo patamar com o poder da Inteligência Artificial.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="feature-card-new fade-in-up">
                            <div class="feature-icon" style="background-color: #e2e8f0;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg></div>
                            <h3 class="text-xl font-bold mb-2">Dashboard Centralizado</h3>
                            <p class="text-text-muted">Faça o upload dos PDFs da sua equipe e tenha uma visão consolidada de todo o trabalho em um painel interativo. Acompanhe a produtividade, o uso de insumos e os resultados em tempo real.</p>
                        </div>
                        <div class="feature-card-new fade-in-up" style="transition-delay: 0.2s;">
                            <div class="feature-icon" style="background-color: #dbeafe;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1e40af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.2 1.2L3 12l5.8 1.9a2 2 0 0 1 1.2 1.2L12 21l1.9-5.8a2 2 0 0 1 1.2-1.2L21 12l-5.8-1.9a2 2 0 0 1-1.2-1.2Z"/></svg></div>
                            <h3 class="text-xl font-bold mb-2">Análise Estratégica com IA</h3>
                            <p class="text-text-muted">Nossa IA analisa os dados e gera relatórios com pontos fortes, desafios e recomendações claras. Identifique tendências, preveja problemas e tome decisões baseadas em evidências.</p>
                        </div>
                        <div class="feature-card-new fade-in-up md:col-span-2" style="transition-delay: 0.4s;">
                             <div class="feature-icon" style="background-color: #ffedd5;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></svg></div>
                            <h3 class="text-xl font-bold mb-2">Mapeamento de Hotspots</h3>
                            <p class="text-text-muted">Nossa IA processa os dados de campo e gera um mapa de calor visual, apontando com precisão cirúrgica os bairros e quarteirões com maior incidência de focos. Direcione suas equipes para onde elas são mais necessárias e realize ações de bloqueio e mutirões com máxima eficácia.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Final CTA -->
            <section class="py-20 md:py-28 px-4">
                <div class="container mx-auto text-center max-w-4xl">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-khaki-dark mb-6">Pronto para Elevar o Nível do Combate a Endemias?</h2>
                    <p class="text-xl text-text-muted mb-10">
                        Junte-se aos profissionais que estão usando a tecnologia para proteger mais vidas. O ACE Flow é mais que um aplicativo, é o seu parceiro estratégico em campo e na gestão.
                    </p>
                    <button id="finalStartButton" class="btn bg-blue-900 text-white hover:bg-blue-800 w-full md:w-auto text-xl py-4 px-10 shadow-lg">
                        Vamos lá? Clique aqui.
                    </button>
                </div>
            </section>
        </div>
    </div>
    
    <div id="fixed-info-bar" class="bg-white/80 backdrop-blur-sm p-2 text-center text-sm font-semibold hidden">
        <span id="fixed-agent-name"></span> - <span id="fixed-property-info"></span>
    </div>
    
    <div id="loginModal" class="fixed inset-0 z-50 modal hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 max-w-sm card">
            <h2 class="text-2xl font-bold text-center mb-1">Bem-vindo ao</h2>
            <h1 class="text-4xl font-extrabold text-center mb-6 text-khaki-dark">ACE FLOW</h1>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-text-muted mb-1">Usuário</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-text-muted mb-1">Senha</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="loginBtn" class="btn bg-blue-900 text-white hover:bg-blue-800 w-full text-lg transform hover:scale-105">Entrar</button>
                <p id="loginError" class="text-red-600 text-center mt-4 h-4"></p>
            </form>

            <div class="mt-8 pt-6 border-t border-dashed border-border-color text-center">
                <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2c93808497bc75650197bd37841c002b" target="_blank" class="btn bg-green-600 text-white hover:bg-green-700 w-full text-lg shadow-lg">
                    ADQUIRA JÁ
                </a>
                <p class="text-center text-sm text-text-muted mt-4 mb-4">
                    Acesse todas as funcionalidades do app, com Suporte via WhatsApp, por um preço simbólico de somente R$ 10,00.
                </p>
                <p class="text-xs text-text-muted mt-3 text-center flex items-center justify-center gap-1">
                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <span>Pagamento seguro via Mercado Pago. Teste por 7 dias, com seu dinheiro de volta se não gostar. Após a confirmação, entraremos em contato para liberar seu acesso.</span>
                </p>
            </div>

            <div id="support-section-login" class="mt-6 pt-4 border-t border-border-color"></div>
        </div>
    </div>

    <main id="appContent" class="container mx-auto p-3 md:p-6 max-w-4xl hidden bg-khaki-light">
        <header class="text-center mb-8 py-4">
            <h1 class="text-5xl font-extrabold text-khaki-dark"><strong>ACE FLOW</strong></h1>
            <p class="text-lg font-bold text-khaki-dark">Agentes de Combate às Endemias</p>
            <p class="text-md text-text-muted"><em>Registre aqui a excelência do seu trabalho.</em></p>
        </header>
        
        <section id="info-dia-section" class="card p-4 md:p-6 mb-6">
            <h2 class="section-title border-b border-border-color pb-3 mb-4">Informações do Dia</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="cidade" class="text-sm font-medium text-text-muted">Cidade</label>
                    <input type="text" id="cidade" list="cidade-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="estado" class="text-sm font-medium text-text-muted">Estado/UF</label>
                    <input type="text" id="estado" list="estado-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="agente" class="text-sm font-medium text-text-muted">Agente</label>
                    <input type="text" id="agente" list="agent-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="bairro" class="text-sm font-medium text-text-muted">Bairro Principal</label>
                    <input type="text" id="bairro" list="bairro-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="ciclo" class="text-sm font-medium text-text-muted">Ciclo</label>
                    <select id="ciclo" class="form-select mt-1" required></select>
                </div>
                <div>
                    <label for="data" class="text-sm font-medium text-text-muted">Data</label>
                    <input type="date" id="data" class="form-input mt-1">
                </div>
            </div>
        </section>

        <!-- Goal Module -->
        <section class="card p-4 md:p-6 mb-6">
            <details id="goalModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    Meta Diária de Imóveis
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="totalImoveis" class="text-sm font-medium text-text-muted">Total de Imóveis na Área</label>
                            <input type="number" id="totalImoveis" class="form-input mt-1" min="0" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        </div>
                        <div>
                            <label for="cicloInicio" class="text-sm font-medium text-text-muted">Início do Ciclo</label>
                            <input type="date" id="cicloInicio" class="form-input mt-1">
                        </div>
                        <div>
                            <label for="cicloFim" class="text-sm font-medium text-text-muted">Fim do Ciclo</label>
                            <input type="date" id="cicloFim" class="form-input mt-1">
                        </div>
                    </div>
                    <button id="calculateGoalBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white w-full">Calcular Meta</button>
                    <div id="goalResult" class="hidden text-center p-4 bg-khaki-light rounded-lg">
                        <p class="text-text-muted">Sua meta é de <strong id="dailyGoal" class="text-2xl text-khaki-dark">0</strong> imóveis por dia.</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-2 overflow-hidden border">
                            <div id="dailyProgress" class="bg-green-600 h-full rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <p id="progressText" class="text-sm font-semibold mt-1">0 / 0</p>
                    </div>
                </div>
            </details>
        </section>

        <section class="space-y-4">
            <h2 class="section-title text-center mt-8 mb-4">Registros de Visita</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div id="lastPropertyReminderContainer" class="hidden card p-3 bg-amber-50 border-amber-300 text-sm">
                     <p class="font-bold text-amber-900">Último Imóvel (Dia Anterior):</p>
                     <p id="lastPropertyReminder" class="font-mono text-amber-800"></p>
                </div>
                 <div id="nextPropertySuggestionContainer" class="hidden card p-3 bg-blue-50 border-blue-300 text-sm">
                     <p class="font-bold text-blue-900">Sugestão de Próximo Imóvel:</p>
                     <p id="nextPropertySuggestion" class="font-mono text-blue-800"></p>
                </div>
            </div>
            <div id="visitasContainer" class="space-y-3"></div>
            <button id="addVisitaBtn" class="btn bg-black text-white hover:bg-gray-800 w-full text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Adicionar Imóvel
            </button>
        </section>
        
        <section class="card p-4 md:p-6 my-8">
            <h2 class="section-title border-b border-border-color pb-3 mb-4">Resumo Geral</h2>
            <div id="summarySection" class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-5"></div>
        </section>

        <footer class="my-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <button id="savePdfBtn" class="btn bg-green-800 hover:bg-green-900 text-white">Gerar PDF</button>
                <button id="reportBtn" class="btn bg-purple-900 text-white hover:bg-purple-800">Pesquisar Dados</button>
                <button id="myAreaBtn" class="btn text-white hover:bg-opacity-90" style="background-color: var(--text-dark);">Minha Área</button>
                <button id="clearDayBtn" class="btn bg-red-700 hover:bg-red-800 text-white">Limpar Dia</button>
            </div>
            <div class="grid grid-cols-1 gap-4 mt-4">
                 <button id="curiositiesBtn" class="btn bg-gray-600 text-white hover:bg-gray-700 text-lg w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    Dúvidas e Curiosidades
                </button>
            </div>
            <div id="subButtonsContainer" class="hidden mt-4 space-y-3">
                <p class="text-center text-text-muted max-w-2xl mx-auto">Agente, o conhecimento é a sua principal ferramenta de trabalho. Dominar informações sobre endemias, vigilância, saneamento e saúde pública é vital para agir com segurança, precisão e impacto. Quanto mais você entende sua área de atuação, mais eficaz será sua prevenção e mais vidas poderá proteger. A ignorância, nesse campo, não é só uma falha — é um risco para toda a comunidade. Conhecer é salvar.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="showBasicKnowledgeBtn" class="btn bg-blue-500 text-white hover:bg-blue-600 flex-1">Conhecimento Básico do ACE</button>
                    <button id="showDengueModalBtn" class="btn bg-orange-500 text-white hover:bg-orange-600 flex-1">Aprenda mais sobre as Arboviroses</button>
                    <button id="showAedesModalBtn" class="btn bg-gray-700 text-white hover:bg-gray-800 flex-1">Aprenda mais sobre o Aedes Aegypti</button>
                </div>
            </div>
        </footer>
        
        <!-- Volume Calculator Module -->
        <section class="card p-4 md:p-6 mb-6">
            <details id="volumeModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    Calcule aqui o volume do reservatório
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div class="flex items-end gap-2">
                            <div class="flex-grow"><label for="largura" class="text-sm font-medium text-text-muted">Largura</label><input type="number" id="largura" class="form-input mt-1" min="0" step="any"></div>
                            <select id="larguraUnidade" class="form-select w-20 h-[46px]"><option value="m">m</option><option value="cm">cm</option></select>
                        </div>
                        <div class="flex items-end gap-2">
                            <div class="flex-grow"><label for="comprimento" class="text-sm font-medium text-text-muted">Comprimento</label><input type="number" id="comprimento" class="form-input mt-1" min="0" step="any"></div>
                            <select id="comprimentoUnidade" class="form-select w-20 h-[46px]"><option value="m">m</option><option value="cm">cm</option></select>
                        </div>
                        <div class="flex items-end gap-2">
                            <div class="flex-grow"><label for="altura" class="text-sm font-medium text-text-muted">Altura (água)</label><input type="number" id="altura" class="form-input mt-1" min="0" step="any"></div>
                            <select id="alturaUnidade" class="form-select w-20 h-[46px]"><option value="m">m</option><option value="cm">cm</option></select>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button id="calculateVolumeBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white flex-1">Calcular</button>
                        <button id="clearVolumeBtn" class="btn bg-gray-400 text-white hover:bg-gray-500 flex-1">Limpar</button>
                    </div>
                    <div id="volumeResult" class="hidden p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-6">
                        <div class="w-24 h-32 bg-gray-200 border-2 border-gray-400 rounded-t-lg relative overflow-hidden flex-shrink-0">
                            <div id="waterLevel" class="absolute bottom-0 left-0 w-full bg-blue-400 transition-all duration-500"></div>
                        </div>
                        <div class="text-center md:text-left">
                            <p class="text-text-muted">Volume Total: <strong id="volumeText" class="text-2xl text-blue-800">0 L</strong></p>
                            <p class="text-text-muted mt-2">Larvicida necessário:</p>
                            <p><strong id="spoonAmountText" class="text-xl text-blue-800">0</strong> (colher dosadora)</p>
                            <p>Equivalente a <strong id="gramsAmountText" class="text-xl text-blue-800">0</strong> gramas</p>
                        </div>
                    </div>
                </div>
            </details>
        </section>

        <section class="card p-4 md:p-6 mb-6">
            <details id="backupModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    Backup & Restauração
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4 flex flex-col md:flex-row gap-4">
                    <button id="backupBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white flex-1">Faça Backup (para não perder seu histórico)</button>
                    <label for="restoreInput" class="btn bg-green-700 hover:bg-green-800 text-white flex-1">
                        Restaurar Backup
                    </label>
                    <input type="file" id="restoreInput" class="hidden" accept=".json">
                </div>
            </details>
        </section>

        <!-- NEW: Coordinator Mode Section -->
        <section id="coordinatorModeSection" class="card p-6 md:p-8 my-8 section-highlight text-center">
            <h2 class="text-3xl font-extrabold mb-4 text-khaki-dark">Modo Chefe</h2>
            <p class="max-w-2xl mx-auto mb-6 text-text-dark">
                Acesse o painel de análise inteligente para obter um panorama completo do trabalho da sua equipe. Faça o upload dos relatórios em PDF e receba insights, gráficos e diretrizes estratégicas geradas por IA.
            </p>
            <p class="text-sm text-text-muted mb-6">(Esta funcionalidade requer conexão com a internet para análise dos dados)</p>
            <button id="goToCoordinatorModeBtn" class="btn bg-blue-900 text-white hover:bg-blue-800 text-lg font-bold py-3 px-8">
                Acessar Análise Inteligente
            </button>
        </section>
        
        <section id="feedback-section" class="card p-4 md:p-6 mb-6">
            <h2 class="section-title border-b border-border-color pb-3 mb-4" style="color: black;">Sua Opinião é Importante!</h2>
            <p class="mb-4" style="color: black;">
                O ACE FLOW está em constante evolução e sua opinião é fundamental. Tem alguma ideia para uma nova funcionalidade? Uma sugestão para melhorar o que já existe? Compartilhe conosco!
            </p>
            <p class="text-center" style="color: black;">
                Para enviar sua sugestão, entre em contato através do nosso <strong style="color: black;">WhatsApp</strong> ou <strong style="color: black;">E-mail</strong> na seção de suporte abaixo.
            </p>
        </section>

        <div id="support-section-main" class="my-8"></div>

        <div class="text-center mt-8">
            <button id="backToHomeBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white">Voltar ao Início</button>
        </div>

        <footer class="text-center mt-12 py-8 border-t-2 border-dashed border-border-color">
            <h2 class="text-4xl font-extrabold text-khaki-base">ACE FLOW</h2>
            <p class="text-text-muted mt-2">Obrigado por utilizar nossa ferramenta. Seu trabalho é fundamental para a saúde de todos.</p>
        </footer>
    </main>

    <!-- NEW: Coordinator Mode Dashboard -->
    <div id="coordinatorModeDashboard" class="hidden min-h-screen p-4 md:p-8 bg-coordinator-bg">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b-2 border-gray-300">
            <div>
                <h1 class="text-4xl font-extrabold text-coordinator-header">Painel do Coordenador</h1>
                <p class="text-lg text-gray-600">Análise Inteligente de Dados da Equipe</p>
            </div>
            <button id="backToAgentModeBtn" class="btn bg-gray-500 text-white hover:bg-gray-600 mt-4 md:mt-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 5l-7 7 7 7"/></svg>
                Voltar para Modo Agente
            </button>
        </header>

        <div id="coordinatorContent">
            <!-- Upload Section -->
            <section id="uploadSection" class="dashboard-card p-6 text-center mb-8">
                <h2 class="text-2xl font-bold mb-4">1. Comece por aqui</h2>
                <p class="text-gray-600 mb-4">Faça o upload dos relatórios diários em PDF exportados pelos agentes da sua equipe.</p>
                <label for="pdfUpload" class="btn bg-green-600 text-white hover:bg-green-700 w-full md:w-auto text-lg cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Carregar Arquivos PDF
                </label>
                <input type="file" id="pdfUpload" class="hidden" multiple accept=".pdf">
                <div id="uploadStatus" class="mt-4 text-sm text-gray-500"></div>
            </section>

            <!-- Analysis Section -->
            <div id="analysisDashboard" class="hidden">
                <div id="analysisLoader" class="text-center p-8 hidden">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 font-semibold text-lg text-gray-700">Analisando dados com IA... Por favor, aguarde.</p>
                </div>

                <div id="analysisResults" class="hidden space-y-8">
                    <!-- Summary Cards -->
                    <section>
                        <h2 class="text-2xl font-bold mb-4 text-coordinator-header">Panorama Geral</h2>
                        <div id="summaryCardsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <!-- Cards will be injected here -->
                        </div>
                    </section>
                    
                    <!-- AI Strategic Analysis -->
                    <section class="dashboard-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-coordinator-header">Análise Estratégica (IA)</h2>
                        <div id="aiStrategicAnalysis" class="ai-analysis-content text-gray-700 leading-relaxed"></div>
                    </section>

                    <!-- Charts -->
                    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="dashboard-card p-6"><canvas id="performanceChart"></canvas></div>
                        <div class="dashboard-card p-6"><canvas id="fociDistributionChart"></canvas></div>
                    </section>

                    <!-- Hotspot Analysis -->
                    <section class="dashboard-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-coordinator-header">Análise de Pontos Críticos (Focos)</h2>
                        <div id="hotspotAnalysis" class="ai-analysis-content text-gray-700 leading-relaxed"></div>
                    </section>
                    
                    <!-- Educational Content -->
                    <section class="dashboard-card p-6">
                        <h2 class="text-2xl font-bold mb-4 text-coordinator-header">Base de Conhecimento (IA)</h2>
                        <div id="aiEducationalContent" class="ai-analysis-content text-gray-700 leading-relaxed"></div>
                    </section>
                </div>
            </div>
        </div>
    </div>
    
    <datalist id="agent-suggestions"></datalist>
    <datalist id="bairro-suggestions"></datalist>
    <datalist id="street-suggestions"></datalist>
    <datalist id="cidade-suggestions"></datalist>
    <datalist id="estado-suggestions"></datalist>

    <div id="confirmationModal" class="fixed inset-0 z-50 modal hidden">
        <div class="card p-6 w-11/12 max-w-sm text-center">
            <p id="modalMessage" class="text-lg mb-6">Tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="modalCancelBtn" class="btn bg-gray-300 hover:bg-gray-400 text-black">Cancelar</button>
                <button id="modalConfirmBtn" class="btn bg-red-600 hover:bg-red-700 text-white">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="reportModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-4 md:p-6 w-11/12 max-w-6xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="section-title">Pesquisar Dados</h2>
                <button id="closeReportModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div id="reportModalBody" class="flex-grow overflow-y-auto pr-2">
                <div class="flex flex-col md:flex-row gap-4 mb-4 pb-4 border-b">
                    <div class="flex-1">
                        <label for="reportStartDate" class="font-semibold text-sm">De:</label>
                        <input type="date" id="reportStartDate" class="form-input mt-1">
                    </div>
                    <div class="flex-1">
                        <label for="reportEndDate" class="font-semibold text-sm">Até:</label>
                        <input type="date" id="reportEndDate" class="form-input mt-1">
                    </div>
                    <div class="flex items-end">
                        <button id="searchReportBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white w-full md:w-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            Pesquisar
                        </button>
                    </div>
                </div>
                <div id="reportContent" class="space-y-6">
                     <div id="no-report-data" class="text-center my-8 text-text-muted">
                        <p class="font-bold text-lg">Selecione um período para gerar o relatório.</p>
                    </div>
                    <div id="reportDataContainer" class="hidden space-y-6">
                    </div>
                </div>
            </div>
            <footer id="reportFooter" class="mt-6 pt-4 border-t flex justify-end gap-3 hidden">
                <button id="downloadReportPdfBtn" class="btn bg-red-700 hover:bg-red-800 text-white">Baixar PDF</button>
            </footer>
        </div>
    </div>
    
    <div id="sectorModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-0 w-11/12 max-w-5xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b p-4">
                <button id="sectorBackBtn" class="sector-back-btn hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                </button>
                <h2 id="sectorModalTitle" class="section-title flex-grow text-center">Minha Área de Atuação</h2>
                <button id="closeSectorModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div id="sectorModalContent" class="flex-grow overflow-y-auto relative p-4">
            </div>
            <footer id="sectorModalFooter" class="p-4 border-t">
            </footer>
        </div>
    </div>

    <div id="faqModal" class="fixed inset-0 z-50 modal hidden"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VARIÁVEIS GLOBAIS ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_M9m5XNbdgaMGXF69esRYPT-xBu5yVz4b6TqUrvy85Ipx_hVh4fQUqISwtFhoMkEW/exec'; 
        const { jsPDF } = window.jspdf;
        const Chart = window.Chart;
        const INITIAL_ROWS = 15;
        const CICLOS = ['1°', '2°', '3°', '4°', '5°', '6°', '7°', '8°', '9°', '10°'];
        const BRAZIL_HOLIDAYS_2025 = [
            '2025-01-01', '2025-03-03', '2025-03-04', '2025-04-18', '2025-04-21',
            '2025-05-01', '2025-06-19', '2025-09-07', '2025-10-12', '2025-11-02',
            '2025-11-15', '2025-11-20', '2025-12-25',
        ];
        
        let streetList = [], agentList = [], bairroList = [];
        let visitaCounter = 0;
        let confirmCallback = null;
        let dailyGoal = 0;
        let deferredInstallPrompt = null;
        let currentReportData = null; // Armazena dados do relatório atual para exportação
        let sectorNavigationStack = [];
        let performanceChartInstance = null;
        let fociDistributionChartInstance = null;

        // --- SELETORES DO DOM ---
        const landingPage = document.getElementById('landingPage');
        const finalStartButton = document.getElementById('finalStartButton');
        const mainContent = document.getElementById('appContent');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const agenteInput = document.getElementById('agente');
        const bairroInput = document.getElementById('bairro');
        const cidadeInput = document.getElementById('cidade');
        const estadoInput = document.getElementById('estado');
        const cicloSelect = document.getElementById('ciclo');
        const dataInput = document.getElementById('data');
        const visitasContainer = document.getElementById('visitasContainer');
        const summarySection = document.getElementById('summarySection');
        const agentSuggestions = document.getElementById('agent-suggestions');
        const bairroSuggestions = document.getElementById('bairro-suggestions');
        const streetSuggestions = document.getElementById('street-suggestions');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const reportModal = document.getElementById('reportModal');
        const closeReportModalBtn = document.getElementById('closeReportModalBtn');
        const reportStartDate = document.getElementById('reportStartDate');
        const reportEndDate = document.getElementById('reportEndDate');
        const searchReportBtn = document.getElementById('searchReportBtn');
        const reportContent = document.getElementById('reportContent');
        const noReportData = document.getElementById('no-report-data');
        const reportDataContainer = document.getElementById('reportDataContainer');
        const reportFooter = document.getElementById('reportFooter');
        const downloadReportPdfBtn = document.getElementById('downloadReportPdfBtn');
        const fixedInfoBar = document.getElementById('fixed-info-bar');
        const fixedAgentName = document.getElementById('fixed-agent-name');
        const fixedPropertyInfo = document.getElementById('fixed-property-info');
        const totalImoveisInput = document.getElementById('totalImoveis');
        const cicloInicioInput = document.getElementById('cicloInicio');
        const cicloFimInput = document.getElementById('cicloFim');
        const calculateGoalBtn = document.getElementById('calculateGoalBtn');
        const goalResultDiv = document.getElementById('goalResult');
        const dailyGoalEl = document.getElementById('dailyGoal');
        const dailyProgressEl = document.getElementById('dailyProgress');
        const progressTextEl = document.getElementById('progressText');
        const calculateVolumeBtn = document.getElementById('calculateVolumeBtn');
        const clearVolumeBtn = document.getElementById('clearVolumeBtn');
        const volumeResultDiv = document.getElementById('volumeResult');
        const volumeTextEl = document.getElementById('volumeText');
        const spoonAmountTextEl = document.getElementById('spoonAmountText');
        const gramsAmountTextEl = document.getElementById('gramsAmountText');
        const larguraInput = document.getElementById('largura');
        const comprimentoInput = document.getElementById('comprimento');
        const alturaInput = document.getElementById('altura');
        // Seletores da Minha Área
        const myAreaBtn = document.getElementById('myAreaBtn');
        const sectorModal = document.getElementById('sectorModal');
        const sectorModalContent = document.getElementById('sectorModalContent');
        const sectorModalTitle = document.getElementById('sectorModalTitle');
        const sectorBackBtn = document.getElementById('sectorBackBtn');
        const closeSectorModalBtn = document.getElementById('closeSectorModalBtn');
        const sectorModalFooter = document.getElementById('sectorModalFooter');
        // Seletores de Backup/Restauração
        const backupBtn = document.getElementById('backupBtn');
        const restoreInput = document.getElementById('restoreInput');
        // Seletores de Curiosidades
        const curiositiesBtn = document.getElementById('curiositiesBtn');
        const subButtonsContainer = document.getElementById('subButtonsContainer');
        const showBasicKnowledgeBtn = document.getElementById('showBasicKnowledgeBtn');
        const showDengueModalBtn = document.getElementById('showDengueModalBtn');
        const showAedesModalBtn = document.getElementById('showAedesModalBtn');
        const faqModal = document.getElementById('faqModal');
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const lastPropertyReminderContainer = document.getElementById('lastPropertyReminderContainer');
        const lastPropertyReminder = document.getElementById('lastPropertyReminder');
        const nextPropertySuggestionContainer = document.getElementById('nextPropertySuggestionContainer');
        const nextPropertySuggestion = document.getElementById('nextPropertySuggestion');
        const infoDiaSection = document.getElementById('info-dia-section');
        // Coordinator Mode Selectors
        const coordinatorModeDashboard = document.getElementById('coordinatorModeDashboard');
        const goToCoordinatorModeBtn = document.getElementById('goToCoordinatorModeBtn');
        const backToAgentModeBtn = document.getElementById('backToAgentModeBtn');
        const pdfUploadInput = document.getElementById('pdfUpload');
        const uploadStatus = document.getElementById('uploadStatus');
        const analysisDashboard = document.getElementById('analysisDashboard');
        const analysisLoader = document.getElementById('analysisLoader');
        const analysisResults = document.getElementById('analysisResults');
        const summaryCardsContainer = document.getElementById('summaryCardsContainer');
        const aiStrategicAnalysis = document.getElementById('aiStrategicAnalysis');
        const hotspotAnalysis = document.getElementById('hotspotAnalysis');
        const aiEducationalContent = document.getElementById('aiEducationalContent');


        // --- LÓGICA DA LANDING PAGE E PWA ---
        const showApp = () => {
            landingPage.style.display = 'none';
            loginModal.classList.remove('hidden');
            loginModal.classList.add('flex');
        };
        
        if (finalStartButton) {
            finalStartButton.addEventListener('click', showApp);
        }

        // --- FUNÇÕES DE UTILIDADE ---
        const toTitleCase = (str) => {
            if (!str) return '';
            const lower = ['de', 'da', 'do', 'dos', 'das', 'e'];
            return str.replace(/\w\S*/g, (txt, offset) => {
                const word = txt.toLowerCase();
                if (offset > 0 && lower.includes(word)) {
                    return word;
                }
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        };

        const corrigirOrtografia = (str) => {
            if (!str) return '';
            const correcoes = {
                'sao': 'São', 'sebastiao': 'Sebastião', 'jose': 'José',
                'joao': 'João', 'conceicao': 'Conceição', 'vitoria': 'Vitória',
                'praca': 'Praça', 'acude': 'Açude', 'antonio': 'Antônio',
                'maria': 'Maria', 'francisco': 'Francisco', 'francisca': 'Francisca',
                'luiz': 'Luiz', 'gonzaga': 'Gonzaga', 'pereira': 'Pereira',
                'silva': 'Silva', 'souza': 'Souza', 'santos': 'Santos',
                'oliveira': 'Oliveira', 'tv': 'Tv', 'av': 'Av', 'r': 'Rua',
                'trav': 'Travessa', 'sen': 'Senador'
            };
            let correctedStr = str;
            Object.keys(correcoes).forEach(key => {
                const regex = new RegExp(`\\b${key}\\b`, 'gi');
                correctedStr = correctedStr.replace(regex, correcoes[key]);
            });
            return correctedStr;
        };
        
        const formatAndCorrectText = (str) => {
            return toTitleCase(corrigirOrtografia(str));
        }

        // --- TEMPLATES HTML ---
        const createVisitaCardHTML = (index) => `
            <div class="card visita-card" data-index="${index}">
                <header class="flex items-center justify-between p-3 cursor-pointer card-header group" data-toggle="card-content-${index}">
                    <div class="flex items-center min-w-0 flex-1">
                        <span class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-bg-card border-2 border-khaki-base text-khaki-base font-bold mr-3">${index + 1}</span>
                        <div class="min-w-0 flex-grow">
                            <span class="logradouro-preview font-semibold truncate block">Novo Imóvel</span>
                            <div class="status-indicator text-sm font-semibold text-alert-red">Falta Preencher</div>
                        </div>
                    </div>
                    <span class="toggle-icon text-3xl font-bold text-khaki-base transition-transform duration-300 group-data-[expanded=true]:rotate-45">+</span>
                </header>
                <div id="card-content-${index}" class="hidden-content">
                    <div class="p-4 border-t border-border-color space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-bold text-text-muted">Bairro</label>
                                <input type="text" list="bairro-suggestions" class="form-input bairro-imovel mt-1" placeholder="Bairro do Imóvel">
                            </div>
                           <div>
                                <label class="text-sm font-bold text-text-muted">Logradouro/Rua</label>
                                <input type="text" list="street-suggestions" class="form-input logradouro mt-1" placeholder="Ex: Rua João da Silva">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-x-3">
                            <div><label class="text-sm font-bold text-text-muted">Quarteirão</label><input type="number" min="1" oninput="this.value=this.value.replace(/[^0-9]/g,'');" class="form-input quarteirao mt-1 text-center"></div>
                            <div><label class="text-sm font-bold text-text-muted">Lado</label><select class="form-select lado mt-1" required><option value="" disabled selected></option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                            <div><label class="text-sm font-bold text-text-muted">Nº</label><input type="text" inputmode="numeric" class="form-input numero mt-1 text-center is-filled" value="S/N" onfocus="if(this.value === 'S/N') this.value=''" onblur="if(this.value.trim() === '') this.value='S/N'"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-3">
                            <div><label class="text-sm font-bold text-text-muted">Imóvel</label><select class="form-select imovel mt-1" required><option value="" disabled selected></option><option value="R">Residência</option><option value="C">Comércio</option><option value="TB">Terreno Baldio</option><option value="O">Outro</option></select></div>
                            <div><label class="text-sm font-bold text-text-muted">Visita</label><select class="form-select visita mt-1" required><option value="" disabled selected></option><option value="T">Trabalhado</option><option value="P">Recuperado</option><option value="F">Fechado</option><option value="R">Recusado</option></select></div>
                        </div>
                        <div class="border-t border-border-color pt-4 mt-4">
                            <p class="text-center text-sm font-bold text-text-muted mb-2">Resultados</p>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="text-center"><label class="text-xs font-medium">Elim.</label><input type="number" min="0" oninput="this.value=this.value.replace(/[^0-9]/g,'');" class="form-input elim mt-1 text-center" placeholder="0"></div>
                                <div class="text-center"><label class="text-xs font-medium">Trat.</label><button type="button" class="toggle-check tratado mt-1"></button></div>
                                <div class="text-center"><label class="text-xs font-medium">Larvicida</label><select class="form-select gram mt-1 text-center"></select></div>
                                <div class="text-center"><label class="text-xs font-medium">Dep.</label><input type="number" min="0" oninput="this.value=this.value.replace(/[^0-9]/g,'');" class="form-input dep mt-1 text-center" placeholder="0"></div>
                                <div class="text-center"><label class="text-xs font-medium">Foco</label><button type="button" class="toggle-check foco mt-1"></button></div>
                                <div class="text-center"><label class="text-xs font-medium">Horário</label><input type="time" class="form-input horario mt-1 text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // --- FUNÇÕES PRINCIPAIS ---
        const showModal = (message, cb) => {
            modalMessage.textContent = message;
            confirmCallback = cb;
            confirmationModal.classList.remove('hidden');
            confirmationModal.classList.add('flex');
        };

        const hideModal = () => {
            confirmationModal.classList.add('hidden');
            confirmationModal.classList.remove('flex');
            confirmCallback = null;
        };

        const updateToggleHTML = (button) => {
            const isChecked = button.classList.contains('is-checked');
            if (button.matches('.foco')) button.innerHTML = isChecked ? 'X' : '';
            else if (button.matches('.tratado')) button.innerHTML = isChecked ? '✅' : '';
        };

        const populateSelects = () => {
            cicloSelect.innerHTML = `<option value="" disabled selected></option>` + CICLOS.map(c => `<option value="${c}">${c}</option>`).join('');
        };
        
        const populateGramasSelect = (selectElement) => {
            const importantValues = ['0.8', '1.6', '3.2', '6.4', '7.2', '9.6', '12.8'];
            let gramasHTML = '<option value="0.0">0.0</option>';
            for (let i = 0.4; i <= 60.0; i = parseFloat((i + 0.4).toFixed(1))) {
                const val = i.toFixed(1);
                const isImportant = importantValues.includes(val);
                gramasHTML += `<option value="${val}" ${isImportant ? 'class="important-value"' : ''}>${val}</option>`;
            }
            selectElement.innerHTML = gramasHTML;
        };
        
        const addVisitaCard = () => {
            const cardHTML = createVisitaCardHTML(visitaCounter);
            visitasContainer.insertAdjacentHTML('beforeend', cardHTML);
            const newCard = visitasContainer.lastElementChild;
            populateGramasSelect(newCard.querySelector('.gram'));
            if (visitaCounter === 0) newCard.querySelector('.bairro-imovel').focus();
            
            const prevCard = visitaCounter > 0 ? visitasContainer.children[visitaCounter - 1] : null;
            const bairroHeader = bairroInput.value;
            
            newCard.querySelector('.bairro-imovel').value = prevCard ? prevCard.querySelector('.bairro-imovel').value : bairroHeader;
            newCard.querySelector('.logradouro').value = prevCard ? prevCard.querySelector('.logradouro').value : '';
            newCard.querySelector('.quarteirao').value = prevCard ? prevCard.querySelector('.quarteirao').value : '';
            newCard.querySelector('.lado').value = prevCard ? prevCard.querySelector('.lado').value : '';

            // Set fields as filled if they have a value from replication
            ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado', '.numero'].forEach(sel => {
                const input = newCard.querySelector(sel);
                if (input.value) {
                    input.classList.add('is-filled');
                }
            });

            updateCardStatus(newCard);
            visitaCounter++;
        };
        
        const updateCardStatus = (cardElement) => {
            const quarteirao = cardElement.querySelector('.quarteirao').value.trim();
            const logradouro = cardElement.querySelector('.logradouro').value.trim();
            const numero = cardElement.querySelector('.numero').value.trim() || 'S/N';
            const preview = cardElement.querySelector('.logradouro-preview');

            const quarteiraoPart = quarteirao ? `Quart. ${quarteirao}` : '';
            const logradouroPart = logradouro ? `${logradouro}, ${numero}` : '';
            const fullPreviewText = [quarteiraoPart, logradouroPart].filter(Boolean).join(' - ');
            
            preview.textContent = fullPreviewText || 'Novo Imóvel';

            const requiredSelectors = ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado', '.numero', '.imovel', '.visita'];
            const statusIndicator = cardElement.querySelector('.status-indicator');
            const horarioInput = cardElement.querySelector('.horario');
            
            let filledCount = 0;
            let hasManualInput = false;
            requiredSelectors.forEach(sel => {
                const input = cardElement.querySelector(sel);
                if (input.value.trim() !== '') {
                   filledCount++;
                }
                if (input.dataset.manualInput === 'true') {
                   hasManualInput = true;
                }
            });

            cardElement.classList.remove('card-completed', 'card-in-progress');
            statusIndicator.classList.remove('text-alert-red', 'text-orange-500', 'text-confirm-green');
            const isFullyFilled = filledCount >= requiredSelectors.length;
            
            if (isFullyFilled) {
                statusIndicator.textContent = '✅ Preenchido';
                statusIndicator.classList.add('text-confirm-green');
                cardElement.classList.add('card-completed');
                if (!horarioInput.value) {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    horarioInput.value = `${hours}:${minutes}`;
                    horarioInput.classList.add('is-filled');
                }
                // Automatically save to history and update sector data
                saveCurrentDayToHistory(false);
                displayNextPropertySuggestion();
            } else if (hasManualInput) {
                statusIndicator.textContent = 'Em Preenchimento...';
                statusIndicator.classList.add('text-orange-500'); 
                cardElement.classList.add('card-in-progress');
            } else {
                statusIndicator.textContent = 'Falta Preencher';
                statusIndicator.classList.add('text-alert-red');
            }
        };

        const getSummaryData = () => {
            const allCards = document.querySelectorAll('.visita-card');
            const filledCards = [...allCards].filter(card => ['.logradouro', '.quarteirao', '.lado', '.imovel', '.visita'].every(sel => card.querySelector(sel).value.trim() !== ''));
            
            let summary = { recuperado: 0, fechado: 0, recusado: 0, eliminados: 0, depositosTratados: 0, tratamentoFocal: 0, larvicidaGramas: 0, focos: 0 };
            let trabalhadosSummary = { total: 0, residencia: 0, comercio: 0, terrenoBaldio: 0, outro: 0 };
            const quarteiroesSet = new Set();

            filledCards.forEach(card => {
                const imovel = card.querySelector('.imovel').value;
                const visita = card.querySelector('.visita').value;
                const quarteiraoValue = card.querySelector('.quarteirao').value.trim();

                if (quarteiraoValue && !isNaN(parseInt(quarteiraoValue))) {
                    quarteiroesSet.add(parseInt(quarteiraoValue));
                }
                
                // ATUALIZAÇÃO: Imóveis recuperados (P) agora contam como trabalhados.
                if (visita === 'T' || visita === 'P') { 
                    trabalhadosSummary.total++;
                    if (imovel === 'R') trabalhadosSummary.residencia++;
                    else if (imovel === 'C') trabalhadosSummary.comercio++;
                    else if (imovel === 'TB') trabalhadosSummary.terrenoBaldio++;
                    else if (imovel === 'O') trabalhadosSummary.outro++;
                }
                
                // Mantém a contagem separada para o resumo de pendências
                if (visita === 'P') { summary.recuperado++; }
                else if (visita === 'F') { summary.fechado++; }
                else if (visita === 'R') { summary.recusado++; }

                summary.eliminados += parseInt(card.querySelector('.elim').value) || 0;
                summary.depositosTratados += parseInt(card.querySelector('.dep').value) || 0;
                if (card.querySelector('.tratado').classList.contains('is-checked')) summary.tratamentoFocal++;
                summary.larvicidaGramas += parseFloat(card.querySelector('.gram').value) || 0;
                if (card.querySelector('.foco').classList.contains('is-checked')) summary.focos++;
            });

            const quarteiroesTrabalhados = quarteiroesSet.size;
            let quarteiroesConcluidos = 0;
            if (quarteiroesSet.size > 1) {
                const maxQuarteirao = Math.max(...quarteiroesSet);
                quarteiroesConcluidos = [...quarteiroesSet].filter(q => q < maxQuarteirao).length;
            }
            
            return {
                trabalhados: trabalhadosSummary,
                geral: summary,
                quarteiroes: {
                    trabalhados: quarteiroesTrabalhados,
                    concluidos: quarteiroesConcluidos
                }
            };
        };

        const renderSummary = (summaryData) => {
            const { trabalhados, geral, quarteiroes } = summaryData;

            if(dailyGoal > 0){
                const progress = Math.min((trabalhados.total / dailyGoal) * 100, 100);
                dailyProgressEl.style.width = `${progress}%`;
                progressTextEl.textContent = `${trabalhados.total} / ${dailyGoal}`;
            }

            summarySection.innerHTML = `
                <div class="col-span-full text-center border-b border-border-color pb-3 mb-4">
                    <h3 class="font-semibold text-text-muted">Detalhes dos Imóveis Trabalhados</h3>
                </div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.residencia}</p><p class="text-sm text-text-muted">Residências</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.comercio}</p><p class="text-sm text-text-muted">Comércios</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.terrenoBaldio}</p><p class="text-sm text-text-muted">Ter. Baldios</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.outro}</p><p class="text-sm text-text-muted">Outros</p></div>
                <div class="p-3 text-center col-span-full font-bold text-lg bg-gray-100 rounded-lg summary-item"><p>${trabalhados.total}</p><p class="text-sm font-normal text-text-muted">Total Trabalhados</p></div>

                <div class="col-span-full text-center border-t border-border-color pt-4 mt-4 pb-3 mb-4">
                    <h3 class="font-semibold text-text-muted">Resumo Geral da Produção</h3>
                </div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.tratamentoFocal}</p><p class="text-sm text-text-muted">Trat. Focal</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.larvicidaGramas.toFixed(1)}g</p><p class="text-sm text-text-muted">Larvicida</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.depositosTratados}</p><p class="text-sm text-text-muted">Dep. Tratados</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.eliminados}</p><p class="text-sm text-text-muted">Eliminados</p></div>
                <div class="p-3 text-center col-span-full text-red-600 font-bold text-2xl">${geral.focos} <span class="text-sm text-red-600">Total de Focos</span></div>
                
                <div class="col-span-full flex justify-center flex-wrap gap-4">
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.recusado}</p><p class="text-sm text-text-muted">Recusados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.fechado}</p><p class="text-sm text-text-muted">Fechados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.recuperado}</p><p class="text-sm text-text-muted">Recuperados</p></div>
                </div>

                <div class="col-span-full flex justify-center gap-4">
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${quarteiroes.trabalhados}</p><p class="text-sm text-text-muted">Quarteirões Trabalhados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${quarteiroes.concluidos}</p><p class="text-sm text-text-muted">Quarteirões Concluídos</p></div>
                </div>
            `;
        };
        
        const updateAndRenderSummary = () => {
            const summaryData = getSummaryData();
            renderSummary(summaryData);
        };

        const calculateWorkingDays = (startDate, endDate) => {
            let count = 0;
            const curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getUTCDay();
                const dateString = curDate.toISOString().slice(0, 10);
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !BRAZIL_HOLIDAYS_2025.includes(dateString)) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        };

        const handleGoalCalculation = () => {
            const totalImoveis = parseInt(totalImoveisInput.value);
            const inicio = cicloInicioInput.value;
            const fim = cicloFimInput.value;
            if (totalImoveis > 0 && inicio && fim) {
                const workingDays = calculateWorkingDays(new Date(inicio + 'T00:00:00'), new Date(fim + 'T00:00:00'));
                if(workingDays > 0) {
                    dailyGoal = Math.ceil(totalImoveis / workingDays);
                    dailyGoalEl.textContent = dailyGoal;
                    goalResultDiv.classList.remove('hidden');
                    updateAndRenderSummary();
                    localStorage.setItem('aceFlowGoalData', JSON.stringify({ totalImoveis, inicio, fim, dailyGoal }));
                } else { alert("O período selecionado não contém dias úteis."); }
            } else { alert("Por favor, preencha todos os campos do setor."); }
        };

        const loadGoalData = () => {
            const goalData = JSON.parse(localStorage.getItem('aceFlowGoalData'));
            if (goalData) {
                totalImoveisInput.value = goalData.totalImoveis;
                cicloInicioInput.value = goalData.inicio;
                cicloFimInput.value = goalData.fim;
                dailyGoal = goalData.dailyGoal;
                dailyGoalEl.textContent = dailyGoal;
                goalResultDiv.classList.remove('hidden');
                document.getElementById('goalModule').open = true;
            }
        };

        const saveData = () => {
             const data = {
                  header: { 
                       agente: agenteInput.value, 
                       bairro: bairroInput.value, 
                       cidade: cidadeInput.value,
                       estado: estadoInput.value,
                       ciclo: cicloSelect.value, 
                       data: dataInput.value 
                  },
                  visits: []
             };
             document.querySelectorAll('.visita-card').forEach(card => {
                  data.visits.push({
                       bairro: card.querySelector('.bairro-imovel').value,
                       logradouro: card.querySelector('.logradouro').value, 
                       quarteirao: card.querySelector('.quarteirao').value,
                       lado: card.querySelector('.lado').value, 
                       numero: card.querySelector('.numero').value,
                       imovel: card.querySelector('.imovel').value, 
                       visita: card.querySelector('.visita').value,
                       elim: card.querySelector('.elim').value, 
                       trat: card.querySelector('.tratado').classList.contains('is-checked'),
                       gram: card.querySelector('.gram').value, 
                       dep: card.querySelector('.dep').value,
                       foco: card.querySelector('.foco').classList.contains('is-checked'),
                       horario: card.querySelector('.horario').value,
                       isExpanded: card.querySelector('.card-header').getAttribute('data-expanded') === 'true'
                  });
             });
             localStorage.setItem('aceFlowDailyData', JSON.stringify(data));
        };
        
        const loadData = () => {
            const data = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            visitasContainer.innerHTML = '';
            visitaCounter = 0;
            const rowsToCreate = (data && data.visits.length > INITIAL_ROWS) ? data.visits.length : INITIAL_ROWS;
            for(let i = 0; i < rowsToCreate; i++) addVisitaCard();
            if (!data) return;
            
            agenteInput.value = data.header.agente || agenteInput.value;
            bairroInput.value = data.header.bairro || '';
            cidadeInput.value = data.header.cidade || '';
            estadoInput.value = data.header.estado || '';
            cicloSelect.value = data.header.ciclo || '';
            
            // Correct date initialization
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dataInput.value = data.header.data || `${year}-${month}-${day}`;

            [agenteInput, bairroInput, cidadeInput, estadoInput, cicloSelect, dataInput].forEach(el => { if(el.value) el.classList.add('is-filled'); });
            data.visits.forEach((visitData, index) => {
                const card = visitasContainer.children[index];
                if (!card) return;
                Object.keys(visitData).forEach(key => {
                    const selector = key === 'bairro' ? '.bairro-imovel' : `.${key}`;
                    const el = card.querySelector(selector);
                    if (el) {
                        if (el.classList.contains('toggle-check')) { if(visitData[key]) el.classList.add('is-checked');}
                        else { el.value = visitData[key]; }
                    }
                });
                updateToggleHTML(card.querySelector('.foco'));
                updateToggleHTML(card.querySelector('.tratado'));
                if (visitData.isExpanded === "true") {
                    const header = card.querySelector('.card-header');
                    header.setAttribute('data-expanded', 'true');
                    header.nextElementSibling.classList.add('show');
                }
                updateCardStatus(card);
            });
            checkHeaderCompletion(); // Check status after loading data
        };
        
        const saveLastPropertyReminder = () => {
            const dailyData = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            if (!dailyData || !dailyData.visits) return;

            const filledCards = dailyData.visits.filter(v => v.logradouro && v.quarteirao);
            if (filledCards.length > 0) {
                const lastCard = filledCards[filledCards.length - 1];
                const imovelMap = { 'R': 'Residência', 'C': 'Comércio', 'TB': 'Ter. Baldio', 'O': 'Outro' };
                const reminderText = `${lastCard.bairro}, Q:${lastCard.quarteirao}, ${lastCard.logradouro}, Nº${lastCard.numero}, ${imovelMap[lastCard.imovel] || ''}`;
                localStorage.setItem('aceFlowLastProperty', reminderText);
            }
        };

        const displayLastPropertyReminder = () => {
            const reminderText = localStorage.getItem('aceFlowLastProperty');
            if (reminderText) {
                lastPropertyReminder.textContent = reminderText;
                lastPropertyReminderContainer.classList.remove('hidden');
            } else {
                lastPropertyReminderContainer.classList.add('hidden');
            }
        };

        const getAreaProperties = () => {
            const username = agenteInput.value;
            if (!username) return [];
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
            return Object.values(sectorData.properties).sort((a,b) => {
                const bairroComp = a.bairro.localeCompare(b.bairro);
                if (bairroComp !== 0) return bairroComp;
                const quarteiraoComp = parseInt(a.quarteirao) - parseInt(b.quarteirao);
                if (quarteiraoComp !== 0) return quarteiraoComp;
                const logradouroComp = a.logradouro.localeCompare(b.logradouro);
                if (logradouroComp !== 0) return logradouroComp;
                return parseInt(a.numero) - parseInt(b.numero);
            });
        };

        const checkCycleCompletion = () => {
            const history = JSON.parse(localStorage.getItem('aceFlowHistory')) || [];
            if (history.length < 2) return false;

            const propertyVisits = {};
            history.forEach(day => {
                day.visits.forEach(visit => {
                    if (visit.logradouro && visit.quarteirao) {
                        const propId = `${visit.bairro}-${visit.quarteirao}-${visit.logradouro}-${visit.numero}-${visit.tipo}-${visit.lado}`;
                        if (!propertyVisits[propId]) {
                            propertyVisits[propId] = new Set();
                        }
                        propertyVisits[propId].add(day.header.data);
                    }
                });
            });

            for (const propId in propertyVisits) {
                if (propertyVisits[propId].size > 1) {
                    return true; // Found at least one property visited on more than one day
                }
            }
            return false;
        };

        const displayNextPropertySuggestion = () => {
            if (!checkCycleCompletion()) {
                nextPropertySuggestionContainer.classList.add('hidden');
                return;
            }

            const allAreaProperties = getAreaProperties();
            if (allAreaProperties.length === 0) {
                nextPropertySuggestionContainer.classList.add('hidden');
                return;
            }

            const filledCards = [...document.querySelectorAll('.visita-card.card-completed')];
            if (filledCards.length === 0) {
                nextPropertySuggestionContainer.classList.add('hidden');
                return;
            }

            const lastCard = filledCards[filledCards.length - 1];
            const lastVisit = {
                bairro: lastCard.querySelector('.bairro-imovel').value,
                quarteirao: lastCard.querySelector('.quarteirao').value,
                logradouro: lastCard.querySelector('.logradouro').value,
                numero: lastCard.querySelector('.numero').value,
                tipo: lastCard.querySelector('.imovel').value,
                lado: lastCard.querySelector('.lado').value
            };

            const lastPropertyId = `${lastVisit.bairro}-${lastVisit.quarteirao}-${lastVisit.logradouro}-${lastVisit.numero}-${lastVisit.tipo}-${lastVisit.lado}`.toLowerCase().replace(/\s+/g, '-');
            
            const lastIndex = allAreaProperties.findIndex(p => {
                const pId = `${p.bairro}-${p.quarteirao}-${p.logradouro}-${p.numero}-${p.tipo}-${p.lado}`.toLowerCase().replace(/\s+/g, '-');
                return pId === lastPropertyId;
            });

            let nextIndex = (lastIndex !== -1) ? lastIndex + 1 : 0;
            if (nextIndex >= allAreaProperties.length) {
                nextIndex = 0; // Loop back to the start
            }

            const nextProp = allAreaProperties[nextIndex];
            const imovelMap = { 'R': 'Res.', 'C': 'Com.', 'TB': 'T.B.', 'O': 'Outro' };
            const suggestionText = `${nextProp.bairro}, Q:${nextProp.quarteirao}, ${nextProp.logradouro}, Nº${nextProp.numero}, ${imovelMap[nextProp.tipo] || ''}`;
            
            nextPropertySuggestion.textContent = suggestionText;
            nextPropertySuggestionContainer.classList.remove('hidden');
        };

        const saveCurrentDayToHistory = (showSuccessAlert = true) => {
            const dailyData = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            if (!dailyData || !dailyData.header.data) {
                if (showSuccessAlert) alert("Não há dados do dia para salvar.");
                return false;
            }
            
            const filledVisits = dailyData.visits.filter(v => v.logradouro && v.quarteirao && v.numero && v.lado && v.imovel && v.visita);
            if (filledVisits.length === 0) {
                if (showSuccessAlert) alert("Nenhum imóvel preenchido para salvar no histórico.");
                return false;
            }

            let history = JSON.parse(localStorage.getItem('aceFlowHistory')) || [];
            history = history.filter(entry => entry.header.data !== dailyData.header.data);
            history.push(dailyData);
            localStorage.setItem('aceFlowHistory', JSON.stringify(history));
            
            updateSectorData(dailyData);

            if (showSuccessAlert) alert('Dados do dia salvos no histórico com sucesso!');
            return true;
        };

        const generateDailyPDF = () => {
            saveLastPropertyReminder();
            if (!saveCurrentDayToHistory(true)) return; // Salva com alerta antes de gerar o PDF

            const doc = new jsPDF();
            const data = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            if (!data) return;

            const filledVisits = data.visits.filter(v => 
                v.logradouro && v.quarteirao && v.numero && v.lado && v.imovel && v.visita
            );

            if (filledVisits.length === 0) {
                return;
            }

            const { agente, bairro, ciclo, data: workDate, cidade, estado } = data.header;
            const dateFormatted = new Date(workDate + 'T12:00:00').toLocaleDateString('pt-BR');
            
            const primaryColor = '#111827';
            const headerFooterColor = '#9CA3AF';

            doc.setFont('helvetica', 'normal');
            doc.setFillColor(primaryColor);
            doc.rect(0, 0, 210, 25, 'F');
            doc.setFontSize(22);
            doc.setTextColor('#FFFFFF');
            doc.setFont('helvetica', 'bold');
            doc.text("ACE FLOW", 15, 17);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Relatório de Atividades Diárias", 105, 17, { align: 'center' });

            doc.autoTable({
                startY: 30,
                theme: 'plain',
                body: [
                    [{content: 'Agente:', styles: {fontStyle: 'bold', textColor: primaryColor}}, agente],
                    [{content: 'Data:', styles: {fontStyle: 'bold', textColor: primaryColor}}, dateFormatted],
                    [{content: 'Cidade/UF:', styles: {fontStyle: 'bold', textColor: primaryColor}}, `${cidade} / ${estado}`],
                    [{content: 'Bairro Principal:', styles: {fontStyle: 'bold', textColor: primaryColor}}, bairro],
                    [{content: 'Ciclo:', styles: {fontStyle: 'bold', textColor: primaryColor}}, ciclo]
                ],
                styles: { fontSize: 16 }
            });
            
            const summaryData = getSummaryData();
            const { trabalhados, geral, quarteiroes } = summaryData;
            
            const detalhesData = [
                ['Residências', trabalhados.residencia], ['Comércios', trabalhados.comercio],
                ['Ter. Baldios', trabalhados.terrenoBaldio], ['Outros', trabalhados.outro],
                [{content: 'Total Trabalhados', styles: {fontStyle: 'bold'}}, {content: trabalhados.total, styles: {fontStyle: 'bold'}}]
            ];
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 8,
                head: [['Detalhes dos Imóveis Trabalhados', 'Total']],
                body: detalhesData,
                headStyles: { fillColor: primaryColor, fontSize: 16 },
                styles: { fontSize: 16, cellPadding: 3 },
            });

            const producaoData = [
                ['Tratamento Focal', geral.tratamentoFocal],
                ['Quantidade de Larvicida', `${geral.larvicidaGramas.toFixed(1)}g`],
                ['Depósitos Tratados', geral.depositosTratados],
                ['Eliminados', geral.eliminados],
                ['Quarteirões Trabalhados', quarteiroes.trabalhados],
                ['Quarteirões Concluídos', quarteiroes.concluidos],
                ['Total de Focos', geral.focos],
                ['Recusados', geral.recusado],
                ['Fechados', geral.fechado],
                ['Recuperados', geral.recuperado]
            ];
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['Resumo Geral da Produção', 'Total']],
                body: producaoData,
                headStyles: { fillColor: primaryColor, fontSize: 16 },
                styles: { fontSize: 16, cellPadding: 3 },
                willDrawCell: function(data) {
                    if (data.section === 'body' && data.cell.text[0] === 'Total de Focos') {
                        data.cell.styles.textColor = '#e74c3c';
                        data.cell.styles.fontStyle = 'bold';
                        if (data.row.cells[1]) {
                            data.row.cells[1].styles.textColor = '#e74c3c';
                            data.row.cells[1].styles.fontStyle = 'bold';
                        }
                    }
                },
            });
            
            const visitaMap = { T: 'Trab.', P: 'Recuperado', F: 'Fechado', R: 'Recusado' };
            const visitData = filledVisits.map((v, i) => [
                i + 1, v.bairro, v.logradouro, v.quarteirao, v.numero, visitaMap[v.visita] || v.visita, v.horario || ''
            ]);
            doc.autoTable({
                head: [['#', 'Bairro', 'Logradouro', 'Quart.', 'Nº', 'Visita', 'Horário']], 
                body: visitData,
                startY: doc.lastAutoTable.finalY + 10,
                headStyles: { fillColor: '#6B7280', fontSize: 12 },
                styles: { fontSize: 10 },
            });
            
            doc.save(`ACE_FLOW_${agente.split(' ')[0]}_${workDate}.pdf`);
        };
        
        const updateAutocomplete = (type, value) => {
            let list, datalist;
            if (type === 'agent') { list = agentList; datalist = agentSuggestions; } 
            else if (type === 'bairro') { list = bairroList; datalist = bairroSuggestions; } 
            else { list = streetList; datalist = streetSuggestions; }
            const trimmedValue = value.trim();
            if (trimmedValue && !list.includes(trimmedValue)) {
                list.push(trimmedValue);
                datalist.innerHTML = list.map(item => `<option value="${item}"></option>`).join('');
                localStorage.setItem(`aceFlow${type}List`, JSON.stringify(list));
            }
        };
        
        const animateValue = (element, start, end, duration, isFloat = false) => {
            if (!element) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = progress * (end - start) + start;
                element.textContent = isFloat ? currentValue.toFixed(1) : Math.floor(currentValue);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                     element.textContent = isFloat ? end.toFixed(1) : end;
                }
            };
            window.requestAnimationFrame(step);
        };

        const renderReports = async () => {
            const startDate = reportStartDate.value;
            const endDate = reportEndDate.value;
            
            if (!startDate || !endDate) {
                alert("Por favor, selecione um período de início e fim.");
                return;
            }

            const history = JSON.parse(localStorage.getItem('aceFlowHistory')) || [];
            
            const filteredHistory = history.filter(entry => {
                const entryDate = entry.header.data;
                return entryDate >= startDate && entryDate <= endDate;
            });

            const allVisits = filteredHistory.flatMap(entry => 
                entry.visits.filter(v => v.logradouro && v.quarteirao && v.numero && v.lado && v.imovel && v.visita)
            );

            if (allVisits.length === 0) {
                noReportData.innerHTML = `<p class="font-bold text-lg">Nenhum dado encontrado para o período selecionado.</p>`;
                noReportData.classList.remove('hidden');
                reportDataContainer.classList.add('hidden');
                reportFooter.classList.add('hidden');
                return;
            }
            
            noReportData.classList.add('hidden');
            reportDataContainer.classList.remove('hidden');
            reportFooter.classList.remove('hidden');

            const summary = allVisits.reduce((acc, v) => {
                if (v.visita === 'T' || v.visita === 'P') {
                    acc.trabalhado++;
                    if (v.imovel === 'R') acc.residencia++;
                    else if (v.imovel === 'C') acc.comercio++;
                    else if (v.imovel === 'TB') acc.terrenoBaldio++;
                    else if (v.imovel === 'O') acc.outro++;
                }
                else if (v.visita === 'F') acc.fechado++;
                else if (v.visita === 'R') acc.recusado++;
                
                if (v.foco) {
                    acc.focos++;
                    acc.hotspots.push({
                        bairro: v.bairro,
                        quarteirao: v.quarteirao,
                        logradouro: v.logradouro,
                        numero: v.numero,
                        tipo: v.imovel
                    });
                }

                if (v.trat) acc.tratamentoFocal++;
                acc.gramas += parseFloat(v.gram) || 0;
                acc.depositosTratados += parseInt(v.dep) || 0;
                acc.eliminados += parseInt(v.elim) || 0;
                
                return acc;
            }, { 
                trabalhado: 0, fechado: 0, recusado: 0, focos: 0, gramas: 0, tratamentoFocal: 0, 
                depositosTratados: 0, eliminados: 0, residencia: 0, comercio: 0, terrenoBaldio: 0, outro: 0,
                hotspots: [] 
            });
            
            currentReportData = summary;

            reportDataContainer.innerHTML = `
                <div class="text-center p-8 bg-green-50 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-4 text-2xl font-bold text-gray-800">Relatório Pronto!</h3>
                    <p class="mt-2 text-text-muted">Seu compilado de dados para o período selecionado está pronto. Clique em "Baixar PDF" para salvar o documento.</p>
                </div>
            `;
        };
        
        const handleVolumeCalculation = () => {
            const getDimensionInMeters = (valueId, unitId) => {
                const value = parseFloat(document.getElementById(valueId).value);
                const unit = document.getElementById(unitId).value;
                if (isNaN(value) || value < 0) return NaN;
                return unit === 'cm' ? value / 100 : value;
            };
        
            const largura = getDimensionInMeters('largura', 'larguraUnidade');
            const comprimento = getDimensionInMeters('comprimento', 'comprimentoUnidade');
            const altura = getDimensionInMeters('altura', 'alturaUnidade');
        
            if (isNaN(largura) || isNaN(comprimento) || isNaN(altura)) {
                alert("Por favor, insira valores válidos e positivos para todas as dimensões.");
                return;
            }
            
            const volumeM3 = largura * comprimento * altura;
            const volumeLitros = volumeM3 * 1000;
            
            let gramas;
            if (volumeLitros <= 100) {
                gramas = volumeLitros * 0.008; 
            } else {
                gramas = volumeLitros * 0.0064;
            }
            
            const colheres = gramas / 0.8;
        
            let colheresText;
            if (colheres <= 0.5) {
                colheresText = "Meia colher";
            } else if (colheres <= 1) {
                colheresText = "1 colher";
            } else {
                colheresText = `${colheres.toLocaleString('pt-BR', {maximumFractionDigits: 1})} colheres`;
            }
        
            const waterLevelEl = document.getElementById('waterLevel');
            const volumeTextEl = document.getElementById('volumeText');
            const spoonAmountTextEl = document.getElementById('spoonAmountText');
            const gramsAmountTextEl = document.getElementById('gramsAmountText');
            
            volumeTextEl.textContent = `${volumeLitros.toLocaleString('pt-BR', {maximumFractionDigits: 1})} L`;
            spoonAmountTextEl.textContent = colheresText;
            gramsAmountTextEl.textContent = parseFloat(gramas.toFixed(1)).toLocaleString('pt-BR');
        
            const percentage = Math.min((volumeLitros / 2000) * 100, 100);
            waterLevelEl.style.height = `${percentage}%`;
        
            volumeResultDiv.classList.remove('hidden');
        };
        
        const clearVolumeCalculation = () => {
            larguraInput.value = '';
            comprimentoInput.value = '';
            alturaInput.value = '';
            document.getElementById('larguraUnidade').value = 'm';
            document.getElementById('comprimentoUnidade').value = 'm';
            document.getElementById('alturaUnidade').value = 'm';
            volumeResultDiv.classList.add('hidden');
        };

        const updateSectorData = (dailyData) => {
            const username = agenteInput.value;
            if (!username) return;

            const sectorKey = `aceFlowSectorData_${username}`;
            let sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };

            const completedVisits = dailyData.visits.filter(v => 
                v.bairro && v.quarteirao && v.logradouro && v.numero && v.imovel && v.visita && v.lado
            );

            for (const visit of completedVisits) {
                const propertyId = `${visit.bairro}-${visit.quarteirao}-${visit.logradouro}-${visit.numero}-${visit.imovel}-${visit.lado}`.toLowerCase().replace(/\s+/g, '-');
                
                if (!sectorData.properties[propertyId]) {
                     sectorData.properties[propertyId] = {
                        bairro: visit.bairro,
                        quarteirao: visit.quarteirao,
                        logradouro: visit.logradouro,
                        numero: visit.numero,
                        tipo: visit.imovel,
                        lado: visit.lado
                    };
                }
            }
            localStorage.setItem(sectorKey, JSON.stringify(sectorData));
        };

        const displayMyArea = () => {
            sectorNavigationStack = [];
            renderNeighborhoods();
            sectorModal.classList.remove('hidden');
            sectorModal.classList.add('flex');
        };

        const renderNeighborhoods = () => {
            const username = agenteInput.value;
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
            const properties = Object.values(sectorData.properties);

            const neighborhoods = [...new Set(properties.map(p => p.bairro))].sort((a, b) => a.localeCompare(b));
            
            let contentHTML = '<div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sector-view">';
            if (neighborhoods.length > 0) {
                neighborhoods.forEach(bairro => {
                    contentHTML += `<button class="btn bg-white hover:bg-gray-100 border-2 border-khaki-base text-khaki-base text-lg p-6 sector-neighborhood-btn" data-bairro="${bairro}">${bairro}</button>`;
                });
            } else {
                contentHTML += '<p class="col-span-full text-center text-text-muted">Nenhum bairro cadastrado ainda. Comece a registrar seus imóveis preenchidos.</p>';
            }
            contentHTML += '</div>';

            sectorModalTitle.textContent = "Minha Área: Bairros";
            sectorModalContent.innerHTML = contentHTML;
            sectorModalFooter.innerHTML = `<div class="flex gap-4"><button id="addPropertyManualBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white flex-1">Cadastrar Novo Imóvel</button><button id="exportAreaPdfBtn" class="btn bg-red-700 text-white flex-1">Exportar Área para PDF</button></div>`;
            sectorBackBtn.classList.add('hidden');

            document.getElementById('addPropertyManualBtn').addEventListener('click', showAddPropertyForm);
            document.getElementById('exportAreaPdfBtn').addEventListener('click', exportAreaToPdf);
        };
        
        const renderBlocksAndProperties = (bairro) => {
            sectorNavigationStack.push({ view: 'neighborhoods' });
            const username = agenteInput.value;
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
            const properties = Object.values(sectorData.properties).filter(p => p.bairro === bairro);

            const groupedByBlock = properties.reduce((acc, prop) => {
                (acc[prop.quarteirao] = acc[prop.quarteirao] || []).push(prop);
                return acc;
            }, {});

            let contentHTML = '<div class="p-4 space-y-6 sector-view">';
            const sortedBlocks = Object.keys(groupedByBlock).sort((a, b) => parseInt(a) - parseInt(b));

            if (sortedBlocks.length > 0) {
                sortedBlocks.forEach(block => {
                    contentHTML += `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-khaki-dark border-b-2 border-khaki-light pb-2 mb-3">Quarteirão: ${block}</h3>
                            <div class="overflow-x-auto bg-white rounded-lg shadow">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Logradouro</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nº</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lado</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                    `;
                    const imovelMap = { 'R': 'Residência', 'C': 'Comércio', 'TB': 'Ter. Baldio', 'O': 'Outro' };
                    groupedByBlock[block].sort((a,b) => a.logradouro.localeCompare(b.logradouro) || a.numero - b.numero).forEach(prop => {
                        const propertyId = `${prop.bairro}-${prop.quarteirao}-${prop.logradouro}-${prop.numero}-${prop.tipo}-${prop.lado}`.toLowerCase().replace(/\s+/g, '-');
                        contentHTML += `
                            <tr data-id="${propertyId}">
                                <td class="px-4 py-4 whitespace-nowrap">${prop.logradouro}</td>
                                <td class="px-4 py-4 whitespace-nowrap">${prop.numero}</td>
                                <td class="px-4 py-4 whitespace-nowrap">${prop.lado}</td>
                                <td class="px-4 py-4 whitespace-nowrap">${imovelMap[prop.tipo] || prop.tipo}</td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <button class="delete-property-btn text-red-600 hover:text-red-900 text-sm" data-id="${propertyId}">Excluir</button>
                                </td>
                            </tr>
                        `;
                    });
                    contentHTML += `</tbody></table></div></div>`;
                });
            } else {
                contentHTML += '<p class="text-center text-text-muted">Nenhum imóvel cadastrado para este bairro.</p>';
            }
            contentHTML += '</div>';

            sectorModalTitle.textContent = `Bairro: ${bairro}`;
            sectorModalContent.innerHTML = contentHTML;
            sectorBackBtn.classList.remove('hidden');
        };

        const showAddPropertyForm = () => {
            sectorNavigationStack.push({ view: 'neighborhoods' });
            sectorModalTitle.textContent = "Cadastrar Novo Imóvel";
            sectorModalContent.innerHTML = `
                <div class="p-4 space-y-4 sector-view">
                    <form id="add-property-form" class="space-y-4">
                        <div><label class="text-sm font-bold text-text-muted">Bairro</label><input type="text" id="new-prop-bairro" placeholder="Bairro" class="form-input mt-1" required></div>
                        <div><label class="text-sm font-bold text-text-muted">Quarteirão</label><input type="number" min="1" id="new-prop-quarteirao" placeholder="Quarteirão" class="form-input mt-1" oninput="this.value=this.value.replace(/[^0-9]/g,'');" required></div>
                        <div><label class="text-sm font-bold text-text-muted">Logradouro/Rua</label><input type="text" id="new-prop-logradouro" placeholder="Logradouro" class="form-input mt-1" required></div>
                        <div><label class="text-sm font-bold text-text-muted">Número</label><input type="number" min="0" id="new-prop-numero" placeholder="Número" class="form-input mt-1" oninput="this.value=this.value.replace(/[^0-9]/g,'');" required></div>
                        <div>
                            <label class="text-sm font-bold text-text-muted">Lado</label>
                            <select id="new-prop-lado" class="form-select mt-1" required>
                                <option value="" disabled selected>Selecione o lado</option>
                                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-text-muted">Tipo de Imóvel</label>
                            <select id="new-prop-tipo" class="form-select mt-1" required>
                                <option value="" disabled selected>Selecione o tipo</option>
                                <option value="R">Residência</option>
                                <option value="C">Comércio</option>
                                <option value="TB">Terreno Baldio</option>
                                <option value="O">Outro</option>
                            </select>
                        </div>
                        <button type="submit" class="btn bg-green-700 text-white w-full">Salvar Imóvel</button>
                    </form>
                </div>
            `;
            sectorModalFooter.innerHTML = ''; // Hide the "Cadastrar" button
            sectorBackBtn.classList.remove('hidden');

            document.getElementById('add-property-form').addEventListener('submit', handleAddPropertyFormSubmit);
        };

        const handleAddPropertyFormSubmit = (e) => {
            e.preventDefault();
            const username = agenteInput.value;
            const sectorKey = `aceFlowSectorData_${username}`;
            
            const newBairro = document.getElementById('new-prop-bairro').value.trim();
            const newQuarteirao = document.getElementById('new-prop-quarteirao').value.trim();
            const newLogradouro = document.getElementById('new-prop-logradouro').value.trim();
            const newNumero = document.getElementById('new-prop-numero').value.trim();
            const newLado = document.getElementById('new-prop-lado').value;
            const newTipo = document.getElementById('new-prop-tipo').value;

            if (!newBairro || !newQuarteirao || !newLogradouro || !newNumero || !newTipo || !newLado) {
                alert('Por favor, preencha todos os campos para adicionar o imóvel.');
                return;
            }

            const newProp = {
                bairro: formatAndCorrectText(newBairro),
                quarteirao: newQuarteirao,
                logradouro: formatAndCorrectText(newLogradouro),
                numero: newNumero,
                tipo: newTipo,
                lado: newLado
            };

            const propertyId = `${newProp.bairro}-${newProp.quarteirao}-${newProp.logradouro}-${newProp.numero}-${newProp.tipo}-${newProp.lado}`.toLowerCase().replace(/\s+/g, '-');
            
            let sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };

            if (sectorData.properties[propertyId]) {
                alert('Este imóvel já está cadastrado.');
                return;
            }

            sectorData.properties[propertyId] = newProp;
            localStorage.setItem(sectorKey, JSON.stringify(sectorData));
            
            alert('Imóvel cadastrado com sucesso!');
            handleSectorBack();
        };

        const handleSectorBack = () => {
            const lastView = sectorNavigationStack.pop();
            if (lastView) {
                if (lastView.view === 'neighborhoods') {
                    renderNeighborhoods();
                }
            } else {
                sectorModal.classList.add('hidden');
                sectorModal.classList.remove('flex');
            }
        };

        const exportAreaToPdf = () => {
            const username = agenteInput.value;
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
            const properties = Object.values(sectorData.properties);

            if (properties.length === 0) {
                alert("Não há imóveis cadastrados para exportar.");
                return;
            }

            const doc = new jsPDF();
            const agentName = agenteInput.value;
            const primaryColor = '#111827';
            const headerFooterColor = '#9CA3AF';

            doc.setFont('helvetica', 'normal');
            doc.setFillColor(primaryColor);
            doc.rect(0, 0, 210, 25, 'F');
            doc.setFontSize(22);
            doc.setTextColor('#FFFFFF');
            doc.setFont('helvetica', 'bold');
            doc.text("ACE FLOW", 15, 17);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Relatório de Área de Atuação", 105, 17, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setTextColor(primaryColor);
            doc.setFont('helvetica', 'bold');
            doc.text(`Agente: ${agentName}`, 15, 35);

            const groupedByBairro = properties.reduce((acc, prop) => {
                (acc[prop.bairro] = acc[prop.bairro] || []).push(prop);
                return acc;
            }, {});

            let lastY = 40;
            const imovelMap = { 'R': 'Residência', 'C': 'Comércio', 'TB': 'Terreno Baldio', 'O': 'Outro' };

            Object.keys(groupedByBairro).sort().forEach(bairro => {
                const bairroProperties = groupedByBairro[bairro];
                
                const groupedByQuarteirao = bairroProperties.reduce((acc, prop) => {
                    (acc[prop.quarteirao] = acc[prop.quarteirao] || []).push(prop);
                    return acc;
                }, {});

                if (lastY > 250) { // Check for page break before Bairro
                    doc.addPage();
                    lastY = 20;
                }

                doc.autoTable({
                    startY: lastY,
                    head: [[{ content: `Bairro: ${bairro}`, colSpan: 3, styles: { halign: 'center', fillColor: [220, 220, 220], textColor: [0,0,0], fontStyle: 'bold', fontSize: 18 } }]],
                    theme: 'grid'
                });
                lastY = doc.lastAutoTable.finalY;

                Object.keys(groupedByQuarteirao).sort((a, b) => parseInt(a) - parseInt(b)).forEach(quarteirao => {
                    const rows = groupedByQuarteirao[quarteirao].map(prop => [
                        prop.logradouro,
                        prop.numero,
                        imovelMap[prop.tipo] || prop.tipo
                    ]);

                     if (lastY > 250) { // Check for page break before Quarteirão
                         doc.addPage();
                         lastY = 20;
                     }

                    doc.autoTable({
                        startY: lastY,
                        head: [[{ content: `Quarteirão: ${quarteirao}`, colSpan: 3, styles: { halign: 'center', fillColor: [240, 240, 240], textColor: [0,0,0], fontStyle: 'bold', fontSize: 16 } }]],
                        theme: 'grid'
                    });
                    lastY = doc.lastAutoTable.finalY;
                    
                    doc.autoTable({
                        startY: lastY,
                        head: [['Logradouro', 'Número', 'Tipo']],
                        body: rows,
                        theme: 'striped',
                        styles: { fontSize: 16 },
                        headStyles: { fillColor: [100, 100, 100], fontSize: 16 }
                    });
                    lastY = doc.lastAutoTable.finalY;
                });
                lastY += 10;
            });

            doc.save(`Area_de_Trabalho_${agentName.replace(/\s/g, '_')}.pdf`);
        };

        // --- EVENT LISTENERS ---
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                loginError.textContent = "";
                if (!user || !pass) { loginError.textContent = "Por favor, preencha usuário e senha."; return; }
                loginBtn.disabled = true; loginBtn.textContent = "Verificando...";
                const authPayload = { action: 'authenticate', usuario: user, senha: pass };
                fetch(SCRIPT_URL, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                    body: JSON.stringify(authPayload)
                }).then(res => res.json()).then(result => {
                    if (result.status === 'success') {
                        localStorage.setItem('aceFlowUser', JSON.stringify({ username: user, isLoggedIn: true }));
                        loginModal.style.display = 'none';
                        mainContent.classList.remove('hidden');
                        fixedInfoBar.classList.remove('hidden');
                        agenteInput.value = user;
                        agenteInput.classList.add('is-filled');
                        fixedAgentName.textContent = user;
                        loadData(); 
                        updateAndRenderSummary();
                    } else { loginError.textContent = result.message || "Usuário ou senha inválidos."; }
                }).catch(error => {
                    console.error("Erro de autenticação:", error);
                    loginError.textContent = "Erro de conexão. Tente novamente.";
                }).finally(() => {
                    loginBtn.disabled = false; loginBtn.textContent = "Entrar";
                });
            });
        }
        
        if (calculateGoalBtn) calculateGoalBtn.addEventListener('click', handleGoalCalculation);
        if (calculateVolumeBtn) calculateVolumeBtn.addEventListener('click', handleVolumeCalculation);
        if (clearVolumeBtn) clearVolumeBtn.addEventListener('click', clearVolumeCalculation);
        if (document.getElementById('addVisitaBtn')) document.getElementById('addVisitaBtn').addEventListener('click', addVisitaCard);
        if (document.getElementById('savePdfBtn')) document.getElementById('savePdfBtn').addEventListener('click', generateDailyPDF);
        
        if (document.getElementById('clearDayBtn')) {
            document.getElementById('clearDayBtn').addEventListener('click', () => {
                showModal("Tem certeza que deseja limpar os dados do dia? Esta ação NÃO salva os dados no histórico. Use 'Gerar PDF' para salvar e finalizar o dia.", () => {
                    saveLastPropertyReminder();
                    localStorage.removeItem('aceFlowDailyData');
                    loadData();
                    updateAndRenderSummary();
                    displayLastPropertyReminder();
                    nextPropertySuggestionContainer.classList.add('hidden');
                });
            });
        }
        
        if (myAreaBtn) myAreaBtn.addEventListener('click', displayMyArea);
        if (sectorBackBtn) sectorBackBtn.addEventListener('click', handleSectorBack);
        if (closeSectorModalBtn) {
            closeSectorModalBtn.addEventListener('click', () => {
                sectorModal.classList.add('hidden');
                sectorModal.classList.remove('flex');
            });
        }

        if (sectorModalContent) {
            sectorModalContent.addEventListener('click', (e) => {
                const neighborhoodBtn = e.target.closest('.sector-neighborhood-btn');
                if (neighborhoodBtn) {
                    renderBlocksAndProperties(neighborhoodBtn.dataset.bairro);
                    return;
                }
                
                const deleteBtn = e.target.closest('.delete-property-btn');
                if (deleteBtn) {
                    const propertyId = deleteBtn.dataset.id;
                    showModal("Tem certeza que deseja excluir este imóvel da sua área?", () => {
                        const username = agenteInput.value;
                        const sectorKey = `aceFlowSectorData_${username}`;
                        let sectorData = JSON.parse(localStorage.getItem(sectorKey)) || { properties: {} };
                        delete sectorData.properties[propertyId];
                        localStorage.setItem(sectorKey, JSON.stringify(sectorData));
                        
                        // Refresh the current view
                        const currentTitle = sectorModalTitle.textContent;
                        const bairroMatch = currentTitle.match(/Bairro: (.*)/);
                        if (bairroMatch) {
                            renderBlocksAndProperties(bairroMatch[1]);
                        }
                    });
                }
            });
        }

        if (document.getElementById('reportBtn')) {
            document.getElementById('reportBtn').addEventListener('click', () => {
                reportModal.classList.remove('hidden');
                reportModal.classList.add('flex');
            });
        }

        if (closeReportModalBtn) {
            closeReportModalBtn.addEventListener('click', () => {
                reportModal.classList.add('hidden');
                reportModal.classList.remove('flex');
            });
        }

        if (searchReportBtn) searchReportBtn.addEventListener('click', renderReports);
        
        if (downloadReportPdfBtn) {
            downloadReportPdfBtn.addEventListener('click', () => {
                if (!currentReportData) {
                    alert("Gere um relatório primeiro para poder baixar o PDF.");
                    return;
                }

                const doc = new jsPDF();
                const summary = currentReportData;
                const startDate = reportStartDate.value;
                const endDate = reportEndDate.value;
                const agentName = agenteInput.value;
                
                const primaryColor = '#111827';
                const headerFooterColor = '#9CA3AF';
                const pageHeight = doc.internal.pageSize.height;
                let finalY = 0;

                // Função para adicionar cabeçalho e rodapé
                const addHeaderFooter = () => {
                    const pageCount = doc.internal.getNumberOfPages();
                    for(let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        // Cabeçalho
                        doc.setFillColor(primaryColor);
                        doc.rect(0, 0, 210, 20, 'F');
                        doc.setFontSize(18);
                        doc.setTextColor('#FFFFFF');
                        doc.setFont('helvetica', 'bold');
                        doc.text("Compilado de dados desse período", 105, 12, { align: 'center' });
                        // Rodapé
                        doc.setFontSize(8);
                        doc.setTextColor(headerFooterColor);
                        doc.text(`Página ${i} de ${pageCount}`, 105, pageHeight - 10, { align: 'center' });
                        doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 15, pageHeight - 10);
                    }
                };
                
                // Título principal
                doc.setFontSize(16);
                doc.setTextColor(primaryColor);
                doc.setFont('helvetica', 'bold');
                doc.text(`Agente: ${agentName}`, 15, 30);
                doc.setFont('helvetica', 'normal');
                doc.text(`Período: ${new Date(startDate + 'T12:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate + 'T12:00:00').toLocaleDateString('pt-BR')}`, 15, 38);

                const tableOptions = {
                    styles: { fontSize: 16, cellPadding: 3 },
                    headStyles: { fillColor: primaryColor, textColor: '#FFFFFF', fontSize: 16, fontStyle: 'bold' },
                    bodyStyles: { textColor: '#374151' },
                    alternateRowStyles: { fillColor: '#F3F4F6' },
                    startY: 45,
                    margin: { left: 15, right: 15 },
                };

                // Tabela 1: Detalhes dos Imóveis
                doc.autoTable({
                    ...tableOptions,
                    head: [['Detalhes dos Imóveis Trabalhados', 'Total']],
                    body: [
                        ['Residências', summary.residencia],
                        ['Comércios', summary.comercio],
                        ['Terrenos Baldios', summary.terrenoBaldio],
                        ['Outros', summary.outro],
                        [{ content: 'Total Trabalhados', styles: { fontStyle: 'bold' } }, { content: summary.trabalhado, styles: { fontStyle: 'bold' } }]
                    ],
                });
                finalY = doc.lastAutoTable.finalY;

                // Tabela 2: Resumo da Produção
                doc.autoTable({
                    ...tableOptions,
                    startY: finalY + 10,
                    head: [['Resumo da Produção', 'Total']],
                    body: [
                        ['Tratamentos Focais', summary.tratamentoFocal],
                        ['Larvicida Utilizado', `${summary.gramas.toFixed(1)} g`],
                        ['Depósitos Tratados', summary.depositosTratados],
                        ['Depósitos Eliminados', summary.eliminados],
                    ],
                });
                finalY = doc.lastAutoTable.finalY;
                
                // Tabela 3: Situação das Visitas
                doc.autoTable({
                    ...tableOptions,
                    startY: finalY + 10,
                    head: [['Situação das Visitas', 'Total']],
                    body: [
                        ['Imóveis Fechados', summary.fechado],
                        ['Recusas', summary.recusado],
                        [{ content: 'Total de Focos', styles: { fontStyle: 'bold', textColor: '#DC2626' } }, { content: summary.focos, styles: { fontStyle: 'bold', textColor: '#DC2626' } }]
                    ],
                });
                finalY = doc.lastAutoTable.finalY;

                // Seção de Pontos de Atenção (Focos)
                const imovelMap = { 'R': 'Residência', 'C': 'Comércio', 'TB': 'Terreno Baldio', 'O': 'Outro' };
                if(summary.hotspots.length > 0) {
                    finalY += 15;
                    if (finalY > pageHeight - 20) { doc.addPage(); finalY = 30; }
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Pontos de Atenção (Focos)', 15, finalY);
                    finalY += 10;
                    summary.hotspots.forEach(foco => {
                        if (finalY > pageHeight - 40) { doc.addPage(); finalY = 30; }
                        doc.setFontSize(16);
                        doc.setFont('helvetica', 'normal');
                        const focoText = `Bairro: ${foco.bairro}, Quart.: ${foco.quarteirao}, Rua: ${foco.logradouro}, ${foco.numero}, Tipo: ${imovelMap[foco.tipo] || foco.tipo}`;
                        const splitText = doc.splitTextToSize(focoText, 180);
                        doc.text(splitText, 18, finalY);
                        finalY += (splitText.length * 8) + 3; // Adjust spacing
                    });
                }
                
                addHeaderFooter();
                doc.save(`relatorio_periodo_${agentName.replace(/\s/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`);
            });
        }
        
        if (mainContent) {
            mainContent.addEventListener('input', (e) => {
                const target = e.target;
                
                if (target.matches('.form-input, .form-select')) {
                    target.dataset.manualInput = 'true';
                    if (target.value.trim() !== '') {
                        target.classList.add('is-filled');
                    } else {
                        target.classList.remove('is-filled');
                    }
                }
                
                // Save data first to ensure the latest changes are captured
                saveData(); 

                const card = target.closest('.visita-card');
                if (card) {
                    updateCardStatus(card); // Now this will call saveCurrentDayToHistory with fresh data
                }
                if (target.closest('#info-dia-section')) {
                    checkHeaderCompletion();
                }
                updateAndRenderSummary();
            });
            
            mainContent.addEventListener('blur', (e) => {
                const target = e.target;

                if (target.matches('.horario')) {
                    const card = target.closest('.visita-card');
                    if (card && card.classList.contains('card-completed')) {
                        const header = card.querySelector('.card-header');
                        const content = header.nextElementSibling;
                        if (header.getAttribute('data-expanded') === 'true') {
                            header.setAttribute('data-expanded', 'false');
                            content.classList.remove('show');
                            saveData();
                        }
                    }
                }
                
                if (target.matches('input[type="text"]') && target.value) {
                    if(target.id === 'estado' && target.value.length === 2) {
                        target.value = target.value.toUpperCase();
                    } else {
                        target.value = formatAndCorrectText(target.value);
                    }
                }
                
                // --- LÓGICA DE REPLICAÇÃO INTELIGENTE APRIMORADA ---
                const replicationClasses = ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado'];
                const targetIsReplicable = replicationClasses.some(c => target.matches(c)) || target.matches('#bairro');

                if (targetIsReplicable) {
                    const valueToReplicate = target.value;
                    let sourceIndex = -1;
                    let fieldClass = '';

                    if (target.matches('#bairro')) {
                        fieldClass = '.bairro-imovel';
                        sourceIndex = -1; // Começa a replicar do primeiro card
                    } else {
                        const sourceCard = target.closest('.visita-card');
                        sourceIndex = sourceCard ? parseInt(sourceCard.dataset.index, 10) : -1;
                        fieldClass = replicationClasses.find(c => target.matches(c));
                    }
                    
                    if (fieldClass) {
                        const allCards = document.querySelectorAll('.visita-card');
                        allCards.forEach((card, index) => {
                            if (index > sourceIndex) {
                                const fieldToUpdate = card.querySelector(fieldClass);
                                if (fieldToUpdate) {
                                    fieldToUpdate.value = valueToReplicate;
                                    fieldToUpdate.dataset.manualInput = 'false';
                                    if(valueToReplicate) fieldToUpdate.classList.add('is-filled');
                                    else fieldToUpdate.classList.remove('is-filled');
                                    updateCardStatus(card);
                                }
                            }
                        });
                    }
                }

                const card = target.closest('.visita-card');
                if (card) {
                    updateCardStatus(card);
                }
                if (target.closest('#info-dia-section')) {
                    checkHeaderCompletion();
                }

                if (target.id === 'agente') updateAutocomplete('agent', target.value);
                if (target.id === 'bairro' || target.classList.contains('bairro-imovel')) updateAutocomplete('bairro', target.value);
                if (target.classList.contains('logradouro')) updateAutocomplete('street', target.value);
                saveData();
            }, true);
        }
        
        if (visitasContainer) {
            visitasContainer.addEventListener('focusin', (e) => {
                const card = e.target.closest('.visita-card');
                if(card) {
                    const logradouro = card.querySelector('.logradouro').value || '...';
                    const numero = card.querySelector('.numero').value || '...';
                    fixedPropertyInfo.textContent = `Imóvel: ${logradouro}, ${numero}`;
                }
            });

            visitasContainer.addEventListener('click', (e) => {
                const header = e.target.closest('.card-header');
                if (header) {
                    const content = header.nextElementSibling;
                    const isExpanded = header.getAttribute('data-expanded') === 'true';
                    header.setAttribute('data-expanded', !isExpanded);
                    content.classList.toggle('show');
                    saveData();
                    return;
                }
                if (e.target.matches('.toggle-check')) {
                    e.target.classList.toggle('is-checked');
                    updateToggleHTML(e.target);
                    updateAndRenderSummary();
                    saveData();
                }
            });
        }
        
        if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideModal(); });
        if (modalCancelBtn) modalCancelBtn.addEventListener('click', hideModal);

        if (backupBtn) {
            backupBtn.addEventListener('click', () => {
                const username = agenteInput.value || 'agente';
                const dataToBackup = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('aceFlow')) {
                        dataToBackup[key] = localStorage.getItem(key);
                    }
                }
                
                const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ace_flow_backup_${username}_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                alert('Backup concluído com sucesso!');
            });
        }

        if (restoreInput) {
            restoreInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        showModal('Tem certeza que deseja restaurar este backup? Todos os dados atuais serão substituídos.', () => {
                            Object.keys(data).forEach(key => {
                                localStorage.setItem(key, data[key]);
                            });
                            alert('Dados restaurados com sucesso! O aplicativo será recarregado.');
                            location.reload();
                        });
                    } catch (error) {
                        alert('Arquivo de backup inválido ou corrompido.');
                        console.error("Erro ao restaurar:", error);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Limpa o input para permitir o mesmo arquivo novamente
            });
        }

        // --- LÓGICA DAS CURIOSIDADES ---
        const createFaqModal = (modalEl, title, intro, qnaArray) => {
            let qnaHTML = '';
            qnaArray.forEach((item, index) => {
                qnaHTML += `
                    <div class="faq-item border-b border-gray-200">
                        <div class="faq-question flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                            <span class="font-semibold text-gray-800">${item.q}</span>
                            <span class="faq-toggle-icon text-2xl text-gray-400 transition-transform duration-300">+</span>
                        </div>
                        <div class="faq-answer text-gray-600 leading-relaxed">
                           <div class="p-4 flex items-start gap-4">
                                ${item.icon ? `<div class="flex-shrink-0 w-12 h-12 flex items-center justify-center text-3xl">${item.icon}</div>` : ''}
                               <p>${item.a}</p>
                           </div>
                        </div>
                    </div>
                `;
            });

            modalEl.innerHTML = `
                <div class="card p-0 w-11/12 max-w-4xl max-h-[90vh] flex flex-col">
                    <header class="sticky top-0 bg-white/80 backdrop-blur-sm z-10 flex justify-between items-center border-b p-4">
                        <h2 class="section-title">${title}</h2>
                        <button class="close-faq-modal text-3xl font-bold">&times;</button>
                    </header>
                    <div class="flex-grow overflow-y-auto">
                        <div class="p-6">
                            <p class="mb-6 text-text-muted">${intro}</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-inner">
                           ${qnaHTML}
                        </div>
                    </div>
                </div>
            `;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        };

        const createSupportSectionHTML = () => `
            <h3 class="text-2xl font-bold mb-4 text-center">Dúvidas ou Suporte?</h3>
            <p class="text-text-muted mb-6 text-center">Entre em contato conosco. Estamos prontos para ajudar!</p>
            <div class="flex flex-col items-center gap-4">
                <a href="https://wa.me/5584988559871" target="_blank" class="btn bg-green-500 hover:bg-green-600 text-white w-full sm:w-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.886-.003 2.228.656 4.357 1.849 6.037l-1.09 3.972 4.043-1.055z"/></svg>
                    WhatsApp
                </a>
                <button id="copyEmailBtn" data-email="aceflow2025@gmail.com" class="inline-flex items-center gap-2 text-sm text-text-muted hover:text-khaki-dark bg-white py-2 px-4 rounded-full border-2 border-gray-200 hover:border-khaki-base transition-all shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    <span class="email-text">aceflow2025@gmail.com</span>
                </button>
            </div>
        `;

        document.getElementById('support-section-login').innerHTML = createSupportSectionHTML();
        document.getElementById('support-section-main').innerHTML = createSupportSectionHTML();

        document.body.addEventListener('click', (e) => {
            const copyBtn = e.target.closest('#copyEmailBtn');
            if (copyBtn) {
                const email = copyBtn.dataset.email;
                const emailTextSpan = copyBtn.querySelector('.email-text');
                
                const textarea = document.createElement('textarea');
                textarea.value = email;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    const originalText = emailTextSpan.textContent;
                    emailTextSpan.textContent = 'Copiado!';
                    copyBtn.classList.add('bg-green-100', 'border-green-400');

                    setTimeout(() => {
                        emailTextSpan.textContent = originalText;
                        copyBtn.classList.remove('bg-green-100', 'border-green-400');
                    }, 2000);
                } catch (err) {
                    console.error('Falha ao copiar o e-mail: ', err);
                    alert('Não foi possível copiar o e-mail. Por favor, copie manualmente.');
                }
                document.body.removeChild(textarea);
            }

            if (e.target.closest('.close-faq-modal')) {
                e.target.closest('.modal').classList.add('hidden');
            }
            const question = e.target.closest('.faq-question');
            if (question) {
                const answer = question.nextElementSibling;
                question.classList.toggle('active');
                answer.classList.toggle('show');
            }

            if (e.target.id === 'curiositiesBtn') {
                const subButtons = document.getElementById('subButtonsContainer');
                if (subButtons) {
                    subButtons.classList.toggle('hidden');
                }
            }
        });

        const checkHeaderCompletion = () => {
            const inputs = infoDiaSection.querySelectorAll('input, select');
            const allFilled = [...inputs].every(input => input.value.trim() !== '');

            if (allFilled) {
                infoDiaSection.classList.add('card-completed');
            } else {
                infoDiaSection.classList.remove('card-completed');
            }
        };

        
        const initApp = () => {
            const savedUser = JSON.parse(localStorage.getItem('aceFlowUser'));
            if (savedUser && savedUser.isLoggedIn) {
                landingPage.style.display = 'none';
                loginModal.style.display = 'none';
                mainContent.classList.remove('hidden');
                fixedInfoBar.classList.remove('hidden');
                agenteInput.value = savedUser.username;
                agenteInput.classList.add('is-filled');
                fixedAgentName.textContent = savedUser.username;
                loadData();
                updateAndRenderSummary();
            } else {
                const sections = document.querySelectorAll('.fade-in-up');
                const observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('is-visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                sections.forEach(section => observer.observe(section));
            }

            agentList = JSON.parse(localStorage.getItem('aceFlowagentList')) || [];
            bairroList = JSON.parse(localStorage.getItem('aceFlowbairroList')) || [];
            streetList = JSON.parse(localStorage.getItem('aceFlowstreetList')) || [];
            agentSuggestions.innerHTML = agentList.map(item => `<option value="${item}"></option>`).join('');
            bairroSuggestions.innerHTML = bairroList.map(item => `<option value="${item}"></option>`).join('');
            streetSuggestions.innerHTML = streetList.map(item => `<option value="${item}"></option>`).join('');
            populateSelects();

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dataInput.value = `${year}-${month}-${day}`;
            
            dataInput.classList.add('is-filled');
            loadGoalData();
            displayLastPropertyReminder();
            checkHeaderCompletion();
        };
        
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', () => {
                localStorage.removeItem('aceFlowUser');
                location.reload();
            });
        }
        
        // --- UPDATED KNOWLEDGE BASE ---
        if (showBasicKnowledgeBtn) {
            showBasicKnowledgeBtn.addEventListener('click', () => {
                const title = "Conhecimento Básico do ACE";
                const intro = "Agente, o conhecimento é a sua principal ferramenta de trabalho. Dominar informações sobre endemias, vigilância, saneamento e saúde pública é vital para agir com segurança, precisão e impacto. Quanto mais você entende sua área de atuação, mais eficaz será sua prevenção e mais vidas poderá proteger. A ignorância, nesse campo, não é só uma falha — é um risco para toda a comunidade. Conhecer é salvar.";
                const qna = [
                    { q: "O que é uma endemia e como ela se diferencia de uma epidemia e de uma pandemia?", icon: "🌍", a: "➡️ <strong>Endemia:</strong> é a presença constante de uma doença em uma determinada região, com um número de casos esperado (ex: febre amarela na Amazônia).<br>➡️ <strong>Epidemia:</strong> é um aumento súbito e acima do esperado no número de casos de uma doença em uma região ou população específica.<br>➡️ <strong>Pandemia:</strong> é uma epidemia que se espalha por vários países ou continentes, afetando um grande número de pessoas.<br>📚 <strong>Fonte:</strong> Ministério da Saúde (MS), Organização Pan-Americana da Saúde (OPAS)." },
                    { q: "Quais são as atribuições essenciais de um ACE segundo o Ministério da Saúde?", icon: "📋", a: "As principais são: realizar visitas domiciliares para vistoria e eliminação de criadouros; orientar a comunidade sobre prevenção; realizar tratamento focal quando necessário; comunicar casos suspeitos à vigilância; e preencher corretamente os boletins e relatórios de campo.<br>📚 <strong>Fonte:</strong> Programa Nacional de Controle da Dengue (PNCD), Lei nº 11.350/2006." },
                    { q: "O que é Leishmaniose Visceral (Calazar) e como ela é transmitida?", icon: "🦟", a: "É uma doença grave, causada por um protozoário (Leishmania chagasi) e transmitida pela picada da fêmea do mosquito-palha (Lutzomyia longipalpis). Causa febre de longa duração, emagrecimento, fraqueza e aumento do fígado e do baço. O cão é o principal reservatório do parasita em áreas urbanas.<br>📚 <strong>Fonte:</strong> Fiocruz, Ministério da Saúde." },
                    { q: "Como ocorre a transmissão da Leptospirose e quais seus principais sintomas?", icon: "🐀", a: "É transmitida pelo contato com a urina de animais infectados, principalmente ratos. A contaminação ocorre quando a pele com lesões ou as mucosas entram em contato com água ou lama contaminada. Os sintomas são febre, dor de cabeça e, principalmente, fortes dores musculares, especialmente nas panturrilhas ('batata da perna').<br>📚 <strong>Fonte:</strong> Ministério da Saúde, Fundação Oswaldo Cruz." },
                    { q: "Qual a função do ACE na prevenção da Leishmaniose Visceral?", icon: "🐶", a: "Orientar a população sobre a limpeza dos quintais (para eliminar matéria orgânica onde o mosquito-palha se desenvolve), o manejo adequado do lixo, e os cuidados com os cães (uso de coleiras repelentes, exames). O ACE também deve notificar a presença de cães com sinais da doença (emagrecimento, feridas na pele) à vigilância.<br>📚 <strong>Fonte:</strong> Guia de Vigilância em Saúde (MS)." },
                    { q: "O que é vigilância entomológica e por que ela é fundamental?", icon: "🔬", a: "É o monitoramento da população de insetos vetores. Isso inclui verificar onde estão, em que quantidade e se estão infectados com algum vírus. É fundamental porque os dados coletados (como o Levantamento de Índice Rápido para Aedes aegypti - LIRAa) ajudam os gestores a planejar e direcionar as ações de controle com mais eficiência.<br>📚 <strong>Fonte:</strong> Ministério da Saúde." },
                    { q: "Quais zoonoses urbanas são mais comuns no Brasil e o que um ACE deve saber?", icon: "🐾", a: "Além de Dengue e Leishmaniose, outras importantes são: <strong>Leptospirose</strong> (ratos), <strong>Raiva</strong> (cães, gatos, morcegos), <strong>Toxoplasmose</strong> (gatos) e <strong>Esporotricose</strong> (gatos). O ACE deve conhecer as formas de transmissão, as medidas de prevenção para cada uma e como orientar a população.<br>📚 <strong>Fonte:</strong> Manuais de Vigilância de Zoonoses (MS)." },
                    { q: "O que é Raiva e como o ACE contribui na prevenção?", icon: "🦇", a: "É uma doença viral quase sempre fatal, transmitida pela saliva de mamíferos infectados, principalmente por mordidas. O ACE é peça-chave ao orientar a população sobre a importância da vacinação anual de cães e gatos, e a notificar a presença de animais com comportamento estranho (agressivos, com salivação excessiva) ou de morcegos caídos.<br>📚 <strong>Fonte:</strong> OMS, Ministério da Saúde." },
                    { q: "Como o saneamento básico influencia diretamente no controle de endemias?", icon: "🚽", a: "A falta de água tratada, coleta de lixo e rede de esgoto cria o ambiente perfeito para a proliferação de vetores. Lixo acumulado vira criadouro de mosquitos; esgoto a céu aberto atrai ratos; água armazenada de forma inadequada serve para o Aedes. O trabalho do ACE é impactado diretamente pela qualidade do saneamento.<br>📚 <strong>Fonte:</strong> Instituto Trata Brasil, FUNASA." },
                    { q: "Qual a importância da ética e do sigilo profissional no trabalho do ACE?", icon: "🤫", a: "O ACE entra na casa das pessoas e lida com informações sobre sua saúde e vida. Manter o sigilo do que vê e ouve é fundamental para construir uma relação de confiança com a comunidade. A ética garante o respeito e a colaboração dos moradores, que são essenciais para o sucesso do trabalho.<br>📚 <strong>Fonte:</strong> Código de Ética dos Servidores Públicos, Política Nacional de Educação Popular em Saúde (PNEPS-SUS)." },
                    { q: "Quais EPIs (Equipamentos de Proteção Individual) são obrigatórios para o ACE?", icon: "⛑️", a: "Os EPIs básicos são: calçado fechado e antiderrapante, calça comprida, camisa de manga longa, chapéu ou boné de aba larga, protetor solar e crachá de identificação visível. Luvas e máscaras podem ser necessárias dependendo da atividade. O uso correto previne acidentes, picadas de insetos e insolação.<br>📚 <strong>Fonte:</strong> NR-6 e NR-32 (Normas Regulamentadoras), Ministério do Trabalho e Emprego." },
                    { q: "Qual a diferença entre controle mecânico, químico e biológico?", icon: "⚙️", a: "<strong>Controle Mecânico/Físico:</strong> É a eliminação manual de criadouros (ex: virar garrafas, tampar caixas d'água). É a ação mais importante e a principal atribuição do ACE.<br><strong>Controle Químico:</strong> Uso de produtos como larvicidas (em depósitos que não podem ser eliminados) e inseticidas ('fumacê').<br><strong>Controle Biológico:</strong> Uso de organismos vivos para combater o vetor, como peixes que comem larvas ou bactérias que as matam.<br>📚 <strong>Fonte:</strong> Fundação Nacional de Saúde (FUNASA)." },
                    { q: "Como deve ser feito o registro e a notificação das atividades pelo ACE?", icon: "✍️", a: "O registro deve ser feito de forma clara e precisa nas fichas padronizadas pelo município ou em sistemas informatizados (como o e-SUS). A notificação de casos suspeitos ou de situações de risco (como alta infestação de larvas) deve ser feita imediatamente ao supervisor, pois isso dispara as ações de vigilância.<br>📚 <strong>Fonte:</strong> Guias do Sistema de Informação da Atenção Básica (SISAB)." },
                    { q: "O que são Pontos Estratégicos (PE) e por que merecem atenção especial?", icon: "🎯", a: "São locais com alta probabilidade de proliferação de vetores, como ferros-velhos, borracharias, cemitérios e depósitos de materiais recicláveis. Esses locais devem ser visitados com maior frequência (geralmente a cada 15 dias) por representarem um risco maior para a dispersão de mosquitos.<br>📚 <strong>Fonte:</strong> Diretrizes Nacionais para Prevenção e Controle de Epidemias de Dengue (MS)." },
                    { q: "O que é o Levantamento de Índice (LIRAa/LIA) e qual a sua finalidade?", icon: "📊", a: "É uma metodologia rápida para saber o Índice de Infestação Predial (IIP) por Aedes aegypti no município. O ACE visita uma amostra de imóveis, coleta larvas e identifica os tipos de criadouros mais comuns. O resultado ajuda a classificar o risco da cidade (baixo, médio ou alto) e a direcionar as ações de controle.<br>📚 <strong>Fonte:</strong> Ministério da Saúde." }
                ];
                createFaqModal(faqModal, title, intro, qna);
            });
        }

        if (showDengueModalBtn) {
            showDengueModalBtn.addEventListener('click', () => {
                const title = "Aprenda mais sobre as Arboviroses";
                const intro = "Conheça os detalhes sobre as principais doenças transmitidas pelo Aedes aegypti, seus sintomas, tratamentos e as diferenças cruciais entre elas.";
                const qna = [
                    { q: "Quais são os sintomas clássicos da Dengue?", icon: "🤒", a: "Febre alta (acima de 38°C) de início súbito, dor de cabeça forte, dor intensa atrás dos olhos, dores musculares e nas articulações, fraqueza e manchas vermelhas na pele. A falta de apetite e o cansaço extremo são muito comuns.<br>📚 <strong>Fonte:</strong> Ministério da Saúde, OPAS." },
                    { q: "Qual a principal forma de prevenção contra as três arboviroses?", icon: "🚫💧", a: "A prevenção é a mesma para Dengue, Zika e Chikungunya: <strong>eliminar os criadouros do mosquito Aedes aegypti</strong>. Sem água parada, o mosquito não se reproduz e o ciclo de transmissão é interrompido. Esta é a medida mais eficaz e barata.<br>📚 <strong>Fonte:</strong> Organização Mundial da Saúde (OMS)." },
                    { q: "Quais são os sinais de alerta para a Dengue Grave?", icon: "❗", a: "Após a febre baixar (entre o 3º e 7º dia), fique atento a: dor abdominal forte e contínua, vômitos persistentes, sangramento de mucosas (nariz, gengiva), sonolência ou irritabilidade, e tonturas. Estes sinais indicam a necessidade de procurar atendimento médico de urgência.<br>📚 <strong>Fonte:</strong> Protocolos Clínicos do Ministério da Saúde." },
                    { q: "Qual a principal característica da febre Chikungunya?", icon: "🦴", a: "A principal e mais marcante característica são as <strong>dores intensas nas articulações</strong> (juntas), que podem ser tão fortes a ponto de incapacitar a pessoa de andar ou realizar tarefas simples. Essas dores podem se tornar crônicas, durando meses ou até anos.<br>📚 <strong>Fonte:</strong> Sociedade Brasileira de Reumatologia." },
                    { q: "E a Zika, qual seu maior risco e sintoma diferencial?", icon: "🧠", a: "O maior risco da Zika é para gestantes, pois pode causar <strong>microcefalia</strong> e outras malformações no feto. Um sintoma diferencial comum é o exantema (manchas vermelhas na pele) acompanhado de coceira intensa, que muitas vezes aparece antes da febre (que costuma ser mais baixa).<br>📚 <strong>Fonte:</strong> Fiocruz, OMS." },
                    { q: "Posso pegar Dengue mais de uma vez?", icon: "🔄", a: "Sim. Existem quatro sorotipos do vírus da dengue (DENV-1, 2, 3 e 4). A infecção por um deles gera imunidade permanente apenas para aquele sorotipo. Portanto, uma pessoa pode ter dengue até quatro vezes ao longo da vida.<br>📚 <strong>Fonte:</strong> Instituto Butantan." },
                    { q: "É verdade que a segunda infecção por Dengue é sempre mais grave?", icon: "📈", a: "Não é uma regra, mas o risco é maior. Ter uma segunda infecção por um sorotipo diferente aumenta a chance de desenvolver as formas graves da doença. Por isso, a prevenção é importante mesmo para quem já teve dengue.<br>📚 <strong>Fonte:</strong> Sociedade Brasileira de Infectologia." },
                    { q: "Quais medicamentos são proibidos em caso de suspeita de Dengue?", icon: "💊", a: "É proibido o uso de medicamentos à base de <strong>ácido acetilsalicílico (AAS)</strong> e outros <strong>anti-inflamatórios não esteroides</strong> (como ibuprofeno, nimesulida, diclofenaco). Eles afetam a coagulação e a função das plaquetas, aumentando o risco de hemorragias.<br>📚 <strong>Fonte:</strong> ANVISA, Conselho Federal de Farmácia." },
                    { q: "O que é o 'bloqueio de transmissão' e quando é feito?", icon: "💨", a: "É uma ação de controle químico realizada quando há um caso suspeito ou confirmado de arbovirose. Consiste na aplicação de inseticida com bomba costal motorizada (UBV) nos imóveis ao redor da casa do paciente para eliminar os mosquitos adultos que possam estar infectados e interromper a transmissão na área.<br>📚 <strong>Fonte:</strong> Manuais de Controle de Vetores (MS)." },
                    { q: "Existe vacina para as três doenças?", icon: "💉", a: "Atualmente, no Brasil, existe vacina para a <strong>Dengue</strong> (disponível no SUS para públicos específicos) e para a <strong>Febre Amarela</strong>. Para Zika e Chikungunya, as vacinas ainda estão em fase de pesquisa e desenvolvimento, mas com avanços promissores.<br>📚 <strong>Fonte:</strong> Ministério da Saúde, Agência Nacional de Vigilância Sanitária (ANVISA)." },
                    { q: "Uma pessoa com Dengue, Zika ou Chikungunya pode doar sangue?", icon: "🩸", a: "Não. Quem teve Dengue deve aguardar 30 dias após a recuperação completa. Para Zika, são 120 dias devido à detecção do vírus em fluidos corporais por mais tempo. Para Chikungunya, também são 30 dias após o fim dos sintomas.<br>📚 <strong>Fonte:</strong> Pró-Sangue, Hemocentros." },
                    { q: "O que é o teste do laço (Prova de Rumpel-Leede)?", icon: "💪", a: "É um teste simples que pode ser feito no posto de saúde para verificar a fragilidade dos vasos sanguíneos, um sinal de alerta para a dengue. O profissional de saúde 'amarra' o braço do paciente com o aparelho de pressão por alguns minutos e observa se aparecem pequenos pontos vermelhos (petéquias) na pele.<br>📚 <strong>Fonte:</strong> Protocolos de Enfermagem na Atenção Básica." },
                    { q: "Por que a hidratação é tão importante no tratamento da Dengue?", icon: "💧", a: "Na dengue, ocorre um 'vazamento' de plasma dos vasos sanguíneos, o que pode levar à desidratação e ao choque. Beber muito líquido (água, soro caseiro, água de coco) ajuda a manter o volume de sangue circulando, prevenindo as complicações graves da doença. É a medida de tratamento mais importante!<br>📚 <strong>Fonte:</strong> Ministério da Saúde." },
                    { q: "O que é a transmissão vertical da Zika?", icon: "🤰", a: "É a transmissão do vírus da mãe para o feto durante a gestação. É essa forma de transmissão que está associada aos casos de microcefalia e outras alterações neurológicas em bebês, conhecida como Síndrome Congênita do Zika Vírus.<br>📚 <strong>Fonte:</strong> Organização Mundial da Saúde (OMS)." },
                    { q: "As dores da Chikungunya podem durar para sempre?", icon: "⏳", a: "Na maioria dos casos, as dores melhoram em semanas. No entanto, uma parte dos pacientes (cerca de 30-50%) pode desenvolver uma fase crônica, com dores articulares que persistem por mais de 3 meses, podendo durar anos. O tratamento com fisioterapia e medicamentos específicos é fundamental nesses casos.<br>📚 <strong>Fonte:</strong> Sociedade Brasileira de Reumatologia." }
                ];
                createFaqModal(faqModal, title, intro, qna);
            });
        }

        if (showAedesModalBtn) {
            showAedesModalBtn.addEventListener('click', () => {
                const title = "Aprenda mais sobre o Aedes Aegypti";
                const intro = "Conheça a fundo o mosquito que desafia a saúde pública. Entender seu comportamento, ciclo de vida e preferências é a chave para um controle eficaz.";
                const qna = [
                    { q: "Como posso diferenciar o Aedes aegypti do pernilongo comum?", icon: "🧐", a: "O <strong>Aedes aegypti</strong> é preto com listras e manchas brancas no corpo e nas pernas, tem hábitos diurnos e seu zumbido é quase inaudível. O <strong>pernilongo comum (Culex)</strong> é marrom, não tem listras, tem hábitos noturnos e seu zumbido é bem perceptível.<br>📚 <strong>Fonte:</strong> Fiocruz, Instituto Oswaldo Cruz." },
                    { q: "Por que apenas a fêmea do Aedes aegypti pica?", icon: "♀️", a: "A fêmea precisa do sangue de mamíferos (rico em proteínas) para a maturação e o desenvolvimento dos seus ovos. O macho se alimenta apenas de seiva e néctar de plantas, por isso não pica.<br>📚 <strong>Fonte:</strong> Entomologia Médica, Neves, D.P." },
                    { q: "Onde o mosquito se esconde dentro de casa?", icon: "🏠", a: "Ele prefere locais escuros, úmidos e com pouca movimentação. É comum encontrá-lo embaixo de mesas, camas e móveis, atrás de cortinas, em cantos de parede e em áreas de serviço.<br>📚 <strong>Fonte:</strong> Manuais de Controle de Vetores (MS)." },
                    { q: "Como os ovos do Aedes aegypti sobrevivem por tanto tempo sem água?", icon: "⏳", a: "Os ovos possuem uma estrutura que os torna extremamente resistentes à dessecação (perda de água). Eles podem ficar 'dormentes' por mais de um ano em um local seco, esperando apenas um pouco de água para eclodir. Por isso, a limpeza dos recipientes com escova é fundamental.<br>📚 <strong>Fonte:</strong> Journal of Medical Entomology." },
                    { q: "Qual a importância de lavar os recipientes com água e sabão?", icon: "🧼", a: "Apenas jogar a água fora não é suficiente, pois os ovos do mosquito ficam grudados nas paredes do recipiente. É preciso esfregar com uma bucha ou escova para removê-los completamente, quebrando assim o ciclo de vida do vetor.<br>📚 <strong>Fonte:</strong> Ministério da Saúde." },
                    { q: "Qual a temperatura ideal para a proliferação do mosquito?", icon: "🌡️", a: "O Aedes aegypti se desenvolve melhor em temperaturas entre 24°C e 28°C. Em temperaturas mais altas, seu ciclo de vida (de ovo a adulto) se torna mais rápido, o que aumenta a população de mosquitos em menos tempo.<br>📚 <strong>Fonte:</strong> Organização Pan-Americana da Saúde (OPAS)." },
                    { q: "O mosquito pode transmitir o vírus para seus ovos?", icon: "🧬", a: "Sim, isso é chamado de <strong>transmissão vertical ou transovariana</strong>. A fêmea infectada pode passar o vírus da dengue para seus ovos. Isso significa que um mosquito já pode nascer infectado, sem nunca ter picado uma pessoa doente. Embora não seja a principal forma de transmissão, ela ajuda a manter o vírus circulando no ambiente.<br>📚 <strong>Fonte:</strong> Vetores & Pragas Journal." },
                    { q: "Repelentes de tomada e ultrassônicos funcionam contra o Aedes?", icon: "⚡", a: "Repelentes elétricos que liberam inseticida no ar têm eficácia limitada a ambientes pequenos e fechados. Já os aparelhos ultrassônicos, que emitem som, <strong>não possuem nenhuma eficácia comprovada</strong> contra o mosquito e não são recomendados.<br>📚 <strong>Fonte:</strong> ANVISA, Testes de Eficácia de Produtos." },
                    { q: "O Aedes aegypti pode picar através da roupa?", icon: "👕", a: "Sim. Se o tecido da roupa for fino e estiver justo ao corpo, como leggings e camisetas de malha fina, o aparelho picador do mosquito pode atravessá-lo. Roupas mais grossas e folgadas oferecem maior proteção.<br>📚 <strong>Fonte:</strong> Consumer Reports, Entomologistas." },
                    { q: "Por que o 'fumacê' (UBV pesado) não resolve o problema sozinho?", icon: "☁️", a: "O 'fumacê' mata apenas os mosquitos adultos que estão voando no momento da aplicação. Ele não tem efeito sobre os ovos e as larvas que estão na água. Por isso, é uma medida emergencial e complementar, e a eliminação dos criadouros continua sendo a ação principal.<br>📚 <strong>Fonte:</strong> Ministério da Saúde." },
                    { q: "O mosquito se reproduz em água de piscina?", icon: "🏊", a: "Em piscinas tratadas com cloro e em uso constante, não. O movimento da água e o cloro impedem a proliferação. No entanto, uma piscina abandonada, com água parada e sem tratamento, torna-se um criadouro gigante e extremamente perigoso.<br>📚 <strong>Fonte:</strong> Secretarias Estaduais de Saúde." },
                    { q: "Plantas como a citronela realmente afastam o mosquito?", icon: "🌿", a: "O óleo essencial da citronela tem efeito repelente, mas sua eficácia é de curta duração e limitada a uma área muito próxima da planta. Ter um vaso de citronela na sala não é suficiente para proteger a casa toda. Repelentes corporais à base de Icaridina ou DEET são mais eficazes.<br>📚 <strong>Fonte:</strong> Journal of Insect Science." },
                    { q: "Qual o raio de voo do Aedes aegypti?", icon: "✈️", a: "O Aedes aegypti não voa longas distâncias. Ele geralmente vive e se reproduz em um raio de 50 a 100 metros do local onde nasceu. Isso significa que o mosquito que pica você provavelmente nasceu na sua casa ou na casa de um vizinho próximo.<br>📚 <strong>Fonte:</strong> Fiocruz." },
                    { q: "O Aedes aegypti também transmite Febre Amarela?", icon: "🟡", a: "Sim, ele é o vetor da <strong>Febre Amarela urbana</strong>. No entanto, graças às campanhas de vacinação, os ciclos urbanos da doença são raros no Brasil. A Febre Amarela silvestre, transmitida pelos mosquitos Haemagogus e Sabethes em áreas de mata, é mais comum.<br>📚 <strong>Fonte:</strong> Ministério da Saúde." },
                    { q: "O que é o 'Aedes do bem'?", icon: "🤖", a: "É uma técnica de controle biológico onde mosquitos Aedes aegypti machos são modificados geneticamente. Ao acasalarem com as fêmeas selvagens, geram descendentes que não chegam à fase adulta. É uma tecnologia promissora para reduzir a população do vetor em áreas específicas.<br>📚 <strong>Fonte:</strong> Oxitec, Nature Biotechnology." }
                ];
                createFaqModal(faqModal, title, intro, qna);
            });
        }
        
        // --- NEW LOGIC FOR COORDINATOR MODE ---
        goToCoordinatorModeBtn.addEventListener('click', () => {
            mainContent.classList.add('hidden');
            fixedInfoBar.classList.add('hidden');
            coordinatorModeDashboard.classList.remove('hidden');
        });

        backToAgentModeBtn.addEventListener('click', () => {
            coordinatorModeDashboard.classList.add('hidden');
            mainContent.classList.remove('hidden');
            fixedInfoBar.classList.remove('hidden');
        });

        pdfUploadInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            if (files.length === 0) return;

            analysisDashboard.classList.remove('hidden');
            analysisLoader.classList.remove('hidden');
            analysisResults.classList.add('hidden');
            uploadStatus.textContent = `Carregando ${files.length} arquivo(s)...`;

            const allData = { agents: {}, summary: { totalFoci: 0, totalWorked: 0, totalLarvicide: 0 }, hotspots: {} };
            
            for (const file of files) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ');
                    }
                    
                    const parsedData = parsePdfText(fullText);
                    if (parsedData && parsedData.agent) {
                        if (!allData.agents[parsedData.agent]) {
                            allData.agents[parsedData.agent] = { worked: 0, foci: 0, reports: 0 };
                        }
                        allData.agents[parsedData.agent].worked += parsedData.worked;
                        allData.agents[parsedData.agent].foci += parsedData.foci;
                        allData.agents[parsedData.agent].reports++;
                        
                        allData.summary.totalFoci += parsedData.foci;
                        allData.summary.totalWorked += parsedData.worked;
                        allData.summary.totalLarvicide += parsedData.larvicide;

                        if (parsedData.bairro && parsedData.foci > 0) {
                            if (!allData.hotspots[parsedData.bairro]) {
                                allData.hotspots[parsedData.bairro] = 0;
                            }
                            allData.hotspots[parsedData.bairro] += parsedData.foci;
                        }
                    }
                } catch (err) {
                    console.error("Erro ao processar PDF:", file.name, err);
                    uploadStatus.textContent = `Erro ao ler o arquivo ${file.name}. Verifique se o formato está correto.`;
                }
            }
            
            uploadStatus.textContent = `${files.length} arquivo(s) processado(s). Gerando análise...`;
            displayCoordinatorDashboard(allData);
        });

        const parsePdfText = (text) => {
            const agentMatch = text.match(/Agente:\s*([^\s][\w\s]+?)\s*Data:/);
            const workedMatch = text.match(/Total Trabalhados\s*(\d+)/);
            const fociMatch = text.match(/Total de Focos\s*(\d+)/);
            const larvicideMatch = text.match(/Quantidade de Larvicida\s*([\d\.]+)g/);
            const bairroMatch = text.match(/Bairro Principal:\s*([\w\s\d\-\/]+?)\s*Ciclo:/);

            if (!agentMatch || !workedMatch || !fociMatch) return null;

            return {
                agent: agentMatch[1].trim(),
                worked: parseInt(workedMatch[1], 10),
                foci: parseInt(fociMatch[1], 10),
                larvicide: larvicideMatch ? parseFloat(larvicideMatch[1]) : 0,
                bairro: bairroMatch ? bairroMatch[1].trim() : "Não especificado"
            };
        };

        const displayCoordinatorDashboard = (data) => {
            analysisLoader.classList.add('hidden');
            analysisResults.classList.remove('hidden');

            // 1. Render Summary Cards
            summaryCardsContainer.innerHTML = `
                <div class="dashboard-card text-center p-4">
                    <p class="text-3xl font-bold">${Object.keys(data.agents).length}</p><p class="text-sm text-gray-500">Agentes</p>
                </div>
                <div class="dashboard-card text-center p-4">
                    <p class="text-3xl font-bold">${data.summary.totalWorked}</p><p class="text-sm text-gray-500">Imóveis Trabalhados</p>
                </div>
                <div class="dashboard-card text-center p-4 text-red-600">
                    <p class="text-3xl font-bold">${data.summary.totalFoci}</p><p class="text-sm">Focos Encontrados</p>
                </div>
                 <div class="dashboard-card text-center p-4">
                    <p class="text-3xl font-bold">${data.summary.totalLarvicide.toFixed(1)}g</p><p class="text-sm text-gray-500">Larvicida Usado</p>
                </div>
                 <div class="dashboard-card text-center p-4">
                    <p class="text-3xl font-bold">${Object.keys(data.hotspots).length}</p><p class="text-sm text-gray-500">Bairros com Focos</p>
                </div>
            `;

            // 2. Generate AI Analysis
            const analysis = generateAIAnalysis(data);
            aiStrategicAnalysis.innerHTML = analysis.strategic;
            hotspotAnalysis.innerHTML = analysis.hotspots;
            aiEducationalContent.innerHTML = analysis.educational;

            // 3. Create Charts
            const agentNames = Object.keys(data.agents);
            const workedData = agentNames.map(name => data.agents[name].worked);
            const fociData = agentNames.map(name => data.agents[name].foci);

            if (performanceChartInstance) performanceChartInstance.destroy();
            performanceChartInstance = new Chart(document.getElementById('performanceChart'), {
                type: 'bar',
                data: {
                    labels: agentNames,
                    datasets: [
                        { label: 'Imóveis Trabalhados', data: workedData, backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 },
                        { label: 'Focos Encontrados', data: fociData, backgroundColor: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }
                    ]
                },
                options: { responsive: true, plugins: { title: { display: true, text: 'Desempenho por Agente' } } }
            });

            const hotspotLabels = Object.keys(data.hotspots);
            const hotspotData = Object.values(data.hotspots);
            if (fociDistributionChartInstance) fociDistributionChartInstance.destroy();
            fociDistributionChartInstance = new Chart(document.getElementById('fociDistributionChart'), {
                type: 'doughnut',
                data: {
                    labels: hotspotLabels,
                    datasets: [{ label: 'Focos por Bairro', data: hotspotData, backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'] }]
                },
                options: { responsive: true, plugins: { title: { display: true, text: 'Distribuição de Focos por Bairro' } } }
            });
        };

        const generateAIAnalysis = (data) => {
            let strategic = '';
            let hotspots = '';
            let educational = '';
            
            // Strategic Analysis
            const avgWorked = data.summary.totalWorked / Object.keys(data.agents).length;
            const topPerformer = Object.entries(data.agents).sort((a, b) => b[1].worked - a[1].worked)[0];
            const mostFociAgent = Object.entries(data.agents).sort((a, b) => b[1].foci - a[1].foci)[0];

            strategic += `<h3>Pontos Fortes</h3><p>A equipe demonstrou boa produtividade, com uma média de <strong>${avgWorked.toFixed(1)} imóveis trabalhados</strong> por agente no período analisado. Destaque para o(a) agente <strong>${topPerformer[0]}</strong>, que liderou em número de visitas com <strong>${topPerformer[1].worked}</strong> imóveis.</p>`;
            strategic += `<h3>Pontos de Atenção</h3><p>Um total de <strong>${data.summary.totalFoci} focos</strong> foram encontrados, o que exige atenção. O(A) agente <strong>${mostFociAgent[0]}</strong> foi quem mais identificou focos (${mostFociAgent[1].foci}), indicando que sua área de atuação pode ser crítica ou que possui grande habilidade em detecção.</p>`;
            strategic += `<h3>Recomendações</h3><ul><li>Realizar uma reunião com a equipe para parabenizar o bom desempenho geral e alinhar estratégias para as áreas com maior incidência de focos.</li><li>Intensificar as ações educativas nos bairros com maior número de focos, focando na eliminação de criadouros pelos próprios moradores.</li><li>Verificar se o(a) agente ${mostFociAgent[0]} necessita de apoio extra (material, pessoal) para lidar com a alta incidência em sua área.</li></ul>`;

            // Hotspot Analysis
            const sortedHotspots = Object.entries(data.hotspots).sort((a, b) => b[1] - a[1]);
            if (sortedHotspots.length > 0) {
                hotspots += `<p>A análise dos dados revela uma concentração de focos em bairros específicos. É crucial direcionar os esforços para essas localidades.</p>`;
                hotspots += `<h3>Bairros Críticos (Hotspots)</h3><ul>`;
                sortedHotspots.forEach(([bairro, focos]) => {
                    hotspots += `<li><strong>${bairro}:</strong> ${focos} foco(s) encontrado(s).</li>`;
                });
                hotspots += `</ul>`;
                hotspots += `<h3>Plano de Ação Sugerido</h3><p>Recomenda-se a organização de um <strong>mutirão de limpeza e conscientização</strong> no bairro <strong>${sortedHotspots[0][0]}</strong>, que apresentou o maior índice. Ações de bloqueio com aplicação de inseticida podem ser necessárias, conforme avaliação técnica em campo.</p>`;
            } else {
                hotspots += `<p><strong>Parabéns!</strong> Nenhum foco foi registrado nos relatórios analisados. Este é um excelente indicador do bom trabalho preventivo realizado pela equipe e da colaboração da comunidade. Continuem com a vigilância constante.</p>`;
            }
            
            // Educational Content
            educational += `<h3>Tópicos para Reforço com a Equipe</h3>`;
            educational += `<p>Com base nos dados, os seguintes temas podem ser úteis para uma capacitação rápida ou discussão em equipe:</p>`;
            educational += `<ul><li><strong>Técnicas de Abordagem em Recusas:</strong> Como argumentar e convencer moradores sobre a importância da vistoria para a saúde coletiva.</li>`;
            if (data.summary.totalFoci > 0) {
                educational += `<li><strong>Identificação de Criadouros Atípicos:</strong> Além dos depósitos óbvios, reforçar a busca em locais como calhas, ralos, bandejas de ar-condicionado e plantas que acumulam água (bromélias).</li>`;
            }
            educational += `<li><strong>Uso Correto do Larvicida:</strong> Revisar a dosagem e a aplicação correta do larvicida para garantir sua máxima eficácia e segurança.</li></ul>`;
            
            return { strategic, hotspots, educational };
        };

        initApp();
    });
    </script>
</body>
</html>
