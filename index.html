<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ACE FLOW - Agentes de Combate às Endemias</title>
    
    <!-- PWA (Progressive Web App) Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ACE FLOW">
    <link rel="apple-touch-icon" href="https://i.imgur.com/j5w2VvT.png">
    <meta name="theme-color" content="#F5F0E6">

    <!-- Dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- PWA MANIFEST ---
            const manifest = {
                "id": "/",
                "name": "ACE FLOW",
                "short_name": "ACE FLOW",
                "scope": ".",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#F5F0E6",
                "theme_color": "#4338CA",
                "description": "App para registro de trabalho de Agentes de Combate às Endemias.",
                "icons": [
                    { "src": "https://i.imgur.com/j5w2VvT.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
                    { "src": "https://i.imgur.com/j5w2VvT.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
                ]
            };
            const manifestString = JSON.stringify(manifest);
            const blob = new Blob([manifestString], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            const linkTag = document.createElement('link');
            linkTag.rel = 'manifest';
            linkTag.href = manifestURL;
            document.head.appendChild(linkTag);

            // --- SERVICE WORKER ---
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'ace-flow-cache-v55'; // Cache version bumped
                    const PRECACHE_ASSETS = [
                        '.',
                        'https://cdn.tailwindcss.com',
                        'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js',
                        'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js',
                        'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap',
                        'https://fonts.gstatic.com/s/inter/v13/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2',
                        'https://i.imgur.com/j5w2VvT.png'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => {
                                console.log('[Service Worker] Pré-cacheando recursos essenciais.');
                                return cache.addAll(PRECACHE_ASSETS);
                            }).catch(error => {
                                console.error('[Service Worker] Falha no pré-cache:', error);
                            })
                        );
                        self.skipWaiting();
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.filter(name => name !== CACHE_NAME).map(name => caches.delete(name))
                                );
                            }).then(() => self.clients.claim())
                        );
                    });

                    self.addEventListener('fetch', event => {
                        if (event.request.method !== 'GET' || event.request.url.startsWith('chrome-extension://')) {
                            return;
                        }

                        // Estratégia: Cache First, depois Network
                        event.respondWith(
                            caches.match(event.request).then(cachedResponse => {
                                if (cachedResponse) {
                                    return cachedResponse;
                                }

                                return fetch(event.request).then(networkResponse => {
                                    if (networkResponse && networkResponse.status === 200) {
                                        const responseToCache = networkResponse.clone();
                                        caches.open(CACHE_NAME).then(cache => {
                                            cache.put(event.request, responseToCache);
                                        });
                                    }
                                    return networkResponse;
                                });
                            })
                        );
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(swUrl)
                        .then(reg => console.log('ServiceWorker registrado com sucesso.', reg.scope))
                        .catch(err => console.log('Falha ao registrar ServiceWorker:', err));
                });
            }
        });
    </script>
    
    <!-- Estilos -->
    <style>
        :root {
            --bg-main: #F5F0E6; --bg-card: #FFFFFF; --text-dark: #000000;
            --text-muted: #575757; --border-color: #DED6C7; --alert-red: #DC2626;
            --confirm-green: #16A34A; --khaki-base: #C3B091; --khaki-dark: #a9997c;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-dark); }
        .card { background-color: var(--bg-card); border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid var(--border-color); }
        .section-title { font-weight: 700; font-size: 1.25rem; color: var(--text-dark); }
        .form-input, .form-select {
            width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 2px solid var(--border-color);
            background-color: var(--bg-card); transition: all 0.2s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--khaki-base); box-shadow: 0 0 0 3px rgba(195, 176, 145, 0.4);
        }
        .form-input.is-filled, .form-select.is-filled { border-color: var(--confirm-green); }
        .btn {
            padding: 0.8rem 1.25rem; border-radius: 0.5rem; font-weight: 700; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .hidden-content { display: none; overflow: hidden; transition: max-height 0.5s ease-in-out; max-height: 0; }
        .hidden-content.show { display: block; max-height: 1500px; }
        .toggle-check {
            width: 100%; height: 46px; font-weight: 700; font-size: 1.1rem; cursor: pointer;
            border: 2px solid var(--border-color); border-radius: 0.5rem; background-color: var(--bg-card);
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .toggle-check.tratado.is-checked { background-color: #dcfce7; color: var(--confirm-green); border-color: var(--confirm-green); }
        .toggle-check.foco.is-checked { background-color: #fee2e2; color: var(--alert-red); border-color: var(--alert-red); }
        #fixed-info-bar {
            position: sticky; top: 0; z-index: 40; transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .modal { 
            background-color: rgba(0, 0, 0, 0.7); 
            display: flex; 
            align-items: flex-start; 
            justify-content: center;
            padding-top: 5vh;
            padding-bottom: 5vh;
            overflow-y: auto;
        }
        option.important-value { font-weight: 700; background-color: #eeeeee; }
        
        /* Landing Page Remodel */
        #landingPage { 
            background: radial-gradient(circle, rgba(245,240,230,1) 0%, rgba(222,214,199,1) 100%);
            animation: fadeIn 1.5s ease-in-out; 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glow-text {
            background: linear-gradient(90deg, var(--khaki-dark), var(--text-dark), var(--khaki-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 10s linear infinite;
            background-size: 200% auto;
        }
        @keyframes glow { to { background-position: 200% center; } }
        .feature-card {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 30px rgba(0,0,0,0.15);
        }
        .fade-in-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-section.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--khaki-base);
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* FAQ/Curiosities Styles */
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.5rem;
        }
        .faq-answer.show {
            max-height: 1000px; /* Adjust as needed */
            padding: 1rem 1.5rem 1.5rem;
        }
        .faq-question.active .faq-toggle-icon {
            transform: rotate(45deg);
        }

        /* Shine/Pulse Animation for CTA */
        .btn-shine {
            position: relative;
            overflow: hidden;
        }
        .btn-shine::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(45deg);
            animation: pulse-shine 4s infinite linear;
        }
        @keyframes pulse-shine {
            0% { transform: scale(0.5) rotate(45deg); opacity: 0; }
            50% { transform: scale(1) rotate(45deg); opacity: 1; }
            100% { transform: scale(1.5) rotate(45deg); opacity: 0; }
        }

    </style>
</head>

<body class="antialiased">

    <!-- LANDING PAGE REMODELADA -->
    <div id="landingPage">
        <div class="container mx-auto px-4 py-16 md:py-24 text-center">
            <header class="mb-20">
                <h1 class="text-6xl md:text-8xl font-black tracking-tighter mb-4 glow-text">ACE FLOW</h1>
                <p class="max-w-3xl mx-auto text-xl md:text-2xl font-semibold text-text-muted">
                    Sua rotina de campo, reinventada. Foco no que importa, com a tecnologia como sua aliada.
                </p>
            </header>

            <div class="space-y-24">
                <section class="fade-in-section">
                    <h2 class="text-4xl font-extrabold mb-12">Inteligência de Dados para Ações Precisas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">📊</div>
                            <h3 class="text-xl font-bold mb-2">Relatórios Completos</h3>
                            <p class="text-text-muted">Transforme seus dados em insights visuais. Gere relatórios dinâmicos com gráficos intuitivos e analise sua produtividade através de filtros de tempo flexíveis, do trabalho diário ao desempenho anual.</p>
                        </div>
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">✨</div>
                            <h3 class="text-xl font-bold mb-2">Análise com IA</h3>
                            <p class="text-text-muted">Receba resumos e planos de ação gerados por Inteligência Artificial para otimizar suas visitas e focar em áreas de risco.</p>
                        </div>
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">📋</div>
                            <h3 class="text-xl font-bold mb-2">PDFs Profissionais</h3>
                            <p class="text-text-muted">Exporte seus dados em PDFs autoexplicativos e resumidos. Um formato profissional, pronto para arquivamento ou compartilhamento, que reflete a qualidade do seu trabalho.</p>
                        </div>
                    </div>
                </section>

                <section class="fade-in-section">
                     <h2 class="text-4xl font-extrabold mb-12">Ferramentas que Agilizam seu Dia a Dia</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="feature-card p-8">
                            <div class="text-5xl mb-4">✍️</div>
                            <h3 class="text-xl font-bold mb-2">Preenchimento Inteligente</h3>
                            <p class="text-text-muted">Deixe o app trabalhar por você. Nossa tecnologia de preenchimento inteligente antecipa seus próximos passos, replicando informações de forma automática e garantindo registros rápidos e consistentes.</p>
                        </div>
                         <div class="feature-card p-8">
                            <div class="text-5xl mb-4">💧</div>
                            <h3 class="text-xl font-bold mb-2">Cálculos Rápidos</h3>
                            <p class="text-text-muted">Calcule o volume de reservatórios e a sua meta diária de forma automática, ganhando tempo e precisão em campo.</p>
                        </div>
                        <div class="feature-card p-8">
                           <div class="text-5xl mb-4">📱</div>
                            <h3 class="text-xl font-bold mb-2">Experiência de App Real</h3>
                            <p class="text-text-muted">Instale no seu celular para uma experiência em tela cheia, sem a barra do navegador, com funcionamento 100% offline e sem perda de dados.</p>
                        </div>
                    </div>
                </section>

                <section class="fade-in-section">
                     <h2 class="text-4xl font-extrabold mb-12">Educação e Conhecimento na Palma da Mão</h2>
                    <div class="grid grid-cols-1">
                         <div class="feature-card p-8 max-w-2xl mx-auto">
                            <div class="text-5xl mb-4">💡</div>
                            <h3 class="text-xl font-bold mb-2">Guia de Curiosidades</h3>
                            <p class="text-text-muted">Domine o conhecimento. Acesse um guia completo que vai de dúvidas básicas a curiosidades avançadas sobre a Dengue e o Aedes. Uma ferramenta poderosa para sua capacitação e para orientar a população.</p>
                        </div>
                    </div>
                </section>
            </div>

            <footer class="mt-24 py-12 fade-in-section">
                <h2 class="text-4xl font-extrabold mb-4">Pronto para Elevar seu Nível?</h2>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mt-8">
                    <button id="startWebButton" class="btn btn-shine bg-indigo-700 text-white hover:bg-indigo-800 w-full md:w-auto text-xl py-4 px-8 shadow-lg transform hover:scale-105">Vamos lá? Clique aqui agora</button>
                    <button id="installAppButton" class="btn bg-black text-white hover:bg-gray-800 w-full md:w-auto text-lg hidden">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Instalar no Aparelho (Offline)
                    </button>
                </div>
                 <p id="install-instructions" class="text-sm text-text-muted mt-4 max-w-2xl mx-auto hidden">
                    Ao clicar em "Instalar", o app será adicionado à sua tela inicial, como um aplicativo normal, para acesso rápido e funcionamento offline.
                </p>
            </footer>
        </div>
    </div>
    
    <!-- BARRA DE INFORMAÇÃO FIXA -->
    <div id="fixed-info-bar" class="bg-white/80 backdrop-blur-sm p-2 text-center text-sm font-semibold hidden">
        <span id="fixed-agent-name"></span> - <span id="fixed-property-info"></span>
    </div>
    
    <!-- MODAL DE LOGIN -->
    <div id="loginModal" class="fixed inset-0 z-50 modal hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 max-w-sm card">
            <h2 class="text-2xl font-bold text-center mb-1">Bem-vindo ao</h2>
            <h1 class="text-4xl font-extrabold text-center mb-6">ACE FLOW</h1>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-text-muted mb-1">Usuário</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-text-muted mb-1">Senha</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="loginBtn" class="btn bg-blue-800 text-white hover:bg-blue-900 w-full text-lg transform hover:scale-105">Entrar</button>
                <p id="loginError" class="text-red-600 text-center mt-4 h-4"></p>
            </form>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL DO APP -->
    <main class="container mx-auto p-3 md:p-6 max-w-4xl hidden">
        <header class="text-center mb-8 py-4">
            <h1 class="text-5xl font-extrabold"><strong>ACE FLOW</strong></h1>
            <p class="text-lg font-bold">Agentes de Combate às Endemias</p>
            <p class="text-md"><em>Registre aqui a excelência do seu trabalho.</em></p>
        </header>
        
        <section class="card p-4 md:p-6 mb-6">
            <details id="goalModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    <div>
                        Meta Diária de Imóveis
                        <span class="text-sm font-normal italic text-text-muted">(calcule a quantidade ideal de imóveis por dia)</span>
                    </div>
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="totalImoveis" class="text-sm font-medium text-text-muted">Total de Imóveis</label>
                            <input type="number" id="totalImoveis" class="form-input mt-1" placeholder="Ex: 800">
                        </div>
                        <div>
                            <label for="cicloInicio" class="text-sm font-medium text-text-muted">Início do Ciclo</label>
                            <input type="date" id="cicloInicio" class="form-input mt-1">
                        </div>
                        <div>
                            <label for="cicloFim" class="text-sm font-medium text-text-muted">Fim do Ciclo</label>
                            <input type="date" id="cicloFim" class="form-input mt-1">
                        </div>
                    </div>
                    <button id="calculateGoalBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full">Calcular Meta</button>
                    <div id="goalResult" class="mt-4 text-center hidden">
                        <p class="text-lg">Meta diária: <strong id="dailyGoal" class="text-xl">0</strong> imóveis</p>
                        <div class="w-full bg-gray-200 rounded-full h-4 mt-2 border border-border-color">
                            <div id="dailyProgress" class="bg-confirm-green h-full rounded-full text-xs font-medium text-blue-100 text-center p-0.5 leading-none" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-sm text-text-muted mt-1">0/0</p>
                    </div>
                </div>
            </details>
        </section>
        
        <section class="card p-4 md:p-6 mb-6">
            <details id="volumeCalculatorModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    Calcule aqui o volume do reservatório em litros
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-y-4 gap-x-2">
                        <div class="space-y-1">
                            <label for="largura" class="text-sm font-medium text-text-muted">Largura</label>
                            <div class="flex gap-2">
                                <input type="number" id="largura" class="form-input" placeholder="0.0">
                                <select id="larguraUnidade" class="form-select w-auto">
                                    <option value="m">m</option>
                                    <option value="cm">cm</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label for="comprimento" class="text-sm font-medium text-text-muted">Comprimento</label>
                            <div class="flex gap-2">
                                <input type="number" id="comprimento" class="form-input" placeholder="0.0">
                                <select id="comprimentoUnidade" class="form-select w-auto">
                                    <option value="m">m</option>
                                    <option value="cm">cm</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label for="altura" class="text-sm font-medium text-text-muted">Altura/Prof.</label>
                            <div class="flex gap-2">
                                <input type="number" id="altura" class="form-input" placeholder="0.0">
                                <select id="alturaUnidade" class="form-select w-auto">
                                    <option value="m">m</option>
                                    <option value="cm">cm</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button id="calculateVolumeBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white w-full mt-4">Calcular</button>
                    <div id="volumeResult" class="mt-4 text-center hidden">
                        <div class="flex flex-col md:flex-row justify-around items-center p-4 bg-gray-50 rounded-lg space-y-4 md:space-y-0">
                            <div class="relative w-24 h-32 bg-gray-200 border-2 border-gray-400 rounded-lg overflow-hidden">
                                <div id="waterLevel" class="absolute bottom-0 w-full bg-blue-400" style="height: 0%; transition: height 1s ease-out;"></div>
                                <div id="volumeText" class="absolute inset-0 flex items-center justify-center text-black font-bold text-lg p-1"></div>
                            </div>
                            <div class="text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-500" viewBox="0 0 24 24" fill="currentColor"><path d="M20,6a8,8,0,0,0-7.3,8H3.34a1,1,0,0,0-.95,1.3l2,6A1,1,0,0,0,5.33,22h12a1,1,0,0,0,.95-.7l2-6A1,1,0,0,0,20.67,14h-3A8,8,0,0,0,20,6Z"/></svg>
                                <p id="spoonAmountText" class="font-bold text-lg"></p>
                            </div>
                            <div class="text-center">
                                <p class="text-4xl font-black" id="gramsAmountText"></p>
                                <p class="font-bold text-lg">gramas</p>
                            </div>
                        </div>
                        <button id="clearVolumeBtn" class="btn bg-red-700 hover:bg-red-800 text-white mt-4 text-sm">Limpar</button>
                    </div>
                </div>
            </details>
        </section>
        
        <section class="card p-4 md:p-6 mb-6">
            <details id="backupModule" class="group">
                <summary class="section-title cursor-pointer flex justify-between items-center">
                    Backup & Restauração
                    <span class="text-2xl font-bold text-khaki-base transition-transform duration-300 group-open:rotate-45">+</span>
                </summary>
                <div class="mt-4 border-t pt-4 flex flex-col md:flex-row gap-4">
                    <button id="backupBtn" class="btn bg-blue-700 hover:bg-blue-800 text-white flex-1">Faça Backup (para não perder seu histórico)</button>
                    <label for="restoreInput" class="btn bg-green-700 hover:bg-green-800 text-white flex-1">
                        Restaurar Backup
                    </label>
                    <input type="file" id="restoreInput" class="hidden" accept=".json">
                </div>
            </details>
        </section>

        <section class="card p-4 md:p-6 mb-6">
            <h2 class="section-title border-b border-border-color pb-3 mb-4">Informações do Dia</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="agente" class="text-sm font-medium text-text-muted">Agente</label>
                    <input type="text" id="agente" list="agent-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="bairro" class="text-sm font-medium text-text-muted">Bairro Principal</label>
                    <input type="text" id="bairro" list="bairro-suggestions" class="form-input mt-1" required>
                </div>
                <div>
                    <label for="ciclo" class="text-sm font-medium text-text-muted">Ciclo</label>
                    <select id="ciclo" class="form-select mt-1" required></select>
                </div>
                <div>
                    <label for="data" class="text-sm font-medium text-text-muted">Data</label>
                    <input type="date" id="data" class="form-input mt-1">
                </div>
            </div>
        </section>

        <section class="space-y-4">
            <h2 class="section-title text-center mt-8 mb-4">Registros de Visita</h2>
            <div id="visitasContainer" class="space-y-3"></div>
            <button id="addVisitaBtn" class="btn bg-black text-white hover:bg-gray-800 w-full text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Adicionar Imóvel
            </button>
        </section>
        
        <section class="card p-4 md:p-6 my-8">
            <h2 class="section-title border-b border-border-color pb-3 mb-4">Resumo Geral</h2>
            <div id="summarySection" class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-5"></div>
        </section>

        <footer class="grid grid-cols-2 gap-4 my-6">
            <button id="savePdfBtn" class="btn bg-green-800 hover:bg-green-900 text-white">Gerar PDF</button>
            <button id="reportBtn" class="btn bg-purple-900 hover:bg-purple-950 text-white">Gerar Relatório</button>
            <button id="aiAnalysisBtn" class="btn bg-blue-800 hover:bg-blue-900 text-white">Analisar Dia ✨</button>
            <button id="aiPlanBtn" class="btn bg-blue-800 hover:bg-blue-900 text-white">Planejar Amanhã ✨</button>
            <button id="myAreaBtn" class="btn bg-amber-800 hover:bg-amber-900 text-white">Minha Área</button>
            <button id="clearDayBtn" class="btn bg-red-700 hover:bg-red-800 text-white">Limpar Dia</button>
        </footer>
        
        <section class="my-8 text-center">
            <button id="curiositiesBtn" class="btn bg-teal-600 text-white hover:bg-teal-700 w-full text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                15 Curiosidades sobre a Dengue e o Aedes Aegypti
            </button>
            <div id="subButtonsContainer" class="hidden mt-4 space-y-3">
                 <p class="text-center text-text-muted max-w-2xl mx-auto">A informação correta é a nossa arma mais poderosa contra a dengue. Com o aumento dos casos, é vital que todos conheçam os detalhes sobre a doença, o mosquito transmissor e o papel crucial dos profissionais que estão na linha de frente deste combate.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="showDengueModalBtn" class="btn bg-orange-500 text-white hover:bg-orange-600 flex-1">Aprenda mais sobre a Dengue</button>
                    <button id="showAedesModalBtn" class="btn bg-gray-700 text-white hover:bg-gray-800 flex-1">Aprenda mais sobre o Aedes Aegypti</button>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 py-8 border-t-2 border-dashed border-border-color">
            <h2 class="text-4xl font-extrabold text-khaki-base glow-text">ACE FLOW</h2>
            <p class="text-text-muted mt-2">Obrigado por utilizar nossa ferramenta. Seu trabalho é fundamental para a saúde de todos.</p>
        </footer>
    </main>
    
    <!-- DATALISTS E MODAIS -->
    <datalist id="agent-suggestions"></datalist>
    <datalist id="bairro-suggestions"></datalist>
    <datalist id="street-suggestions"></datalist>

    <div id="confirmationModal" class="fixed inset-0 z-50 modal hidden">
        <div class="card p-6 w-11/12 max-w-sm text-center">
            <p id="modalMessage" class="text-lg mb-6">Tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="modalCancelBtn" class="btn bg-gray-300 hover:bg-gray-400 text-black">Cancelar</button>
                <button id="modalConfirmBtn" class="btn bg-red-600 hover:bg-red-700 text-white">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="reportModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-4 md:p-6 w-11/12 max-w-5xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="section-title">Relatório de Atividades</h2>
                <button id="closeReportModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div class="flex-grow overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 border-b pb-4">
                    <div>
                        <label class="font-semibold text-sm">Período</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                             <button data-period="day" class="btn-filter btn bg-slate-700 hover:bg-slate-800 text-white text-sm">Hoje</button>
                             <button data-period="week" class="btn-filter btn bg-slate-700 hover:bg-slate-800 text-white text-sm">Semana</button>
                             <button data-period="month" class="btn-filter btn bg-slate-700 hover:bg-slate-800 text-white text-sm">Mês</button>
                             <button data-period="year" class="btn-filter btn bg-slate-700 hover:bg-slate-800 text-white text-sm">Ano</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="reportCycleSelector" class="font-semibold text-sm">Ciclo</label>
                            <select id="reportCycleSelector" class="form-select mt-1"></select>
                        </div>
                        <div>
                            <label for="reportStreetSearch" class="font-semibold text-sm">Logradouro</label>
                            <input type="text" id="reportStreetSearch" class="form-input mt-1" placeholder="Pesquisar rua...">
                        </div>
                    </div>
                </div>
                <div id="reportContent" class="space-y-8">
                     <div id="no-report-data" class="text-center my-8 text-text-muted">
                        <p class="font-bold text-lg">Selecione um filtro para começar.</p>
                        <p>Nenhum dado encontrado no histórico.</p>
                    </div>
                    <div class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8" id="chartsContainer">
                        <div>
                            <h3 class="font-bold text-lg text-center mb-2">Visão Geral das Visitas</h3>
                            <div class="max-w-sm mx-auto"><canvas id="visitsChart"></canvas></div>
                        </div>
                         <div>
                            <h3 class="font-bold text-lg text-center mb-2">Produção Detalhada</h3>
                            <canvas id="productionChart"></canvas>
                        </div>
                        <div class="lg:col-span-2">
                            <h3 class="font-bold text-lg text-center mb-2">Atividade por Bairro</h3>
                            <canvas id="bairroChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <footer id="reportFooter" class="mt-6 pt-4 border-t flex justify-end gap-3 hidden">
                <button id="shareReportBtn" class="btn bg-sky-600 hover:bg-sky-700 text-white">Compartilhar</button>
                <button id="exportReportBtn" class="btn bg-emerald-600 hover:bg-emerald-700 text-white">Exportar p/ Planilha</button>
            </footer>
        </div>
    </div>
    
    <div id="aiModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-4 md:p-6 w-11/12 max-w-2xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 id="aiModalTitle" class="section-title">Análise da Inteligência Artificial</h2>
                <button id="closeAiModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div id="aiModalContent" class="flex-grow overflow-y-auto prose max-w-none prose-p:my-2 prose-headings:my-3">
            </div>
        </div>
    </div>
    
    <div id="sectorModal" class="fixed inset-0 z-50 modal hidden">
         <div class="card p-4 md:p-6 w-11/12 max-w-4xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="section-title">Minha Área de Atuação</h2>
                <button id="closeSectorModalBtn" class="text-3xl font-bold">&times;</button>
            </header>
            <div id="sectorModalContent" class="flex-grow overflow-y-auto">
            </div>
        </div>
    </div>

    <!-- MODAIS DE CURIOSIDADES -->
    <div id="dengueModal" class="fixed inset-0 z-50 modal hidden"></div>
    <div id="aedesModal" class="fixed inset-0 z-50 modal hidden"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- VARIÁVEIS GLOBAIS ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_M9m5XNbdgaMGXF69esRYPT-xBu5yVz4b6TqUrvy85Ipx_hVh4fQUqISwtFhoMkEW/exec'; 
        const { jsPDF } = window.jspdf;
        const Chart = window.Chart;
        const INITIAL_ROWS = 15;
        const CICLOS = ['1°', '2°', '3°', '4°', '5°', '6°', '7°', '8°', '9°', '10°'];
        const BRAZIL_HOLIDAYS_2025 = [
            '2025-01-01', '2025-03-03', '2025-03-04', '2025-04-18', '2025-04-21',
            '2025-05-01', '2025-06-19', '2025-09-07', '2025-10-12', '2025-11-02',
            '2025-11-15', '2025-11-20', '2025-12-25',
        ];
        
        let streetList = [], agentList = [], bairroList = [];
        let visitaCounter = 0;
        let confirmCallback = null;
        let dailyGoal = 0;
        let visitsChart, productionChart, bairroChart;
        let deferredInstallPrompt = null;
        let currentReportData = null; // Armazena dados do relatório atual para exportação

        // --- SELETORES DO DOM ---
        const landingPage = document.getElementById('landingPage');
        const startWebButton = document.getElementById('startWebButton');
        const installAppButton = document.getElementById('installAppButton');
        const installInstructions = document.getElementById('install-instructions');
        const mainContent = document.querySelector('main');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');
        const agenteInput = document.getElementById('agente');
        const bairroInput = document.getElementById('bairro');
        const cicloSelect = document.getElementById('ciclo');
        const dataInput = document.getElementById('data');
        const visitasContainer = document.getElementById('visitasContainer');
        const summarySection = document.getElementById('summarySection');
        const agentSuggestions = document.getElementById('agent-suggestions');
        const bairroSuggestions = document.getElementById('bairro-suggestions');
        const streetSuggestions = document.getElementById('street-suggestions');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const reportModal = document.getElementById('reportModal');
        const closeReportModalBtn = document.getElementById('closeReportModalBtn');
        const reportCycleSelector = document.getElementById('reportCycleSelector');
        const reportStreetSearch = document.getElementById('reportStreetSearch');
        const reportContent = document.getElementById('reportContent');
        const noReportData = document.getElementById('no-report-data');
        const chartsContainer = document.getElementById('chartsContainer');
        const reportFooter = document.getElementById('reportFooter');
        const shareReportBtn = document.getElementById('shareReportBtn');
        const exportReportBtn = document.getElementById('exportReportBtn');
        const fixedInfoBar = document.getElementById('fixed-info-bar');
        const fixedAgentName = document.getElementById('fixed-agent-name');
        const fixedPropertyInfo = document.getElementById('fixed-property-info');
        const totalImoveisInput = document.getElementById('totalImoveis');
        const cicloInicioInput = document.getElementById('cicloInicio');
        const cicloFimInput = document.getElementById('cicloFim');
        const calculateGoalBtn = document.getElementById('calculateGoalBtn');
        const goalResultDiv = document.getElementById('goalResult');
        const dailyGoalEl = document.getElementById('dailyGoal');
        const dailyProgressEl = document.getElementById('dailyProgress');
        const progressTextEl = document.getElementById('progressText');
        const aiAnalysisBtn = document.getElementById('aiAnalysisBtn');
        const aiPlanBtn = document.getElementById('aiPlanBtn');
        const aiModal = document.getElementById('aiModal');
        const aiModalTitle = document.getElementById('aiModalTitle');
        const aiModalContent = document.getElementById('aiModalContent');
        const closeAiModalBtn = document.getElementById('closeAiModalBtn');
        const calculateVolumeBtn = document.getElementById('calculateVolumeBtn');
        const clearVolumeBtn = document.getElementById('clearVolumeBtn');
        const volumeResultDiv = document.getElementById('volumeResult');
        const volumeTextEl = document.getElementById('volumeText');
        const spoonAmountTextEl = document.getElementById('spoonAmountText');
        const gramsAmountTextEl = document.getElementById('gramsAmountText');
        const larguraInput = document.getElementById('largura');
        const comprimentoInput = document.getElementById('comprimento');
        const alturaInput = document.getElementById('altura');
        // Seletores da Minha Área
        const myAreaBtn = document.getElementById('myAreaBtn');
        const sectorModal = document.getElementById('sectorModal');
        const sectorModalContent = document.getElementById('sectorModalContent');
        const closeSectorModalBtn = document.getElementById('closeSectorModalBtn');
        // Seletores de Backup/Restauração
        const backupBtn = document.getElementById('backupBtn');
        const restoreInput = document.getElementById('restoreInput');
        // Seletores de Curiosidades
        const curiositiesBtn = document.getElementById('curiositiesBtn');
        const subButtonsContainer = document.getElementById('subButtonsContainer');
        const showDengueModalBtn = document.getElementById('showDengueModalBtn');
        const showAedesModalBtn = document.getElementById('showAedesModalBtn');
        const dengueModal = document.getElementById('dengueModal');
        const aedesModal = document.getElementById('aedesModal');

        // --- LÓGICA DA LANDING PAGE E PWA ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            installAppButton.classList.remove('hidden');
            installInstructions.classList.remove('hidden');
        });

        const showApp = () => {
            landingPage.style.display = 'none';
            loginModal.classList.remove('hidden');
            loginModal.classList.add('flex');
        };
        
        startWebButton.addEventListener('click', showApp);

        installAppButton.addEventListener('click', () => {
            if (deferredInstallPrompt) {
                deferredInstallPrompt.prompt();
                deferredInstallPrompt.userChoice.then((choiceResult) => {
                    deferredInstallPrompt = null;
                });
            } else {
                showApp();
            }
        });

        // --- FUNÇÕES DE UTILIDADE ---
        const toTitleCase = (str) => {
            if (!str) return '';
            const lower = ['de', 'da', 'do', 'dos', 'das', 'e'];
            return str.replace(/\w\S*/g, (txt, offset) => {
                const word = txt.toLowerCase();
                if (offset > 0 && lower.includes(word)) {
                    return word;
                }
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        };

        const corrigirOrtografia = (str) => {
            if (!str) return '';
            const correcoes = {
                'sao': 'São', 'sebastiao': 'Sebastião', 'jose': 'José',
                'joao': 'João', 'conceicao': 'Conceição', 'vitoria': 'Vitória',
                'praca': 'Praça', 'acude': 'Açude', 'antonio': 'Antônio',
                'maria': 'Maria', 'francisco': 'Francisco', 'francisca': 'Francisca',
                'luiz': 'Luiz', 'gonzaga': 'Gonzaga', 'pereira': 'Pereira',
                'silva': 'Silva', 'souza': 'Souza', 'santos': 'Santos',
                'oliveira': 'Oliveira', 'tv': 'Tv', 'av': 'Av', 'r': 'Rua',
                'trav': 'Travessa', 'sen': 'Senador'
            };
            let correctedStr = str;
            Object.keys(correcoes).forEach(key => {
                const regex = new RegExp(`\\b${key}\\b`, 'gi');
                correctedStr = correctedStr.replace(regex, correcoes[key]);
            });
            return correctedStr;
        };
        
        const formatAndCorrectText = (str) => {
            return toTitleCase(corrigirOrtografia(str));
        }

        // --- TEMPLATES HTML ---
        const createVisitaCardHTML = (index) => `
            <div class="card visita-card" data-index="${index}">
                <header class="flex items-center justify-between p-3 cursor-pointer card-header group" data-toggle="card-content-${index}">
                    <div class="flex items-center min-w-0 flex-1">
                        <span class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full bg-bg-card border-2 border-khaki-base text-khaki-base font-bold mr-3">${index + 1}</span>
                        <div class="min-w-0 flex-grow">
                            <span class="logradouro-preview font-semibold truncate block">Novo Imóvel</span>
                            <div class="status-indicator text-sm font-semibold text-alert-red">Falta Preencher</div>
                        </div>
                    </div>
                    <span class="toggle-icon text-3xl font-bold text-khaki-base transition-transform duration-300 group-data-[expanded=true]:rotate-45">+</span>
                </header>
                <div id="card-content-${index}" class="hidden-content">
                    <div class="p-4 border-t border-border-color space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-bold text-text-muted">Bairro</label>
                                <input type="text" list="bairro-suggestions" class="form-input bairro-imovel mt-1" placeholder="Bairro do Imóvel">
                            </div>
                             <div>
                                <label class="text-sm font-bold text-text-muted">Logradouro/Rua</label>
                                <input type="text" list="street-suggestions" class="form-input logradouro mt-1" placeholder="Ex: Rua João da Silva">
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-x-3">
                            <div><label class="text-sm font-bold text-text-muted">Quarteirão</label><input type="number" class="form-input quarteirao mt-1 text-center"></div>
                            <div><label class="text-sm font-bold text-text-muted">Lado</label><select class="form-select lado mt-1" required><option value="" disabled selected></option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
                            <div><label class="text-sm font-bold text-text-muted">Nº</label><input type="text" inputmode="numeric" class="form-input numero mt-1 text-center is-filled" value="S/N" onfocus="if(this.value === 'S/N') this.value=''" onblur="if(this.value.trim() === '') this.value='S/N'"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-3">
                            <div><label class="text-sm font-bold text-text-muted">Imóvel</label><select class="form-select imovel mt-1" required><option value="" disabled selected></option><option value="R">Residência</option><option value="C">Comércio</option><option value="TB">Terreno Baldio</option><option value="O">Outro</option></select></div>
                            <div><label class="text-sm font-bold text-text-muted">Visita</label><select class="form-select visita mt-1" required><option value="" disabled selected></option><option value="T">Trabalhado</option><option value="P">Recuperado</option><option value="F">Fechado</option><option value="R">Recusado</option></select></div>
                        </div>
                        <div class="border-t border-border-color pt-4 mt-4">
                            <p class="text-center text-sm font-bold text-text-muted mb-2">Resultados</p>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="text-center"><label class="text-xs font-medium">Elim.</label><input type="number" min="0" class="form-input elim mt-1 text-center" placeholder="0"></div>
                                <div class="text-center"><label class="text-xs font-medium">Trat.</label><button type="button" class="toggle-check tratado mt-1"></button></div>
                                <div class="text-center"><label class="text-xs font-medium">Larvicida</label><select class="form-select gram mt-1 text-center"></select></div>
                                <div class="text-center"><label class="text-xs font-medium">Dep.</label><input type="number" min="0" class="form-input dep mt-1 text-center" placeholder="0"></div>
                                <div class="text-center"><label class="text-xs font-medium">Foco</label><button type="button" class="toggle-check foco mt-1"></button></div>
                                <div class="text-center"><label class="text-xs font-medium">Horário</label><input type="time" class="form-input horario mt-1 text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // --- FUNÇÕES PRINCIPAIS ---
        const showModal = (message, cb) => {
            modalMessage.textContent = message;
            confirmCallback = cb;
            confirmationModal.classList.remove('hidden');
        };

        const hideModal = () => {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        };

        const updateToggleHTML = (button) => {
            const isChecked = button.classList.contains('is-checked');
            if (button.matches('.foco')) button.innerHTML = isChecked ? 'X' : '';
            else if (button.matches('.tratado')) button.innerHTML = isChecked ? '✅' : '';
        };

        const populateSelects = () => {
            cicloSelect.innerHTML = `<option value="" disabled selected></option>` + CICLOS.map(c => `<option value="${c}">${c}</option>`).join('');
        };
        
        const populateGramasSelect = (selectElement) => {
            const importantValues = ['0.8', '1.6', '3.2', '6.4', '7.2', '9.6', '12.8'];
            let gramasHTML = '<option value="0.0">0.0</option>';
            for (let i = 0.4; i <= 60.0; i = parseFloat((i + 0.4).toFixed(1))) {
                const val = i.toFixed(1);
                const isImportant = importantValues.includes(val);
                gramasHTML += `<option value="${val}" ${isImportant ? 'class="important-value"' : ''}>${val}</option>`;
            }
            selectElement.innerHTML = gramasHTML;
        };
        
        const addVisitaCard = () => {
            const cardHTML = createVisitaCardHTML(visitaCounter);
            visitasContainer.insertAdjacentHTML('beforeend', cardHTML);
            const newCard = visitasContainer.lastElementChild;
            populateGramasSelect(newCard.querySelector('.gram'));
            if (visitaCounter === 0) newCard.querySelector('.bairro-imovel').focus();
            
            const prevCard = visitaCounter > 0 ? visitasContainer.children[visitaCounter - 1] : null;
            const bairroHeader = bairroInput.value;
            
            newCard.querySelector('.bairro-imovel').value = prevCard ? prevCard.querySelector('.bairro-imovel').value : bairroHeader;
            newCard.querySelector('.logradouro').value = prevCard ? prevCard.querySelector('.logradouro').value : '';
            newCard.querySelector('.quarteirao').value = prevCard ? prevCard.querySelector('.quarteirao').value : '';
            newCard.querySelector('.lado').value = prevCard ? prevCard.querySelector('.lado').value : '';

            // Set fields as filled if they have a value from replication
            ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado', '.numero'].forEach(sel => {
                const input = newCard.querySelector(sel);
                if (input.value) {
                    input.classList.add('is-filled');
                }
            });

            updateCardStatus(newCard);
            visitaCounter++;
        };
        
        const updateCardStatus = (cardElement) => {
            const quarteirao = cardElement.querySelector('.quarteirao').value.trim();
            const logradouro = cardElement.querySelector('.logradouro').value.trim();
            const numero = cardElement.querySelector('.numero').value.trim() || 'S/N';
            const preview = cardElement.querySelector('.logradouro-preview');

            const quarteiraoPart = quarteirao ? `Quart. ${quarteirao}` : '';
            const logradouroPart = logradouro ? `${logradouro}, ${numero}` : '';
            const fullPreviewText = [quarteiraoPart, logradouroPart].filter(Boolean).join(' - ');
            
            preview.textContent = fullPreviewText || 'Novo Imóvel';

            const requiredSelectors = ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado', '.numero', '.imovel', '.visita'];
            const statusIndicator = cardElement.querySelector('.status-indicator');
            const horarioInput = cardElement.querySelector('.horario');
            
            let filledCount = 0;
            let hasManualInput = false;
            requiredSelectors.forEach(sel => {
                const input = cardElement.querySelector(sel);
                if (input.value.trim() !== '') {
                   filledCount++;
                }
                if (input.dataset.manualInput === 'true') {
                   hasManualInput = true;
                }
            });

            statusIndicator.classList.remove('text-alert-red', 'text-orange-500', 'text-confirm-green');
            const isFullyFilled = filledCount >= requiredSelectors.length;
            
            if (isFullyFilled) {
                statusIndicator.textContent = '✅ Preenchido';
                statusIndicator.classList.add('text-confirm-green');
                if (!horarioInput.value) {
                     horarioInput.value = new Date().toTimeString().slice(0, 5);
                     horarioInput.classList.add('is-filled');
                }
            } else if (hasManualInput) {
                statusIndicator.textContent = 'Em Preenchimento...';
                statusIndicator.classList.add('text-orange-500'); 
            } else {
                statusIndicator.textContent = 'Falta Preencher';
                statusIndicator.classList.add('text-alert-red');
            }
        };

        const getSummaryData = () => {
            const allCards = document.querySelectorAll('.visita-card');
            const filledCards = [...allCards].filter(card => ['.logradouro', '.quarteirao', '.lado', '.imovel', '.visita'].every(sel => card.querySelector(sel).value.trim() !== ''));
            
            let summary = { recuperado: 0, fechado: 0, recusado: 0, eliminados: 0, depositosTratados: 0, tratamentoFocal: 0, larvicidaGramas: 0, focos: 0 };
            let trabalhadosSummary = { total: 0, residencia: 0, comercio: 0, terrenoBaldio: 0, outro: 0 };
            const quarteiroesSet = new Set();

            filledCards.forEach(card => {
                const imovel = card.querySelector('.imovel').value;
                const visita = card.querySelector('.visita').value;
                const quarteiraoValue = card.querySelector('.quarteirao').value.trim();

                if (quarteiraoValue && !isNaN(parseInt(quarteiraoValue))) {
                    quarteiroesSet.add(parseInt(quarteiraoValue));
                }
                
                // ATUALIZAÇÃO: Imóveis recuperados (P) agora contam como trabalhados.
                if (visita === 'T' || visita === 'P') { 
                    trabalhadosSummary.total++;
                    if (imovel === 'R') trabalhadosSummary.residencia++;
                    else if (imovel === 'C') trabalhadosSummary.comercio++;
                    else if (imovel === 'TB') trabalhadosSummary.terrenoBaldio++;
                    else if (imovel === 'O') trabalhadosSummary.outro++;
                }
                
                // Mantém a contagem separada para o resumo de pendências
                if (visita === 'P') { summary.recuperado++; }
                else if (visita === 'F') { summary.fechado++; }
                else if (visita === 'R') { summary.recusado++; }

                summary.eliminados += parseInt(card.querySelector('.elim').value) || 0;
                summary.depositosTratados += parseInt(card.querySelector('.dep').value) || 0;
                if (card.querySelector('.tratado').classList.contains('is-checked')) summary.tratamentoFocal++;
                summary.larvicidaGramas += parseFloat(card.querySelector('.gram').value) || 0;
                if (card.querySelector('.foco').classList.contains('is-checked')) summary.focos++;
            });

            const quarteiroesTrabalhados = quarteiroesSet.size;
            let quarteiroesConcluidos = 0;
            if (quarteiroesSet.size > 1) {
                const maxQuarteirao = Math.max(...quarteiroesSet);
                quarteiroesConcluidos = [...quarteiroesSet].filter(q => q < maxQuarteirao).length;
            }
            
            return {
                trabalhados: trabalhadosSummary,
                geral: summary,
                quarteiroes: {
                    trabalhados: quarteiroesTrabalhados,
                    concluidos: quarteiroesConcluidos
                }
            };
        };

        const renderSummary = (summaryData) => {
            const { trabalhados, geral, quarteiroes } = summaryData;

            if(dailyGoal > 0){
                const progress = Math.min((trabalhados.total / dailyGoal) * 100, 100);
                dailyProgressEl.style.width = `${progress}%`;
                progressTextEl.textContent = `${trabalhados.total} / ${dailyGoal}`;
            }

            summarySection.innerHTML = `
                <div class="col-span-full text-center border-b border-border-color pb-3 mb-4">
                    <h3 class="font-semibold text-text-muted">Detalhes dos Imóveis Trabalhados</h3>
                </div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.residencia}</p><p class="text-sm text-text-muted">Residências</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.comercio}</p><p class="text-sm text-text-muted">Comércios</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.terrenoBaldio}</p><p class="text-sm text-text-muted">Ter. Baldios</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${trabalhados.outro}</p><p class="text-sm text-text-muted">Outros</p></div>
                <div class="p-3 text-center col-span-full font-bold text-lg bg-gray-100 rounded-lg summary-item"><p>${trabalhados.total}</p><p class="text-sm font-normal text-text-muted">Total Trabalhados</p></div>

                <div class="col-span-full text-center border-t border-border-color pt-4 mt-4 pb-3 mb-4">
                    <h3 class="font-semibold text-text-muted">Resumo Geral da Produção</h3>
                </div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.tratamentoFocal}</p><p class="text-sm text-text-muted">Trat. Focal</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.larvicidaGramas.toFixed(1)}g</p><p class="text-sm text-text-muted">Larvicida</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.depositosTratados}</p><p class="text-sm text-text-muted">Dep. Tratados</p></div>
                <div class="p-3 text-center col-span-1 summary-item"><p class="font-bold text-2xl">${geral.eliminados}</p><p class="text-sm text-text-muted">Eliminados</p></div>
                <div class="p-3 text-center col-span-full text-red-600 font-bold text-2xl">${geral.focos} <span class="text-sm text-red-600">Total de Focos</span></div>
                
                <div class="col-span-full flex justify-center flex-wrap gap-4">
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.recusado}</p><p class="text-sm text-text-muted">Recusados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.fechado}</p><p class="text-sm text-text-muted">Fechados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${geral.recuperado}</p><p class="text-sm text-text-muted">Recuperados</p></div>
                </div>

                <div class="col-span-full flex justify-center gap-4">
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${quarteiroes.trabalhados}</p><p class="text-sm text-text-muted">Quarteirões Trabalhados</p></div>
                     <div class="p-3 text-center"><p class="font-bold text-2xl">${quarteiroes.concluidos}</p><p class="text-sm text-text-muted">Quarteirões Concluídos</p></div>
                </div>
            `;
        };
        
        const updateAndRenderSummary = () => {
            const summaryData = getSummaryData();
            renderSummary(summaryData);
        };

        const calculateWorkingDays = (startDate, endDate) => {
            let count = 0;
            const curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getUTCDay();
                const dateString = curDate.toISOString().slice(0, 10);
                if (dayOfWeek !== 0 && dayOfWeek !== 6 && !BRAZIL_HOLIDAYS_2025.includes(dateString)) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        };

        const handleGoalCalculation = () => {
            const totalImoveis = parseInt(totalImoveisInput.value);
            const inicio = cicloInicioInput.value;
            const fim = cicloFimInput.value;
            if (totalImoveis > 0 && inicio && fim) {
                const workingDays = calculateWorkingDays(new Date(inicio + 'T00:00:00'), new Date(fim + 'T00:00:00'));
                if(workingDays > 0) {
                    dailyGoal = Math.ceil(totalImoveis / workingDays);
                    dailyGoalEl.textContent = dailyGoal;
                    goalResultDiv.classList.remove('hidden');
                    updateAndRenderSummary();
                    localStorage.setItem('aceFlowGoalData', JSON.stringify({ totalImoveis, inicio, fim, dailyGoal }));
                } else { alert("O período selecionado não contém dias úteis."); }
            } else { alert("Por favor, preencha todos os campos do setor."); }
        };

        const loadGoalData = () => {
            const goalData = JSON.parse(localStorage.getItem('aceFlowGoalData'));
            if (goalData) {
                totalImoveisInput.value = goalData.totalImoveis;
                cicloInicioInput.value = goalData.inicio;
                cicloFimInput.value = goalData.fim;
                dailyGoal = goalData.dailyGoal;
                dailyGoalEl.textContent = dailyGoal;
                goalResultDiv.classList.remove('hidden');
                document.getElementById('goalModule').open = true;
            }
        };

        const saveData = () => {
             const data = {
                 header: { agente: agenteInput.value, bairro: bairroInput.value, ciclo: cicloSelect.value, data: dataInput.value },
                 visits: []
             };
             document.querySelectorAll('.visita-card').forEach(card => {
                 data.visits.push({
                     bairro: card.querySelector('.bairro-imovel').value,
                     logradouro: card.querySelector('.logradouro').value, 
                     quarteirao: card.querySelector('.quarteirao').value,
                     lado: card.querySelector('.lado').value, 
                     numero: card.querySelector('.numero').value,
                     imovel: card.querySelector('.imovel').value, 
                     visita: card.querySelector('.visita').value,
                     elim: card.querySelector('.elim').value, 
                     trat: card.querySelector('.tratado').classList.contains('is-checked'),
                     gram: card.querySelector('.gram').value, 
                     dep: card.querySelector('.dep').value,
                     foco: card.querySelector('.foco').classList.contains('is-checked'),
                     horario: card.querySelector('.horario').value,
                     isExpanded: card.querySelector('.card-header').getAttribute('data-expanded') === 'true'
                 });
             });
             localStorage.setItem('aceFlowDailyData', JSON.stringify(data));
        };
        
        const loadData = () => {
            const data = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            visitasContainer.innerHTML = '';
            visitaCounter = 0;
            const rowsToCreate = (data && data.visits.length > INITIAL_ROWS) ? data.visits.length : INITIAL_ROWS;
            for(let i = 0; i < rowsToCreate; i++) addVisitaCard();
            if (!data) return;
            agenteInput.value = data.header.agente || agenteInput.value;
            bairroInput.value = data.header.bairro || '';
            cicloSelect.value = data.header.ciclo || '';
            dataInput.value = data.header.data || new Date().toISOString().slice(0, 10);
            [agenteInput, bairroInput, cicloSelect, dataInput].forEach(el => { if(el.value) el.classList.add('is-filled'); });
            data.visits.forEach((visitData, index) => {
                const card = visitasContainer.children[index];
                if (!card) return;
                Object.keys(visitData).forEach(key => {
                    const selector = key === 'bairro' ? '.bairro-imovel' : `.${key}`;
                    const el = card.querySelector(selector);
                    if (el) {
                        if (el.classList.contains('toggle-check')) { if(visitData[key]) el.classList.add('is-checked');}
                        else { el.value = visitData[key]; }
                    }
                });
                updateToggleHTML(card.querySelector('.foco'));
                updateToggleHTML(card.querySelector('.tratado'));
                if (visitData.isExpanded === "true") {
                    const header = card.querySelector('.card-header');
                    header.setAttribute('data-expanded', 'true');
                    header.nextElementSibling.classList.add('show');
                }
                updateCardStatus(card);
            });
        };
        
        const generatePDF = () => {
            const doc = new jsPDF();
            const data = JSON.parse(localStorage.getItem('aceFlowDailyData'));
            if (!data) return;

            const filledVisits = data.visits.filter(v => 
                v.logradouro && v.quarteirao && v.numero && v.lado && v.imovel && v.visita
            );

            if (filledVisits.length === 0) {
                alert("Nenhum imóvel totalmente preenchido para gerar o PDF.");
                return;
            }

            const { agente, bairro, ciclo, data: workDate } = data.header;
            const dateFormatted = new Date(workDate + 'T12:00:00').toLocaleDateString('pt-BR');
            
            // --- PDF STYLING ---
            const primaryColor = '#111827'; // Azul escuro quase preto
            const bodyTextColor = '#374151';
            const headerFooterColor = '#9CA3AF';

            doc.setFont('helvetica', 'normal');

            // Cabeçalho do PDF
            doc.setFillColor(primaryColor);
            doc.rect(0, 0, 210, 25, 'F');
            doc.setFontSize(22);
            doc.setTextColor('#FFFFFF');
            doc.setFont('helvetica', 'bold');
            doc.text("ACE FLOW", 15, 17);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Relatório de Atividades Diárias", 105, 17, { align: 'center' });


            // Informações do Agente
            doc.autoTable({
                startY: 30,
                theme: 'plain',
                body: [
                    [{content: 'Agente:', styles: {fontStyle: 'bold', textColor: primaryColor}}, agente],
                    [{content: 'Data:', styles: {fontStyle: 'bold', textColor: primaryColor}}, dateFormatted],
                    [{content: 'Bairro Principal:', styles: {fontStyle: 'bold', textColor: primaryColor}}, bairro],
                    [{content: 'Ciclo:', styles: {fontStyle: 'bold', textColor: primaryColor}}, ciclo]
                ],
                styles: { fontSize: 16 }
            });
            
            const summaryData = getSummaryData();
            const { trabalhados, geral, quarteiroes } = summaryData;
            
            const detalhesData = [
                ['Residências', trabalhados.residencia], ['Comércios', trabalhados.comercio],
                ['Ter. Baldios', trabalhados.terrenoBaldio], ['Outros', trabalhados.outro],
                [{content: 'Total Trabalhados', styles: {fontStyle: 'bold'}}, {content: trabalhados.total, styles: {fontStyle: 'bold'}}]
            ];
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 8,
                head: [['Detalhes dos Imóveis Trabalhados', 'Total']],
                body: detalhesData,
                headStyles: { fillColor: primaryColor, fontSize: 16 },
                styles: { fontSize: 16, cellPadding: 3 },
                didDrawPage: (data) => { // Rodapé
                     doc.setFontSize(8);
                     doc.setTextColor(headerFooterColor);
                     doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, 287);
                }
            });

            const producaoData = [
                ['Tratamento Focal', geral.tratamentoFocal],
                ['Quantidade de Larvicida', `${geral.larvicidaGramas.toFixed(1)}g`],
                ['Depósitos Tratados', geral.depositosTratados],
                ['Eliminados', geral.eliminados],
                ['Quarteirões Trabalhados', quarteiroes.trabalhados],
                ['Quarteirões Concluídos', quarteiroes.concluidos],
                ['Total de Focos', geral.focos],
                ['Recusados', geral.recusado],
                ['Fechados', geral.fechado],
                ['Recuperados', geral.recuperado]
            ];
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['Resumo Geral da Produção', 'Total']],
                body: producaoData,
                headStyles: { fillColor: primaryColor, fontSize: 16 },
                styles: { fontSize: 16, cellPadding: 3 },
                willDrawCell: function(data) {
                    const boldLabels = [
                        'Tratamento Focal', 'Quantidade de Larvicida', 'Depósitos Tratados', 
                        'Eliminados', 'Quarteirões Trabalhados', 'Quarteirões Concluídos'
                    ];
                    if (data.section === 'body') {
                         if (boldLabels.includes(data.cell.text[0])) {
                            data.cell.styles.fontStyle = 'bold';
                            if (data.row.cells[1]) {
                                data.row.cells[1].styles.fontStyle = 'bold';
                            }
                        }
                        if (data.cell.text[0] === 'Total de Focos') {
                            data.cell.styles.textColor = '#e74c3c';
                            data.cell.styles.fontStyle = 'bold';
                            if (data.row.cells[1]) {
                                data.row.cells[1].styles.textColor = '#e74c3c';
                                data.row.cells[1].styles.fontStyle = 'bold';
                            }
                        }
                    }
                },
                didDrawPage: (data) => { // Rodapé
                     doc.setFontSize(8);
                     doc.setTextColor(headerFooterColor);
                     doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, 287);
                }
            });
            
            const visitaMap = { T: 'Trab.', P: 'Recuperado', F: 'Fechado', R: 'Recusado' };
            const visitData = filledVisits.map((v, i) => [
                i + 1, v.bairro, v.logradouro, v.quarteirao, v.numero, visitaMap[v.visita] || v.visita, v.horario || ''
            ]);
            doc.autoTable({
                head: [['#', 'Bairro', 'Logradouro', 'Quarteirão', 'Número', 'Visita', 'Horário']], body: visitData,
                startY: doc.lastAutoTable.finalY + 10,
                headStyles: { fillColor: '#6B7280', fontSize: 16 },
                styles: { fontSize: 16 },
                didDrawPage: (data) => { // Rodapé
                     doc.setFontSize(8);
                     doc.setTextColor(headerFooterColor);
                     doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, 287);
                }
            });
            
            doc.save(`ACE_FLOW_${agente.split(' ')[0]}_${workDate}.pdf`);
        };
        
        const updateAutocomplete = (type, value) => {
            let list, datalist;
            if (type === 'agent') { list = agentList; datalist = agentSuggestions; } 
            else if (type === 'bairro') { list = bairroList; datalist = bairroSuggestions; } 
            else { list = streetList; datalist = streetSuggestions; }
            const trimmedValue = value.trim();
            if (trimmedValue && !list.includes(trimmedValue)) {
                list.push(trimmedValue);
                datalist.innerHTML = list.map(item => `<option value="${item}"></option>`).join('');
                localStorage.setItem(`aceFlow${type}List`, JSON.stringify(list));
            }
        };
        
        const callAiAPI = async (prompt) => {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody.error.message}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Resposta da API de IA com estrutura inesperada:", result);
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        return `O conteúdo não pôde ser gerado. Motivo: ${result.promptFeedback.blockReason}`;
                    }
                    return "Não foi possível obter uma resposta da IA. A estrutura da resposta estava vazia.";
                }
            } catch (error) {
                console.error("Erro ao chamar a API de IA:", error);
                return `Erro de comunicação com a IA. Por favor, verifique sua conexão com a internet. Detalhes: ${error.message}`;
            }
        };
        
        const handleAiAnalysis = async () => {
            aiModalTitle.textContent = "Análise Inteligente do Dia";
            aiModalContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
            aiModal.classList.remove('hidden');

            const summaryData = getSummaryData();
            const prompt = `
                Você é um analista de dados e supervisor de uma equipe de Agentes de Combate às Endemias. Com base nos dados do dia de trabalho de um agente, escreva um resumo narrativo em 2 ou 3 parágrafos. Destaque as conquistas (como número de imóveis trabalhados e quarteirões concluídos), aponte áreas que precisam de atenção (como focos encontrados, recusas ou imóveis fechados) e termine com uma nota positiva e encorajadora. Seja profissional, mas também humano. Formate a resposta usando Markdown (títulos, negrito, etc.).

                Dados do dia:
                ${JSON.stringify(summaryData, null, 2)}
            `;
            const result = await callAiAPI(prompt);
            aiModalContent.innerHTML = result.replace(/\n/g, '<br>');
        };
        
        const handleAiPlanning = async () => {
            aiModalTitle.textContent = "Plano Estratégico para Amanhã";
            aiModalContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
            aiModal.classList.remove('hidden');

            const visitData = JSON.parse(localStorage.getItem('aceFlowDailyData'))?.visits || [];
            const filledVisits = visitData.filter(v => v.logradouro && v.visita);
            
            if (filledVisits.length === 0) {
                aiModalContent.innerHTML = "<p>Não há dados de visitas suficientes para gerar um plano. Por favor, preencha alguns imóveis primeiro.</p>";
                return;
            }

            const prompt = `
                Você é um epidemiologista e planejador estratégico para equipes de saúde pública, especializado no combate ao Aedes aegypti. Sua missão é analisar os dados de visitas de um Agente de Combate às Endemias e criar um plano de ação estratégico para o próximo dia de trabalho, focando nas áreas de maior risco para a proliferação do vetor.

                Com base nos dados fornecidos (que podem representar um ou vários dias de trabalho), sua análise deve ir além do óbvio e identificar:
                1.  **Hotspots de Foco:** Quais ruas ou quarteirões apresentam uma concentração de focos positivos ('foco: true')? Estas são as áreas de prioridade máxima.
                2.  **Padrões de Tratamento:** Quais áreas exigiram mais tratamentos focais ('trat: true')? Isso pode indicar uma alta densidade de depósitos que, mesmo sem larvas, representam um risco iminente.
                3.  **Áreas com Pendências Críticas:** Quais ruas têm uma combinação de imóveis fechados ('F') e focos próximos? A recuperação desses imóveis é crucial.

                Com base nessa análise, crie um plano de ação em tópicos (bullet points) usando Markdown. O plano deve ser prático e direcionado:
                -   **Prioridade 1 (Alerta Vermelho):** Indique as ruas/quarteirões com focos e recomende uma varredura intensiva nos imóveis vizinhos para conter a proliferação.
                -   **Prioridade 2 (Atenção):** Liste as áreas com muitos tratamentos ou imóveis fechados próximos a focos, sugerindo horários alternativos para revisita (início da manhã, almoço, final da tarde).
                -   **Continuidade:** Mencione qual quarteirão deve ser o foco para continuar o ciclo de trabalho padrão.
                -   **Visão a Longo Prazo:** Adicione uma breve nota sobre como os padrões observados hoje podem influenciar o planejamento para o resto do ciclo.

                Lista de visitas:
                ${JSON.stringify(filledVisits.map(({bairro, logradouro, quarteirao, visita, foco, trat}) => ({bairro, logradouro, quarteirao, visita, foco, trat})), null, 2)}
            `;
            const result = await callAiAPI(prompt);
            let htmlResult = result
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/(\r\n|\n|\r)/g, '<br>')
                .replace(/<br>\s*-\s/g, '<ul><li>')
                .replace(/<br>(\s*<br>\s*)+/g, '</p><p>')
                .replace(/<\/li><br>/g, '</li>');
            if (htmlResult.includes('<li>')) htmlResult += '</ul>';
            aiModalContent.innerHTML = `<p>${htmlResult}</p>`;
        };

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return d.getUTCFullYear() + '-' + weekNo;
        };

        const renderReports = () => {
            const history = JSON.parse(localStorage.getItem('aceFlowHistory')) || [];
            if (history.length === 0) {
                noReportData.classList.remove('hidden');
                chartsContainer.classList.add('hidden');
                reportFooter.classList.add('hidden');
                return;
            }

            const activePeriod = document.querySelector('.btn-filter.bg-blue-600')?.dataset.period;
            const selectedCycle = reportCycleSelector.value;
            const streetQuery = reportStreetSearch.value.toLowerCase();
            
            let filteredHistory = history;

            // Filtro por período (Hoje, Semana, Mês, Ano)
            if (activePeriod) {
                const now = new Date();
                const today = now.toISOString().slice(0, 10);
                const currentWeek = getWeekNumber(now);
                const currentMonth = now.getFullYear() + '-' + now.getMonth();
                const currentYear = now.getFullYear();

                switch(activePeriod) {
                    case 'day':
                        filteredHistory = history.filter(entry => entry.header.data === today);
                        break;
                    case 'week':
                        filteredHistory = history.filter(entry => getWeekNumber(new Date(entry.header.data + 'T12:00:00')) === currentWeek);
                        break;
                    case 'month':
                        filteredHistory = history.filter(entry => {
                            const entryDate = new Date(entry.header.data + 'T12:00:00');
                            return entryDate.getFullYear() + '-' + entryDate.getMonth() === currentMonth;
                        });
                        break;
                    case 'year':
                        filteredHistory = history.filter(entry => new Date(entry.header.data + 'T12:00:00').getFullYear() === currentYear);
                        break;
                }
            }
            
            // Filtro por ciclo
            if (selectedCycle) {
                filteredHistory = filteredHistory.filter(entry => entry.header.ciclo === selectedCycle);
            }
            
            // Filtro por logradouro
            let filteredVisits = [];
            if (streetQuery) {
                 filteredHistory.forEach(day => {
                    day.visits.forEach(visit => {
                        if (visit.logradouro && visit.logradouro.toLowerCase().includes(streetQuery)) {
                            filteredVisits.push(visit);
                        }
                    });
                });
            } else {
                filteredHistory.forEach(day => filteredVisits.push(...day.visits));
            }


            if (filteredVisits.length === 0) {
                noReportData.innerHTML = `<p class="font-bold text-lg">Nenhum dado encontrado para os filtros selecionados.</p>`;
                noReportData.classList.remove('hidden');
                chartsContainer.classList.add('hidden');
                reportFooter.classList.add('hidden');
                return;
            }
            
            noReportData.classList.add('hidden');
            chartsContainer.classList.remove('hidden');
            reportFooter.classList.remove('hidden');

            const summary = filteredVisits.reduce((acc, v) => {
                if (v.visita === 'T' || v.visita === 'P') acc.trabalhado++;
                else if (v.visita === 'F') acc.fechado++;
                else if (v.visita === 'R') acc.recusado++;
                
                if (v.foco) acc.focos++;
                if (v.trat) acc.tratamentoFocal++;
                acc.gramas += parseFloat(v.gram) || 0;
                acc.depositosTratados += parseInt(v.dep) || 0;
                acc.eliminados += parseInt(v.elim) || 0;
                
                if (v.bairro) {
                    acc.bairros[v.bairro] = (acc.bairros[v.bairro] || 0) + 1;
                }
                return acc;
            }, { trabalhado: 0, fechado: 0, recusado: 0, focos: 0, gramas: 0, tratamentoFocal: 0, depositosTratados: 0, eliminados: 0, bairros: {} });
            
            currentReportData = summary;

            // Chart 1: Visitas
            if (visitsChart) visitsChart.destroy();
            const visitsCtx = document.getElementById('visitsChart').getContext('2d');
            visitsChart = new Chart(visitsCtx, {
                type: 'pie',
                data: {
                    labels: ['Trabalhados', 'Fechados', 'Recusados'],
                    datasets: [{
                        data: [summary.trabalhado, summary.fechado, summary.recusado],
                        backgroundColor: ['#2ecc71', '#95a5a6', '#e74c3c'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Chart 2: Produção
            if (productionChart) productionChart.destroy();
            const productionCtx = document.getElementById('productionChart').getContext('2d');
            productionChart = new Chart(productionCtx, {
                type: 'bar',
                data: {
                    labels: ['Focos', 'Trat. Focal', 'Dep. Tratados', 'Eliminados'],
                    datasets: [{
                        label: 'Total',
                        data: [summary.focos, summary.tratamentoFocal, summary.depositosTratados, summary.eliminados],
                        backgroundColor: ['#e74c3c', '#f1c40f', '#3498db', '#2ecc71'],
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });

            // Chart 3: Bairros
            if (bairroChart) bairroChart.destroy();
            const bairroCtx = document.getElementById('bairroChart').getContext('2d');
            bairroChart = new Chart(bairroCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(summary.bairros),
                    datasets: [{
                        label: 'Imóveis Visitados',
                        data: Object.values(summary.bairros),
                        backgroundColor: '#3498db'
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 }}}, plugins: { legend: { display: false } } }
            });
        };
        
        const handleVolumeCalculation = () => {
            const getDimensionInMeters = (valueId, unitId) => {
                const value = parseFloat(document.getElementById(valueId).value);
                const unit = document.getElementById(unitId).value;
                if (isNaN(value) || value <= 0) return NaN;
                return unit === 'cm' ? value / 100 : value;
            };
        
            const largura = getDimensionInMeters('largura', 'larguraUnidade');
            const comprimento = getDimensionInMeters('comprimento', 'comprimentoUnidade');
            const altura = getDimensionInMeters('altura', 'alturaUnidade');
        
            if (isNaN(largura) || isNaN(comprimento) || isNaN(altura)) {
                alert("Por favor, insira valores válidos e positivos para todas as dimensões.");
                return;
            }
            
            const volumeM3 = largura * comprimento * altura;
            const volumeLitros = volumeM3 * 1000;
            
            let gramas;
            if (volumeLitros <= 100) {
                gramas = volumeLitros * 0.008; 
            } else {
                gramas = volumeLitros * 0.0064;
            }
            
            const colheres = gramas / 0.8;
        
            let colheresText;
            if (colheres <= 0.5) {
                colheresText = "Meia colher";
            } else if (colheres <= 1) {
                colheresText = "1 colher";
            } else {
                colheresText = `${colheres.toLocaleString('pt-BR', {maximumFractionDigits: 1})} colheres`;
            }
        
            const waterLevelEl = document.getElementById('waterLevel');
            const volumeTextEl = document.getElementById('volumeText');
            const spoonAmountTextEl = document.getElementById('spoonAmountText');
            const gramsAmountTextEl = document.getElementById('gramsAmountText');
            
            volumeTextEl.textContent = `${volumeLitros.toLocaleString('pt-BR', {maximumFractionDigits: 1})} L`;
            spoonAmountTextEl.textContent = colheresText;
            gramsAmountTextEl.textContent = parseFloat(gramas.toFixed(1)).toLocaleString('pt-BR');
        
            const percentage = Math.min((volumeLitros / 2000) * 100, 100);
            waterLevelEl.style.height = `${percentage}%`;
        
            volumeResultDiv.classList.remove('hidden');
        };
        
        const clearVolumeCalculation = () => {
            larguraInput.value = '';
            comprimentoInput.value = '';
            alturaInput.value = '';
            document.getElementById('larguraUnidade').value = 'm';
            document.getElementById('comprimentoUnidade').value = 'm';
            document.getElementById('alturaUnidade').value = 'm';
            volumeResultDiv.classList.add('hidden');
        };

        const updateSectorData = (dailyData) => {
            const username = document.getElementById('username').value;
            if (!username) return;

            const sectorKey = `aceFlowSectorData_${username}`;
            let sectorData = JSON.parse(localStorage.getItem(sectorKey));

            if (!sectorData) {
                sectorData = { properties: {}, cycleComplete: false };
            }

            if (sectorData.cycleComplete) {
                return;
            }

            let cycleJustCompleted = false;

            for (const visit of dailyData.visits) {
                if (visit.bairro && visit.quarteirao && visit.logradouro && visit.numero) {
                    const propertyId = `${visit.bairro}-${visit.quarteirao}-${visit.logradouro}-${visit.numero}`.toLowerCase();
                    
                    if (sectorData.properties[propertyId]) {
                        cycleJustCompleted = true;
                        break; 
                    } else {
                        sectorData.properties[propertyId] = {
                            bairro: visit.bairro,
                            quarteirao: visit.quarteirao,
                            logradouro: visit.logradouro,
                            numero: visit.numero
                        };
                    }
                }
            }

            if (cycleJustCompleted) {
                sectorData.cycleComplete = true;
                alert('Ciclo de mapeamento da área concluído! Agora você pode visualizar sua área completa no botão "Minha Área".');
            }

            localStorage.setItem(sectorKey, JSON.stringify(sectorData));
        };

        const displayMyArea = () => {
            const username = document.getElementById('username').value;
            const sectorKey = `aceFlowSectorData_${username}`;
            const sectorData = JSON.parse(localStorage.getItem(sectorKey));

            sectorModal.classList.remove('hidden');

            if (!sectorData || !sectorData.cycleComplete) {
                sectorModalContent.innerHTML = `
                    <div class="text-center p-8">
                        <h3 class="font-bold text-xl mb-4">Mapeando sua área...</h3>
                        <p class="text-text-muted">Continue registrando seu trabalho. Após o primeiro dia de um novo ciclo ser registrado, sua área de atuação consolidada aparecerá aqui.</p>
                    </div>
                `;
                return;
            }
            const properties = Object.values(sectorData.properties);
            const totalImoveis = properties.length;
            const dataByBairro = properties.reduce((acc, prop) => {
                const bairro = prop.bairro || "Sem Bairro";
                if (!acc[bairro]) acc[bairro] = [];
                acc[bairro].push(prop);
                return acc;
            }, {});
            let html = `<div class="p-2 space-y-6">`;
            html += `<div class="text-center bg-gray-100 p-4 rounded-lg"><h3 class="text-2xl font-black">Total de Imóveis na Área: ${totalImoveis}</h3></div>`;
            for (const bairro in dataByBairro) {
                const propsInBairro = dataByBairro[bairro];
                const totalInBairro = propsInBairro.length;
                html += `<div class="card p-4"><h4 class="text-xl font-bold border-b pb-2 mb-3">${bairro} (${totalInBairro} imóveis)</h4>`;
                const dataByQuarteirao = propsInBairro.reduce((acc, prop) => {
                    const quarteirao = `Quarteirão ${prop.quarteirao || 'N/A'}`;
                    if(!acc[quarteirao]) acc[quarteirao] = [];
                    acc[quarteirao].push(prop);
                    return acc;
                }, {});
                for(const quarteirao in dataByQuarteirao) {
                    const propsInQuarteirao = dataByQuarteirao[quarteirao].sort((a,b) => a.logradouro.localeCompare(b.logradouro));
                    const totalInQuarteirao = propsInQuarteirao.length;
                    html += `<details class="group mb-2"><summary class="font-semibold text-lg cursor-pointer">${quarteirao} (${totalInQuarteirao} imóveis)</summary>`;
                    const dataByRua = propsInQuarteirao.reduce((acc, prop) => {
                         const rua = prop.logradouro || "Sem Logradouro";
                         if(!acc[rua]) acc[rua] = [];
                         acc[rua].push(prop.numero);
                         return acc;
                    }, {});
                    html += `<div class="pl-4 mt-2 space-y-1">`;
                    for(const rua in dataByRua) {
                        const numeros = dataByRua[rua].sort((a, b) => {
                            const numA = parseInt(a, 10) || a;
                            const numB = parseInt(b, 10) || b;
                            if (typeof numA === 'number' && typeof numB === 'number') return numA - numB;
                            return String(a).localeCompare(String(b));
                        }).join(', ');
                        html += `<p><strong>${rua}:</strong> ${numeros}</p>`;
                    }
                    html += `</div></details>`;
                }
                html += `</div>`;
            }
            html += `</div>`;
            sectorModalContent.innerHTML = html;
        };


        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            loginError.textContent = "";
            if (!user || !pass) { loginError.textContent = "Por favor, preencha usuário e senha."; return; }
            loginBtn.disabled = true; loginBtn.textContent = "Verificando...";
            const authPayload = { action: 'authenticate', usuario: user, senha: pass };
            fetch(SCRIPT_URL, {
                method: 'POST', headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify(authPayload)
            }).then(res => res.json()).then(result => {
                if (result.status === 'success') {
                    loginModal.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    fixedInfoBar.classList.remove('hidden');
                    agenteInput.value = user;
                    agenteInput.classList.add('is-filled');
                    fixedAgentName.textContent = user;
                    loadData(); 
                    updateAndRenderSummary();
                } else { loginError.textContent = result.message || "Usuário ou senha inválidos."; }
            }).catch(error => {
                console.error("Erro de autenticação:", error);
                loginError.textContent = "Erro de conexão. Tente novamente.";
            }).finally(() => {
                loginBtn.disabled = false; loginBtn.textContent = "Entrar";
            });
        });
        
        calculateGoalBtn.addEventListener('click', handleGoalCalculation);
        calculateVolumeBtn.addEventListener('click', handleVolumeCalculation);
        clearVolumeBtn.addEventListener('click', clearVolumeCalculation);
        document.getElementById('addVisitaBtn').addEventListener('click', addVisitaCard);
        document.getElementById('savePdfBtn').addEventListener('click', generatePDF);
        
        document.getElementById('clearDayBtn').addEventListener('click', () => {
            showModal("Tem certeza que deseja limpar os dados do dia? Esta ação irá primeiro salvar os imóveis visitados na sua área de atuação antes de limpar.", () => {
                const dataToProcess = JSON.parse(localStorage.getItem('aceFlowDailyData'));
                if (dataToProcess) {
                    const filledVisits = dataToProcess.visits.filter(v => v.bairro && v.logradouro && v.quarteirao && v.lado && v.numero && v.imovel && v.visita);
                    if (filledVisits.length > 0) {
                       dataToProcess.visits = filledVisits;
                       updateSectorData(dataToProcess);
                    }
                }
                localStorage.removeItem('aceFlowDailyData');
                location.reload();
            });
        });
        
        aiAnalysisBtn.addEventListener('click', handleAiAnalysis);
        aiPlanBtn.addEventListener('click', handleAiPlanning);
        closeAiModalBtn.addEventListener('click', () => aiModal.classList.add('hidden'));
        myAreaBtn.addEventListener('click', displayMyArea);
        closeSectorModalBtn.addEventListener('click', () => sectorModal.classList.add('hidden'));

        document.getElementById('reportBtn').addEventListener('click', () => {
            reportModal.classList.remove('hidden');
            const history = JSON.parse(localStorage.getItem('aceFlowHistory')) || [];
            const cycles = [...new Set(history.map(entry => entry.header.ciclo))];
            reportCycleSelector.innerHTML = '<option value="">Todos os Ciclos</option>' + cycles.map(c => `<option value="${c}">${c}</option>`).join('');
            renderReports();
        });

        closeReportModalBtn.addEventListener('click', () => reportModal.classList.add('hidden'));

        document.querySelectorAll('.btn-filter').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('bg-blue-600'));
                e.target.classList.add('bg-blue-600');
                reportCycleSelector.value = ""; // Reseta o filtro de ciclo ao clicar em um período
                renderReports();
            });
        });

        reportCycleSelector.addEventListener('change', () => {
            document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('bg-blue-600'));
            renderReports();
        });
        reportStreetSearch.addEventListener('input', renderReports);

        exportReportBtn.addEventListener('click', () => {
            if (!currentReportData) {
                alert('Gere um relatório primeiro.');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Indicador,Total\r\n";
            Object.keys(currentReportData).forEach(key => {
                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                if(typeof currentReportData[key] !== 'object') {
                    csvContent += `${label},${currentReportData[key]}\r\n`;
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "relatorio_ace_flow.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        shareReportBtn.addEventListener('click', async () => {
             if (!currentReportData) {
                alert('Gere um relatório primeiro.');
                return;
            }
            let shareText = "Resumo do Relatório ACE FLOW:\n";
            Object.keys(currentReportData).forEach(key => {
                 const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                 if(typeof currentReportData[key] !== 'object') {
                    shareText += `- ${label}: ${currentReportData[key]}\n`;
                 }
            });
            
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Relatório ACE FLOW',
                        text: shareText,
                    });
                } catch (err) {
                    console.error('Erro ao compartilhar:', err);
                }
            } else {
                alert('A função de compartilhamento não é suportada neste navegador. Você pode copiar o texto manualmente.');
            }
        });


        mainContent.addEventListener('input', (e) => {
            const target = e.target;
            
            if (target.matches('.form-input, .form-select')) {
                target.dataset.manualInput = 'true';
            }

            const card = target.closest('.visita-card');
            if (card) {
                updateCardStatus(card);
            }
            if (target.value.trim() || (target.matches('.numero') && target.value === 'S/N')) {
                target.classList.add('is-filled');
            } else {
                target.classList.remove('is-filled');
            }
            updateAndRenderSummary();
            saveData();
        });
        
        mainContent.addEventListener('blur', (e) => {
            const target = e.target;
            if (target.matches('#agente, #bairro, .logradouro, .bairro-imovel') && target.value) {
                target.value = formatAndCorrectText(target.value);
            }
            
            // --- LÓGICA DE REPLICAÇÃO INTELIGENTE APRIMORADA ---
            const replicationClasses = ['.bairro-imovel', '.logradouro', '.quarteirao', '.lado'];
            const targetIsReplicable = replicationClasses.some(c => target.matches(c)) || target.matches('#bairro');

            if (targetIsReplicable) {
                const valueToReplicate = target.value;
                let sourceIndex = -1;
                let fieldClass = '';

                if (target.matches('#bairro')) {
                    fieldClass = '.bairro-imovel';
                    sourceIndex = -1; // Começa a replicar do primeiro card
                } else {
                    const sourceCard = target.closest('.visita-card');
                    sourceIndex = sourceCard ? parseInt(sourceCard.dataset.index, 10) : -1;
                    fieldClass = replicationClasses.find(c => target.matches(c));
                }
                
                if (fieldClass) {
                    const allCards = document.querySelectorAll('.visita-card');
                    allCards.forEach((card, index) => {
                        if (index > sourceIndex) {
                            const fieldToUpdate = card.querySelector(fieldClass);
                            if (fieldToUpdate) {
                                fieldToUpdate.value = valueToReplicate;
                                fieldToUpdate.dataset.manualInput = 'false';
                                if(valueToReplicate) fieldToUpdate.classList.add('is-filled');
                                else fieldToUpdate.classList.remove('is-filled');
                                updateCardStatus(card);
                            }
                        }
                    });
                }
            }

            const card = target.closest('.visita-card');
            if (card) {
                updateCardStatus(card);
            }

            if (target.id === 'agente') updateAutocomplete('agent', target.value);
            if (target.id === 'bairro' || target.classList.contains('bairro-imovel')) updateAutocomplete('bairro', target.value);
            if (target.classList.contains('logradouro')) updateAutocomplete('street', target.value);
            saveData();
        }, true);
        
        visitasContainer.addEventListener('focusin', (e) => {
            const card = e.target.closest('.visita-card');
            if(card) {
                const logradouro = card.querySelector('.logradouro').value || '...';
                const numero = card.querySelector('.numero').value || '...';
                fixedPropertyInfo.textContent = `Imóvel: ${logradouro}, ${numero}`;
            }
        });

        visitasContainer.addEventListener('click', (e) => {
            const header = e.target.closest('.card-header');
            if (header) {
                const content = header.nextElementSibling;
                const isExpanded = header.getAttribute('data-expanded') === 'true';
                header.setAttribute('data-expanded', !isExpanded);
                content.classList.toggle('show');
                saveData();
                return;
            }
            if (e.target.matches('.toggle-check')) {
                e.target.classList.toggle('is-checked');
                updateToggleHTML(e.target);
                updateAndRenderSummary();
                saveData();
            }
        });
        
        modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideModal(); });
        modalCancelBtn.addEventListener('click', hideModal);

        backupBtn.addEventListener('click', () => {
            const username = document.getElementById('username').value || 'agente';
            const dataToBackup = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('aceFlow')) {
                    dataToBackup[key] = localStorage.getItem(key);
                }
            }
            
            const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ace_flow_backup_${username}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('Backup concluído com sucesso!');
        });

        restoreInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    showModal('Tem certeza que deseja restaurar este backup? Todos os dados atuais serão substituídos.', () => {
                        Object.keys(data).forEach(key => {
                            localStorage.setItem(key, data[key]);
                        });
                        alert('Dados restaurados com sucesso! O aplicativo será recarregado.');
                        location.reload();
                    });
                } catch (error) {
                    alert('Arquivo de backup inválido ou corrompido.');
                    console.error("Erro ao restaurar:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Limpa o input para permitir o mesmo arquivo novamente
        });

        // --- LÓGICA DAS CURIOSIDADES ---
        curiositiesBtn.addEventListener('click', () => {
            subButtonsContainer.classList.toggle('hidden');
        });

        const createFaqModal = (modalEl, title, intro, qnaArray) => {
            let qnaHTML = '';
            qnaArray.forEach((item, index) => {
                qnaHTML += `
                    <div class="faq-item border-b border-gray-200">
                        <div class="faq-question flex justify-between items-center p-4 cursor-pointer hover:bg-gray-50">
                            <span class="font-semibold text-gray-800">${index + 1}. ${item.q}</span>
                            <span class="faq-toggle-icon text-2xl text-gray-400 transition-transform duration-300">+</span>
                        </div>
                        <div class="faq-answer text-gray-600 leading-relaxed">
                           ${item.a}
                        </div>
                    </div>
                `;
            });

            modalEl.innerHTML = `
                <div class="card p-0 w-11/12 max-w-4xl max-h-[90vh] flex flex-col">
                    <header class="sticky top-0 bg-white/80 backdrop-blur-sm z-10 flex justify-between items-center border-b p-4">
                        <h2 class="section-title">${title}</h2>
                        <button class="close-faq-modal text-3xl font-bold">&times;</button>
                    </header>
                    <div class="flex-grow overflow-y-auto p-6">
                        <p class="mb-6 text-text-muted">${intro}</p>
                        <h3 class="text-xl font-bold mb-4 text-center">Tire suas Dúvidas: O Guia Definitivo sobre Dengue e Aedes aegypti</h3>
                        <div class="bg-white rounded-lg shadow-inner">
                           ${qnaHTML}
                        </div>
                    </div>
                </div>
            `;
            modalEl.classList.remove('hidden');
        };

        document.body.addEventListener('click', (e) => {
            if (e.target.matches('.close-faq-modal')) {
                e.target.closest('.modal').classList.add('hidden');
            }
            const question = e.target.closest('.faq-question');
            if (question) {
                const answer = question.nextElementSibling;
                question.classList.toggle('active');
                answer.classList.toggle('show');
            }
        });

        showDengueModalBtn.addEventListener('click', () => {
            const dengueQNA = [
                {q: "Quais são os sintomas clássicos da dengue?", a: "Os sintomas mais comuns são febre alta (acima de 38°C) de início súbito, dor de cabeça forte, dor atrás dos olhos, dores intensas no corpo e nas articulações, além de fraqueza e cansaço. Manchas vermelhas na pele também podem aparecer."},
                {q: "Como é a principal forma de prevenção?", a: "A melhor e mais eficaz forma de prevenção é a eliminação dos criadouros do mosquito. Isso significa não deixar água parada em nenhum tipo de recipiente, como vasos de plantas, pneus velhos, garrafas, caixas d'água destampadas e calhas sujas. A regra é clara: não deu água para o mosquito, ele não se cria."},
                {q: "Qual é o tratamento para a dengue?", a: "Não existe um medicamento específico para tratar o vírus da dengue. O tratamento consiste em aliviar os sintomas. É fundamental manter-se em repouso, beber muito líquido (água, sucos, soro de reidratação oral) para evitar a desidratação e usar apenas medicamentos indicados por um profissional de saúde para febre e dor, como paracetamol ou dipirona."},
                {q: "Quais são os sinais de alerta para a dengue grave?", a: "Após o período de febre, geralmente entre o 3º e o 7º dia, é crucial ficar atento a sinais como dor abdominal intensa e contínua, vômitos persistentes, sangramento de mucosas (nariz, gengiva), sonolência, irritabilidade, tontura ao se levantar e acúmulo de líquidos. A presença de um ou mais desses sintomas indica a necessidade de procurar atendimento médico de urgência."},
                {q: "Posso tomar qualquer remédio para dor e febre?", a: "Não! Em caso de suspeita de dengue, é terminantemente proibido o uso de medicamentos à base de ácido acetilsalicílico (AAS), como a Aspirina, e outros anti-inflamatórios não esteroides (como ibuprofeno e nimesulida). Esses medicamentos podem aumentar o risco de hemorragias e agravar a doença."},
                {q: "Posso pegar dengue mais de uma vez?", a: "Sim. Existem quatro sorotipos do vírus (DENV-1, 2, 3 e 4). A infecção por um deles gera imunidade permanente apenas para aquele sorotipo. Portanto, uma pessoa pode ter dengue até quatro vezes."},
                {q: "A dengue é contagiosa?", a: "Não diretamente. Uma pessoa não transmite a doença para outra. A dengue só é transmitida pela picada da fêmea do mosquito Aedes aegypti que tenha se infectado ao picar alguém com o vírus."},
                {q: "Existe vacina contra a dengue?", a: "Sim. Existe vacina contra a dengue, que está sendo progressivamente implementada no sistema público de saúde para públicos específicos e também está disponível na rede privada. Ela é uma ferramenta importante, mas não elimina a necessidade de combater o mosquito."},
                {q: "É possível estar com dengue e não ter sintomas?", a: "Sim. Muitas infecções são assintomáticas. A pessoa não sente nada, mas se um mosquito a picar nesse período, ele se contamina e passa a transmitir o vírus para outras pessoas."},
                {q: "A dengue pode deixar sequelas?", a: "Sim. Embora a maioria se recupere bem, algumas pessoas podem sentir cansaço intenso, dores nas articulações e fraqueza muscular por semanas ou até meses após a infecção, condição conhecida como fadiga pós-dengue."},
                {q: "Por que a dengue é mais comum no verão?", a: "A combinação de calor e chuvas frequentes cria o ambiente ideal para a proliferação do Aedes aegypti. As temperaturas mais altas aceleram o ciclo de vida do mosquito, fazendo com que mais mosquitos nasçam e piquem em menos tempo."},
                {q: "A doença é mais perigosa em crianças e idosos?", a: "Sim. Crianças, idosos e pessoas com doenças crônicas (como diabetes e hipertensão) têm maior risco de desenvolver as formas graves da doença e apresentar complicações."},
                {q: "O vírus da dengue pode ser transmitido pela amamentação?", a: "Não há evidências de que o vírus da dengue seja transmitido através do leite materno. A amamentação é segura e deve ser mantida, pois os benefícios superam os riscos."},
                {q: "Qual a diferença entre Dengue, Zika e Chikungunya?", a: "Embora transmitidas pelo mesmo mosquito e com sintomas iniciais parecidos (febre, dor de cabeça), a principal característica da Chikungunya são as dores articulares extremamente intensas, enquanto a Zika costuma ter um quadro mais leve, com manchas na pele e coceira mais proeminentes. Apenas um médico pode fazer o diagnóstico correto."},
                {q: "O que significa o termo 'dengue hemorrágica'?", a: "Este termo caiu em desuso. A classificação atual divide a doença em 'Dengue' (com ou sem sinais de alarme) e 'Dengue Grave'. A forma grave é caracterizada por extravasamento de plasma, sangramentos severos ou comprometimento grave de órgãos."}
            ];
            createFaqModal(dengueModal, '🦟 Sobre a Dengue: O que Você Precisa Saber', "Entender a dengue é o primeiro passo para se proteger e cuidar da sua família. A doença pode evoluir de um quadro leve para uma condição grave, exigindo atenção redobrada.", dengueQNA);
        });

        showAedesModalBtn.addEventListener('click', () => {
             const aedesQNA = [
                {q: "Como identificar o Aedes aegypti?", a: "Ele é um mosquito pequeno (menor que um pernilongo comum), de cor preta ou marrom-escura, com listras e manchas brancas distintas no corpo e, principalmente, nas pernas. Sua atividade é maior durante o dia."},
                {q: "Onde o mosquito coloca seus ovos?", a: "A fêmea deposita seus ovos nas paredes de recipientes com água parada, bem próximos à superfície da água. Ela prefere água relativamente limpa, mas pode se adaptar. Qualquer objeto que acumule água pode virar um criadouro."},
                {q: "Quanto tempo leva para o ovo virar um mosquito adulto?", a: "Em condições favoráveis (calor e umidade), o ciclo completo, do ovo ao mosquito adulto, leva em média de 7 a 10 dias. Por isso a importância da vistoria semanal dos quintais."},
                {q: "O 'fumacê' acaba com o problema da dengue?", a: "Não. O 'fumacê' (aplicação de inseticida a ultrabaixo volume) mata apenas os mosquitos adultos que estão voando no momento da aplicação. Ele não tem efeito sobre os ovos e as larvas que estão na água. A única solução definitiva é eliminar os criadouros."},
                {q: "Qual a distância que o Aedes aegypti voa?", a: "Seu raio de voo é curto, geralmente entre 50 a 100 metros do local onde nasceu. Isso significa que, na grande maioria das vezes, o mosquito que pica dentro de uma casa nasceu no próprio quintal ou na vizinhança imediata."},
                {q: "Por que só a fêmea pica?", a: "Apenas a fêmea se alimenta de sangue, pois ele contém as proteínas necessárias para o desenvolvimento e amadurecimento dos seus ovos. Os machos se alimentam exclusivamente de seiva de plantas."},
                {q: "Os ovos do mosquito são resistentes?", a: "Extremamente. Os ovos podem sobreviver por mais de um ano em um local seco. Assim que entram em contato com a água novamente, eles podem eclodir e dar início a um novo ciclo."},
                {q: "O que atrai o mosquito até uma pessoa?", a: "O Aedes aegypti é atraído principalmente pelo gás carbônico (CO₂) que liberamos na respiração e por odores corporais, como o ácido lático liberado no suor. Ele também é atraído pelo calor do corpo."},
                {q: "Roupas escuras realmente atraem mais o mosquito?", a: "Sim. O mosquito se orienta pela visão e contraste. Cores escuras e vibrantes, como preto e vermelho, se destacam mais no ambiente e atraem sua atenção, ao contrário de cores claras, como branco e bege."},
                {q: "O Aedes aegypti pica por cima da roupa?", a: "Sim. Se o tecido da roupa for fino e justo ao corpo, como leggings e camisetas de algodão fino, o aparelho picador do mosquito pode atravessá-lo e alcançar a pele."},
                {q: "Velas de citronela e outras plantas resolvem?", a: "Plantas e velas de citronela ou andiroba têm um efeito repelente muito limitado, restrito a uma área pequena e por pouco tempo. Elas não são eficazes para proteger um ambiente inteiro e não substituem a necessidade de eliminar os criadouros."},
                {q: "O mosquito prefere picar em que parte do corpo?", a: "Ele tem o hábito de picar baixo, geralmente nas pernas, tornozelos e pés, pois voa a uma baixa altura."},
                {q: "Quantos ovos uma fêmea pode colocar?", a: "Durante sua vida (que dura cerca de 30 a 45 dias), uma única fêmea pode colocar mais de 200 ovos, distribuindo-os por vários criadouros diferentes."},
                {q: "O Aedes aegypti também vive dentro de casa?", a: "Sim, ele é um mosquito doméstico e peridoméstico. Ele se abriga dentro de casa, em locais escuros e frescos, como atrás de móveis, cortinas e armários, para se proteger do calor intenso e descansar."},
                {q: "Além da dengue, o que mais ele transmite?", a: "Este mesmo mosquito é o vetor responsável pela transmissão do Zika Vírus, da Febre Chikungunya e da Febre Amarela urbana."}
            ];
            createFaqModal(aedesModal, '🦟 Sobre o Vetor, Aedes aegypti: Conheça o Inimigo', "Este pequeno mosquito é um grande problema de saúde pública. Conhecer seus hábitos e ciclo de vida é a chave para um combate eficiente.", aedesQNA);
        });


        const initApp = () => {
             // Animação da Landing Page
            const sections = document.querySelectorAll('.fade-in-section');
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                    }
                });
            }, { threshold: 0.1 });
            sections.forEach(section => observer.observe(section));

            agentList = JSON.parse(localStorage.getItem('aceFlowagentList')) || [];
            bairroList = JSON.parse(localStorage.getItem('aceFlowbairroList')) || [];
            streetList = JSON.parse(localStorage.getItem('aceFlowstreetList')) || [];
            agentSuggestions.innerHTML = agentList.map(item => `<option value="${item}"></option>`).join('');
            bairroSuggestions.innerHTML = bairroList.map(item => `<option value="${item}"></option>`).join('');
            streetSuggestions.innerHTML = streetList.map(item => `<option value="${item}"></option>`).join('');
            populateSelects();
            dataInput.value = new Date().toISOString().slice(0, 10);
            dataInput.classList.add('is-filled');
            loadGoalData();
        };
        
        initApp();
    });
    </script>
</body>
</html>
